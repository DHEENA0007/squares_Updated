import{t,c as e,d as a,f as o,a as n,g as i,e as r,h as s,i as c}from"./en-US-Blz_tpgH.js";import{r as u}from"./router-Bi51YGN-.js";import{u as f,aU as d,t as l,z as h}from"./index-DbnZmv1f.js";function m(e,a){const o=t(e),n=t(a),i=o.getTime()-n.getTime();return i<0?-1:i>0?1:i}function w(e){const o=t(e);return+function(e){const a=t(e);return a.setHours(23,59,59,999),a}(o)===+a(o)}function p(e,a,o){const n=function(e,a){return+t(e)-+t(a)}(e,a)/1e3;return(i=o?.roundingMethod,t=>{const e=(i?Math[i]:Math.trunc)(t);return 0===e?0:e})(n);var i}function y(e,a,u){const f=i(),d=u?.locale??f.locale??r,l=m(e,a);if(isNaN(l))throw new RangeError("Invalid time value");const h=Object.assign({},u,{addSuffix:u?.addSuffix,comparison:l});let y,T;l>0?(y=t(a),T=t(e)):(y=t(e),T=t(a));const N=p(T,y),S=(n(T)-n(y))/1e3,v=Math.round((N-S)/60);let g;if(v<2)return u?.includeSeconds?N<5?d.formatDistance("lessThanXSeconds",5,h):N<10?d.formatDistance("lessThanXSeconds",10,h):N<20?d.formatDistance("lessThanXSeconds",20,h):N<40?d.formatDistance("halfAMinute",0,h):N<60?d.formatDistance("lessThanXMinutes",1,h):d.formatDistance("xMinutes",1,h):0===v?d.formatDistance("lessThanXMinutes",1,h):d.formatDistance("xMinutes",v,h);if(v<45)return d.formatDistance("xMinutes",v,h);if(v<90)return d.formatDistance("aboutXHours",1,h);if(v<s){const t=Math.round(v/60);return d.formatDistance("aboutXHours",t,h)}if(v<2520)return d.formatDistance("xDays",1,h);if(v<c){const t=Math.round(v/s);return d.formatDistance("xDays",t,h)}if(v<2*c)return g=Math.round(v/c),d.formatDistance("aboutXMonths",g,h);if(g=function(e,a){const n=t(e),i=t(a),r=m(n,i),s=Math.abs(o(n,i));let c;if(s<1)c=0;else{1===n.getMonth()&&n.getDate()>27&&n.setDate(30),n.setMonth(n.getMonth()-r*s);let a=m(n,i)===-r;w(t(e))&&1===s&&1===m(e,i)&&(a=!1),c=r*(s-Number(a))}return 0===c?0:c}(T,y),g<12){const t=Math.round(v/c);return d.formatDistance("xMonths",t,h)}{const t=g%12,e=Math.trunc(g/12);return t<3?d.formatDistance("aboutXYears",e,h):t<9?d.formatDistance("overXYears",e,h):d.formatDistance("almostXYears",e+1,h)}}function T(t,a){return y(t,function(t){return e(t,Date.now())}(t),a)}const N=()=>{const[t,e]=u.useState(!1),[a,o]=u.useState([]),[n,i]=u.useState(null),r=u.useRef(new Set),{user:s}=f(),c=u.useCallback(t=>{const e=`${t.type}-${t.timestamp}-${t.userId}`;if(!r.current.has(e)){if(r.current.add(e),r.current.size>100){const t=Array.from(r.current)[0];r.current.delete(t)}p(t),o(e=>[t,...e].slice(0,20))}},[s]),m=u.useCallback(async()=>{if(s)try{await d.connect();e(!0),d.on("notification",c)}catch(t){e(!1)}},[s,c]),w=u.useCallback(()=>{d.off("notification",c),e(!1)},[c]),p=t=>{const e=y(t);if(e.showToast&&l({title:t.title,description:t.message,variant:e.variant,duration:e.duration}),e.playSound){!1!==s?.profile?.preferences?.notifications?.sound&&T()}e.showBrowserNotification&&"granted"===Notification.permission&&new Notification(t.title,{body:t.message,icon:"/favicon.png",tag:t.type})},y=t=>{const e={property_alert:{showToast:!0,variant:"default",duration:5e3,playSound:!0,showBrowserNotification:!0},price_alert:{showToast:!0,variant:"default",duration:6e3,playSound:!0,showBrowserNotification:!0},new_message:{showToast:!0,variant:"default",duration:4e3,playSound:!0,showBrowserNotification:!0},service_update:{showToast:!0,variant:"default",duration:5e3,playSound:!1,showBrowserNotification:!0},property_update:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!1},broadcast:{showToast:!0,variant:"default",duration:8e3,playSound:!1,showBrowserNotification:!0},announcement:{showToast:!0,variant:"default",duration:8e3,playSound:!1,showBrowserNotification:!0},lead_alert:{showToast:!0,variant:"default",duration:6e3,playSound:!0,showBrowserNotification:!0},inquiry_received:{showToast:!0,variant:"default",duration:5e3,playSound:!0,showBrowserNotification:!0},weekly_report:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!0},business_update:{showToast:!0,variant:"default",duration:5e3,playSound:!1,showBrowserNotification:!0},default:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!1}};return e[t.type]||e.default},T=()=>{try{const t=new Audio("/mixkit-software-interface-start-2574.wav");t.volume=.6,t.play().catch(t=>{try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),a=t.createGain();e.connect(a),a.connect(t.destination),e.frequency.value=800,e.type="sine",a.gain.setValueAtTime(.3,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),e.start(t.currentTime),e.stop(t.currentTime+.5)}catch(e){}})}catch(t){}};return u.useEffect(()=>(s&&m(),()=>{w()}),[s,m,w]),u.useEffect(()=>()=>{w()},[w]),{isConnected:t,notifications:a,stats:n,connect:m,disconnect:w,sendTestNotification:async()=>{const t=h.getToken();if(t)try{const e="https://api.buildhomemartsquares.com/api";if(!(await fetch(`${e}/notifications/test`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include",body:JSON.stringify({type:"test",message:"This is a test notification from the real-time system!"})})).ok)throw new Error("Failed to send test notification")}catch(e){l({title:"Error",description:"Failed to send test notification",variant:"destructive"})}},getNotificationStats:async()=>{const t=h.getToken();if(t)try{const e="https://api.buildhomemartsquares.com/api",a=await fetch(`${e}/notifications/stats`,{method:"GET",headers:{Authorization:`Bearer ${t}`},credentials:"include"});if(!a.ok)throw new Error("Failed to fetch notification stats");const o=await a.json();return i(o.data),o.data}catch(e){return null}},clearNotifications:()=>{o([]),r.current.clear()},markAsRead:t=>{o(e=>e.map(e=>e.timestamp===t?{...e,read:!0}:e))},requestNotificationPermission:async()=>{if("Notification"in window&&"default"===Notification.permission){return"granted"===await Notification.requestPermission()}return"granted"===Notification.permission}}};export{T as f,N as u};
