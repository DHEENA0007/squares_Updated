import{j as e}from"./ui-s1SEoZIF.js";import{r as s}from"./router-D8v2YSKU.js";import{H as t,t as a,aY as n,u as i,aZ as r,aF as l,B as c,s as o,v as d,w as m,x,y as u,a as h,b as p,c as f,a2 as g,I as v,e as j,a_ as y,J as N,ao as w,ap as b,aq as C,as as k,at as S,f as M,au as A,ax as T,af as R,G as _,P as I,j as P,A as U,l as z,i as D,X as E,T as F}from"./index-l5vY_naC.js";import{m as O}from"./messageService-D-QRLHbg.js";import{u as L}from"./use-mobile-C5fBmhy-.js";import{E as Y}from"./ellipsis-vertical-zQsNyMDt.js";import{A as B,C as $}from"./check-check-DKOCx-te.js";import{P as q}from"./paperclip-niliBIJR.js";import{S as H}from"./send-HGDbc4gv.js";const K=t("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);const V=new class{config=null;initialize(e){this.config=e}async getConversations(e={}){if(!this.config)throw new Error("UnifiedMessageService not initialized");const s=this.getRoleSpecificFilters(e);return await O.getConversations(s)}async getConversationMessages(e,s=1,t=50,a=!0){const n=await O.getConversationMessages(e,s,t,a);return n.messages=n.messages.map(e=>O.normalizeMessage(e)),n}async sendMessage(e,s,t,a){const n=await O.sendMessage(e,s,t,a);return O.normalizeMessage(n)}async uploadAttachment(e){return await O.uploadAttachment(e)}async markMessageAsRead(e){await O.markMessageAsRead(e)}async markConversationAsRead(e){await O.markConversationAsRead(e)}async deleteMessage(e){if(!this.canDeleteMessages())throw a({title:"Permission Denied",description:"You do not have permission to delete messages",variant:"destructive"}),new Error("Permission denied");await O.deleteMessage(e)}async deleteConversation(e){if(!this.canDeleteConversations())throw a({title:"Permission Denied",description:"You do not have permission to delete conversations",variant:"destructive"}),new Error("Permission denied");await O.deleteConversation(e)}async updateConversationStatus(e,s){await O.updateConversationStatus(e,s)}async getUserStatus(e){return await O.getUserStatus(e)}async getUnreadCount(){return await O.getUnreadCount()}joinConversation(e){n.joinConversation(e)}leaveConversation(e){n.leaveConversation(e)}startTyping(e){n.startTyping(e)}stopTyping(e){n.stopTyping(e)}markMessageAsReadSocket(e,s){n.markMessageAsRead(e,s)}markConversationAsReadSocket(e){n.markConversationAsRead(e)}updateOnlineStatus(e){n.updateOnlineStatus(e)}formatTime(e){return O.formatTime(e)}getMessageContent(e){return O.getMessageContent(e)}isAutoResponse(e){return O.isAutoResponse(e)}formatPrice(e,s){return O.formatPrice(e,s)}getPriorityColor(e){return O.getPriorityColor(e)}getStatusColor(e){return O.getStatusColor(e)}canDeleteMessages(){return!!this.config&&["admin","subadmin","customer","vendor"].includes(this.config.role)}canDeleteConversations(){return!!this.config&&["admin","subadmin","customer","vendor"].includes(this.config.role)}canAccessAdminFeatures(){return!!this.config&&["admin","subadmin"].includes(this.config.role)}getRoleSpecificFilters(e){if(!this.config)return e;const s={...e};return this.config.role,s}getConversationListTitle(){if(!this.config)return"Conversations";switch(this.config.role){case"admin":case"subadmin":return"All Conversations";case"vendor":return"Property Inquiries";case"customer":return"My Messages";default:return"Conversations"}}isSocketConnected(){return n.isConnected()}},G=({role:t,pageTitle:n,pageDescription:O,showPropertyInfo:G=!0,enableDeletion:J=!0})=>{const{user:W}=i(),Z=L(),[Q,X]=s.useState(null),[ee,se]=s.useState(""),[te,ae]=s.useState(""),[ne,ie]=s.useState([]),[re,le]=s.useState([]),[ce,oe]=s.useState(!0),[de,me]=s.useState(!1),[xe,ue]=s.useState("all"),[he,pe]=s.useState([]),[fe,ge]=s.useState(!1),[ve,je]=s.useState(!1),[ye,Ne]=s.useState({}),[we,be]=s.useState(!0),[Ce,ke]=s.useState(0),Se=s.useRef(null),Me=s.useRef(null),Ae=s.useRef(null);s.useEffect(()=>{W?.id&&V.initialize({role:t,userId:W.id})},[t,W]),r({refreshConversations:()=>{Te()},onNewMessage:e=>{e.conversationId===Q&&Re(Q),Te()},onMessageRead:e=>{e.conversationId===Q&&le(s=>s.map(s=>s._id===e.messageId?{...s,read:!0,isRead:!0}:s)),Te()},onConversationRead:e=>{e.conversationId===Q&&le(e=>e.map(e=>({...e,read:!0,isRead:!0}))),Te()},onTypingIndicator:e=>{e.conversationId===Q&&e.userId!==W?.id&&je(e.isTyping)},onUserStatusChange:e=>{Ne(s=>({...s,[e.userId]:{userId:e.userId,isOnline:e.isOnline,lastSeen:e.lastSeen}}))}});const Te=async()=>{try{oe(!0);const e=await V.getConversations({status:"all"!==xe?xe:void 0,search:te.trim()||void 0,limit:50});ie(e.conversations);const s=e.conversations.reduce((e,s)=>e+(s.unreadCount||0),0);ke(s)}catch(e){a({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{oe(!1)}},Re=async e=>{try{le([]);const s=await V.getConversationMessages(e,1,50,!0);s&&(le(s.messages),V.markConversationAsReadSocket(e),Te())}catch(s){}};s.useEffect(()=>{Te()},[xe]),s.useEffect(()=>(Q?(Re(Q),V.joinConversation(Q),Z&&be(!1)):le([]),()=>{Q&&(V.leaveConversation(Q),V.stopTyping(Q))}),[Q,Z]),s.useEffect(()=>{ne.length>0&&(async()=>{const e={};for(const t of ne)try{const s=await V.getUserStatus(t.otherUser._id);e[t.otherUser._id]=s}catch(s){}Ne(e)})()},[ne]);const _e=ne.find(e=>(e.id||e._id)===Q),Ie=async()=>{if((ee.trim()||0!==he.length)&&Q&&_e)try{me(!0);const s=[];if(he.length>0){ge(!0);for(const t of he)try{const e=await V.uploadAttachment(t);s.push(e)}catch(e){}ge(!1)}const t=ee.trim()||(s.length>0?"[Attachment]":""),a=await V.sendMessage(Q,t,_e.otherUser._id,s);le(e=>[...e,a]),se(""),pe([]),Te()}catch(e){}finally{me(!1)}};s.useEffect(()=>{if(Q)return ee.trim()?(V.startTyping(Q),Ae.current&&clearTimeout(Ae.current),Ae.current=setTimeout(()=>{V.stopTyping(Q)},2e3)):V.stopTyping(Q),()=>{Ae.current&&clearTimeout(Ae.current)}},[ee,Q]);const Pe=(e,s)=>{const t=e.target.files;if(!t)return;const n=Array.from(t),i=[];for(const r of n)if(r.size>10485760)a({title:"File too large",description:`${r.name} exceeds 10MB limit`,variant:"destructive"});else{if("image"===s){if(!r.type.startsWith("image/")){a({title:"Invalid file type",description:`${r.name} is not an image`,variant:"destructive"});continue}}else{if(!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(r.type)){a({title:"Invalid file type",description:`${r.name} is not a supported document type`,variant:"destructive"});continue}}i.push(r)}pe(e=>[...e,...i]),e.target&&(e.target.value="")},Ue=e=>e.otherUser||{_id:"",name:"Unknown User",email:""};s.useEffect(()=>{const e=setTimeout(()=>{""!==te&&Te()},500);return()=>clearTimeout(e)},[te]);const ze=ne;return e.jsxs("div",{className:"flex flex-col h-screen pt-16",children:[e.jsx("div",{className:"flex-shrink-0 px-6 py-4 border-b bg-background",children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(l,{className:"w-8 h-8 text-primary"}),n||V.getConversationListTitle(),Ce>0&&e.jsxs(c,{className:"bg-red-500 text-white text-sm px-2 py-1 ml-2",children:[Ce," unread"]})]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:O||"Communicate with property agents and owners"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(o,{value:xe,onValueChange:ue,children:[e.jsx(d,{className:"w-[180px]",children:e.jsx(m,{placeholder:"Filter by status"})}),e.jsxs(x,{children:[e.jsx(u,{value:"all",children:"All Messages"}),e.jsx(u,{value:"unread",children:"Unread"}),e.jsx(u,{value:"read",children:"Read"}),e.jsx(u,{value:"archived",children:"Archived"})]})]})})]})}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsxs(h,{className:"flex flex-col "+(Z?we?"flex":"hidden":"w-1/3 border-r"),children:[e.jsxs(p,{className:"flex-shrink-0 pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{className:"text-lg",children:"Conversations"}),e.jsx(c,{variant:"secondary",children:ne.length})]}),e.jsxs("div",{className:"relative",children:[e.jsx(g,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(v,{type:"text",placeholder:"Search conversations...",className:"pl-10",value:te,onChange:e=>ae(e.target.value)})]})]}),e.jsx(j,{className:"flex-1 p-0 overflow-hidden",children:e.jsx(y,{className:"h-full",children:e.jsx("div",{className:"space-y-1 p-3",children:ce?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(N,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):0===ze.length?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(l,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Start by sending a message to a property"})]}):ze.map(s=>{const t=Ue(s),n=t.name||"Unknown User",i=s.id||s._id||"";return e.jsx("div",{className:"group p-3 rounded-lg cursor-pointer transition-colors "+(Q===i?"bg-primary/10 border border-primary/20":"hover:bg-muted/50"),onClick:()=>X(i),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"relative",children:e.jsxs(w,{className:"w-12 h-12",children:[e.jsx(b,{src:void 0}),e.jsx(C,{children:n.split(" ").map(e=>e[0]).join("")})]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-sm truncate",children:n}),ye[t._id]?.isOnline?e.jsx("span",{className:"text-[10px] text-green-600 font-medium",children:"● Online"}):ye[t._id]?.lastSeen?e.jsxs("span",{className:"text-[9px] text-muted-foreground",children:["Last seen ",V.formatTime(ye[t._id].lastSeen)]}):null]}),e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:V.formatTime(s.lastMessage.createdAt)})]}),G&&s.property&&e.jsx("p",{className:"text-xs text-primary font-medium mb-1 truncate",children:s.property.title}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.lastMessage.message}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[s.unreadCount>0&&e.jsx(c,{className:"bg-primary text-white text-xs px-2 py-1",children:s.unreadCount}),J&&e.jsxs(k,{children:[e.jsx(S,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:e=>e.stopPropagation(),children:e.jsx(Y,{className:"w-3 h-3"})})}),e.jsxs(A,{align:"end",children:[e.jsxs(T,{onClick:e=>{e.stopPropagation(),(async(e,s)=>{try{await V.updateConversationStatus(e,s?"unread":"archived"),Q===e&&(X(null),le([]),Z&&be(!0)),ie(s=>s.filter(s=>(s.id||s._id)!==e)),a({title:"Success",description:s?"Conversation unarchived successfully!":"Conversation archived successfully!"}),setTimeout(()=>Te(),100)}catch(t){a({title:"Error",description:"Failed to update conversation status",variant:"destructive"}),Te()}})(i,"archived"===s.status)},children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"archived"===s.status?"Unarchive":"Archive"]}),e.jsxs(T,{className:"text-red-600 focus:text-red-600",onClick:e=>{e.stopPropagation(),(async e=>{if(J&&window.confirm("Are you sure you want to delete this conversation? This action cannot be undone."))try{await V.deleteConversation(e),ie(s=>s.filter(s=>(s.id||s._id)!==e)),Q===e&&(X(null),le([])),a({title:"Success",description:"Conversation deleted successfully!"})}catch(s){}})(i)},children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]})]})},i)})})})})]}),e.jsx(h,{className:"flex flex-col "+(Z?we?"hidden":"flex":"flex-1"),children:_e?e.jsxs(e.Fragment,{children:[e.jsxs(p,{className:"flex-shrink-0 pb-3 border-b",children:[Z&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>be(!0),className:"p-2",children:e.jsx(_,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-sm font-medium",children:"Back to Conversations"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"relative",children:e.jsxs(w,{className:"w-10 h-10",children:[e.jsx(b,{src:void 0}),e.jsx(C,{children:Ue(_e).name.split(" ").map(e=>e[0]).join("")})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:Ue(_e).name}),ye[Ue(_e)._id]?.isOnline&&e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"● Active now"})]}),G&&_e.property&&e.jsx("p",{className:"text-sm text-muted-foreground",children:_e.property.title})]})]}),e.jsx("div",{className:"flex gap-2",children:Ue(_e).phone&&e.jsxs(I,{children:[e.jsx(P,{asChild:!0,children:e.jsx(M,{size:"sm",variant:"outline",title:"View phone number",children:e.jsx(U,{className:"w-4 h-4"})})}),e.jsx(z,{className:"w-auto p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Phone Number"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-lg font-semibold",children:Ue(_e).phone}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>{navigator.clipboard.writeText(Ue(_e).phone||""),a({title:"Copied!",description:"Phone number copied to clipboard"})},children:"Copy"})]})]})})]})})]})]}),G&&_e.property&&e.jsx("div",{className:"flex-shrink-0 px-6 py-3 bg-muted/30 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:_e.property.title})]}),e.jsxs("span",{className:"text-sm font-semibold text-primary",children:["₹",_e.property.price.toLocaleString("en-IN")]})]})}),e.jsx(j,{className:"flex-1 p-0 overflow-hidden",children:e.jsx(y,{className:"h-full p-4",children:e.jsxs("div",{className:"space-y-4",children:[re.map(s=>{const t="string"==typeof s.sender?s.sender:s.sender._id,n=W?.id===t;return e.jsx("div",{className:`group flex ${n?"justify-end":"justify-start"} hover:bg-muted/30 rounded-lg p-1 transition-colors`,children:e.jsxs("div",{className:"max-w-[70%] p-3 rounded-lg "+(n?"bg-primary text-primary-foreground":"bg-muted"),children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:V.getMessageContent(s)}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:s.attachments.map((s,t)=>e.jsx("div",{children:"image"===s.type?e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:s.url,alt:s.name,className:"max-w-full rounded border border-border cursor-pointer hover:opacity-90",style:{maxHeight:"200px"}})}):e.jsxs("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 rounded border "+(n?"border-primary-foreground/20 hover:bg-primary-foreground/10":"border-border bg-background hover:bg-muted"),children:[e.jsx(q,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm truncate",children:s.name})]})},t))}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs opacity-70",children:V.formatTime(s.createdAt||s.timestamp)}),n&&e.jsx(c,{variant:"outline",className:"text-xs px-1 py-0",children:"You"})]}),e.jsx("div",{className:"flex items-center gap-1",children:n&&e.jsxs(e.Fragment,{children:[s.read?e.jsx($,{className:"w-3 h-3 text-blue-500"}):e.jsx($,{className:"w-3 h-3 text-gray-400"}),J&&e.jsxs(k,{children:[e.jsx(S,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-50 group-hover:opacity-100 transition-opacity hover:bg-destructive/10",title:"Message options",children:e.jsx(Y,{className:"w-3 h-3"})})}),e.jsx(A,{align:"end",children:e.jsxs(T,{className:"text-red-600 focus:text-red-600",onClick:()=>(async e=>{if(J&&window.confirm("Are you sure you want to delete this message? This action cannot be undone."))try{await V.deleteMessage(e),le(s=>s.filter(s=>s._id!==e)),a({title:"Success",description:"Message deleted successfully!"})}catch(s){}})(s._id),children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"Delete Message"]})})]})]})})]})]})},s._id)}),ve&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-muted p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:[Ue(_e).name," is typing..."]})]})})})]})})}),e.jsxs("div",{className:"flex-shrink-0 p-4 border-t",children:[he.length>0&&e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:he.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2 bg-muted px-3 py-2 rounded-lg",children:[e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name}),e.jsx(M,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>(e=>{pe(s=>s.filter((s,t)=>t!==e))})(t),children:e.jsx(E,{className:"w-3 h-3"})})]},t))}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("input",{ref:Se,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:e=>Pe(e,"document"),multiple:!0}),e.jsx("input",{ref:Me,type:"file",className:"hidden",accept:"image/*",onChange:e=>Pe(e,"image"),multiple:!0}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(M,{size:"sm",variant:"outline",onClick:()=>Se.current?.click(),disabled:fe||de,title:"Attach document",children:e.jsx(q,{className:"w-4 h-4"})}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>Me.current?.click(),disabled:fe||de,title:"Attach image",children:e.jsx(K,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1",children:e.jsx(F,{placeholder:"Type your message...",value:ee,onChange:e=>se(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Ie())},className:"min-h-[40px] resize-none",disabled:de||fe})}),e.jsx(M,{onClick:Ie,disabled:!ee.trim()&&0===he.length||de||fe,children:de||fe?e.jsx(N,{className:"w-4 h-4 animate-spin"}):e.jsx(H,{className:"w-4 h-4"})})]})]})]}):e.jsx(j,{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(l,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the left to start messaging"})]})})})]})]})};export{G as B};
