import{j as e}from"./ui-s1SEoZIF.js";import{d as s,r as t}from"./router-D8v2YSKU.js";import{u as a,a2 as r,aE as l,q as i,r as n,s as c,v as d,w as o,a as m,e as x,W as h,b as p,c as u,B as j,x as f,M as g,h as N,aF as v,f as y,E as k,a4 as b,a5 as w,a6 as S,a7 as T,a8 as C,ae as _,L as A,T as P,Z as E}from"./index-CJkfZmVJ.js";import{s as R}from"./subAdminService-88HlWW2D.js";import{L as F}from"./lock-BGPZvnBE.js";import{P as B}from"./paperclip-Bq5E5qgb.js";import{A as O}from"./arrow-right-left-BqMNfgLQ.js";import{D as I}from"./download-CWlvrHqp.js";import"./vendor-BxThA0WO.js";const D=()=>{const{user:D}=a(),$=s(),z=D?.rolePermissions||[],{toast:U}=r(),L="admin"===D?.role||"superadmin"===D?.role||"subadmin"===D?.role,Y=e=>z.includes(e),M=L||Y(E.SUPPORT_TICKETS_READ),K=L||Y(E.SUPPORT_TICKETS_VIEW),V=L||Y(E.SUPPORT_TICKETS_REPLY),q=L||Y(E.SUPPORT_TICKETS_STATUS)||Y(E.SUPPORT_TICKETS_REPLY),[J,W]=t.useState([]),[Z,G]=t.useState(!0),[H,Q]=t.useState("open"),[X,ee]=t.useState(1),[se,te]=t.useState(1),[ae,re]=t.useState(null),[le,ie]=t.useState(!1),[ne,ce]=t.useState(!1),[de,oe]=t.useState(!1),[me,xe]=t.useState(""),[he,pe]=t.useState(!1),[ue,je]=t.useState([]),[fe,ge]=t.useState([]),[Ne,ve]=t.useState("all"),[ye,ke]=t.useState("");t.useEffect(()=>{if(!M)return U({title:"Access Denied",description:"You don't have permission to view support tickets.",variant:"destructive"}),void $("/rolebased");be()},[X,H]);const be=async()=>{if(M)try{G(!0);const e=await R.getSupportTickets(X,10,H);W(e.tickets),te(e.totalPages)}catch(e){U({title:"Error",description:e.message||"Failed to fetch support tickets",variant:"destructive"})}finally{G(!1)}};l("support_ticket_created",e=>{U({title:"New Support Ticket",description:"A new support ticket has been created"}),be()}),l("support_ticket_updated",e=>{be()}),l("message_received",e=>{"support"===e.type&&be()});const we=e=>{switch(e){case"open":return"destructive";case"in_progress":return"default";case"resolved":return"secondary";default:return"outline"}},Se=e=>{switch(e){case"urgent":case"high":return"destructive";case"medium":return"default";case"low":return"secondary";default:return"outline"}},Te=e=>{V?"closed"!==e.status&&"resolved"!==e.status?(re(e),ce(!0)):U({title:"Cannot Reply",description:`This ticket is ${e.status}. Only open or in-progress tickets can receive replies.`,variant:"destructive"}):U({title:"Access Denied",description:"You don't have permission to reply to tickets.",variant:"destructive"})},Ce=async(e,s)=>{if(q)try{pe(!0),await R.updateSupportTicket(e,s,""),U({title:"Success",description:`Ticket marked as ${s.replace("_"," ")}`}),be()}catch(t){U({title:"Error",description:t.message||"Failed to update ticket status",variant:"destructive"})}finally{pe(!1)}else U({title:"Access Denied",description:"You don't have permission to update ticket status.",variant:"destructive"})},_e=async()=>{try{const e=await fetch("/api/support/transfer-roles",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),s=await e.json();s.success?ge(s.data.roles||[]):U({title:"Error",description:s.message||"Failed to fetch available roles",variant:"destructive"})}catch(e){U({title:"Error",description:"Failed to fetch available roles",variant:"destructive"})}},Ae=async e=>{try{const s=e&&"all"!==e?`/api/support/transfer-users?role=${e}`:"/api/support/transfer-users",t=await fetch(s,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),a=await t.json();a.success&&je(a.data.users)}catch(s){}},Pe=ue.filter(e=>"all"===Ne||e.role===Ne);return M?Z&&0===J.length?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Support Tickets"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage customer support requests and complaints"})]}),e.jsx("div",{className:"animate-pulse space-y-4",children:[1,2,3].map(s=>e.jsx("div",{className:"h-32 bg-gray-200 rounded-lg"},s))})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Support Tickets"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage customer support requests and complaints"})]}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-4",children:e.jsxs(i,{value:H,onValueChange:Q,children:[e.jsx(n,{className:"w-full sm:w-48",children:e.jsx(c,{placeholder:"Filter by status"})}),e.jsxs(d,{children:[e.jsx(o,{value:"open",children:"Open Tickets"}),e.jsx(o,{value:"in_progress",children:"In Progress"}),e.jsx(o,{value:"resolved",children:"Resolved"}),e.jsx(o,{value:"closed",children:"Closed"}),e.jsx(o,{value:"all",children:"All Tickets"})]})]})}),e.jsx("div",{className:"space-y-4",children:0===J.length?e.jsx(m,{children:e.jsxs(x,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(h,{className:"h-12 w-12 text-blue-500 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold",children:"No Support Tickets"}),e.jsx("p",{className:"text-muted-foreground text-center",children:"open"===H?"No open support tickets at the moment.":`No ${H} tickets found.`})]})}):J.map(s=>e.jsxs(m,{children:[e.jsx(p,{children:e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[e.jsxs(u,{className:"text-lg",children:[s.ticketNumber&&e.jsxs("span",{className:"text-muted-foreground mr-2",children:["#",s.ticketNumber]}),s.subject||"Support Request"]}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.jsx(j,{variant:we(s.status),children:s.status.replace("_"," ")}),s.priority&&e.jsx(j,{variant:Se(s.priority),children:s.priority}),s.category&&e.jsx(j,{variant:"outline",children:s.category})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(f,{className:"h-3 w-3 flex-shrink-0"}),e.jsxs("span",{className:"truncate",children:[s.sender.profile.firstName," ",s.sender.profile.lastName]})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(g,{className:"h-3 w-3 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.sender.email})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(N,{className:"h-3 w-3 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:new Date(s.createdAt).toLocaleDateString()})]})]}),s.lockedBy&&e.jsxs(j,{variant:"secondary",className:"flex items-center gap-1 w-fit",children:[e.jsx(F,{className:"h-3 w-3"}),e.jsxs("span",{className:"text-xs",children:["Being handled by ",s.lockedBy.profile?.firstName," ",s.lockedBy.profile?.lastName||s.lockedBy.email]})]}),s.assignedTo&&!s.lockedBy&&e.jsxs(j,{variant:"outline",className:"flex items-center gap-1 w-fit",children:[e.jsx(f,{className:"h-3 w-3"}),e.jsxs("span",{className:"text-xs",children:["Assigned to ",s.assignedTo.profile?.firstName," ",s.assignedTo.profile?.lastName||s.assignedTo.email]})]})]})]})})}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted p-3 sm:p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(v,{className:"h-4 w-4 mt-1 text-muted-foreground flex-shrink-0"}),e.jsx("p",{className:"text-sm leading-relaxed break-words",children:s.message})]}),s.attachments&&s.attachments.length>0&&e.jsxs("div",{className:"flex items-center gap-1 mt-2 text-xs text-muted-foreground",children:[e.jsx(B,{className:"h-3 w-3"}),e.jsxs("span",{children:[s.attachments.length," attachment",s.attachments.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[K&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>(e=>{K?(re(e),ie(!0)):U({title:"Access Denied",description:"You don't have permission to view conversations.",variant:"destructive"})})(s),className:"flex-1 touch-manipulation min-h-[40px]",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"View Full Conversation"]}),(!s.lockedBy||s.lockedBy._id===D?.id)&&e.jsxs(e.Fragment,{children:[V&&"closed"!==s.status&&"resolved"!==s.status&&e.jsxs(y,{size:"sm",onClick:()=>Te(s),className:"flex-1 touch-manipulation min-h-[40px]",children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Reply"]}),q&&"open"===s.status&&(s.assignedTo?e.jsx(y,{size:"sm",variant:"secondary",onClick:()=>Ce(s._id,"in_progress"),disabled:he,className:"flex-1 touch-manipulation min-h-[40px]",children:"Mark In Progress"}):e.jsx(y,{size:"sm",variant:"secondary",onClick:()=>Ce(s._id,"in_progress"),disabled:he,className:"flex-1 touch-manipulation min-h-[40px]",children:"Accept"})),q&&"in_progress"===s.status&&e.jsx(y,{size:"sm",variant:"secondary",onClick:()=>Ce(s._id,"resolved"),disabled:he,className:"flex-1 touch-manipulation min-h-[40px]",children:"Mark Resolved"})]}),q&&s.lockedBy&&s.lockedBy._id===D?.id&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>(e=>{re(e),oe(!0),_e(),Ae()})(s),className:"flex-1 touch-manipulation min-h-[40px]",children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Transfer"]})]})]})]},s._id))}),se>1&&e.jsxs("div",{className:"flex flex-col sm:flex-row justify-center items-center gap-2",children:[e.jsx(y,{variant:"outline",disabled:1===X,onClick:()=>ee(X-1),className:"w-full sm:w-auto",children:"Previous"}),e.jsxs("span",{className:"px-3 py-2 text-sm text-center",children:["Page ",X," of ",se]}),e.jsx(y,{variant:"outline",disabled:X===se,onClick:()=>ee(X+1),className:"w-full sm:w-auto",children:"Next"})]}),e.jsx(b,{open:le,onOpenChange:ie,children:e.jsxs(w,{className:"max-w-3xl max-h-[80vh] overflow-y-auto mx-4 sm:mx-auto",children:[e.jsxs(S,{children:[e.jsxs(T,{className:"text-lg sm:text-xl",children:[ae?.ticketNumber&&`#${ae.ticketNumber} - `,ae?.subject||"Support Ticket"]}),e.jsxs(C,{className:"text-sm",children:["Conversation history with ",ae?.sender.profile.firstName," ",ae?.sender.profile.lastName]})]}),ae&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{className:"h-4 w-4"}),e.jsxs("span",{className:"font-semibold text-sm",children:[ae.sender.profile.firstName," ",ae.sender.profile.lastName]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(ae.createdAt).toLocaleString()})]}),e.jsx("p",{className:"text-sm",children:ae.message}),ae.attachments&&ae.attachments.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(B,{className:"h-3 w-3"}),e.jsxs("span",{children:[ae.attachments.length," attachment",ae.attachments.length>1?"s":""]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:ae.attachments.map((s,t)=>{const a=/\.(jpg|jpeg|png|gif|webp)$/i.test(s.filename);return e.jsxs("div",{className:"border rounded-lg overflow-hidden bg-white dark:bg-gray-900",children:[a?e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"block",children:e.jsx("img",{src:s.url,alt:s.filename,className:"w-full h-32 object-cover cursor-pointer hover:opacity-90 transition"})}):e.jsx("div",{className:"flex items-center justify-center h-32 bg-gray-100 dark:bg-gray-800",children:e.jsx(B,{className:"h-8 w-8 text-muted-foreground"})}),e.jsxs("div",{className:"p-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-xs truncate flex-1 mr-2",title:s.filename,children:s.filename}),e.jsx("a",{href:s.url,download:s.filename,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-700",children:e.jsx(I,{className:"h-3 w-3"})})]})]},t)})})]})]}),ae.responses&&ae.responses.length>1&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Responses"}),ae.responses.slice(1).map((s,t)=>e.jsxs("div",{className:"p-4 rounded-lg "+(s.isAdmin?"bg-blue-50 dark:bg-blue-950":"bg-muted"),children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.isAdmin?e.jsx(h,{className:"h-4 w-4 text-blue-600"}):e.jsx(f,{className:"h-4 w-4"}),e.jsxs("span",{className:"font-semibold text-sm",children:[s.author,s.isAdmin&&e.jsx(j,{variant:"outline",className:"ml-2",children:"Support"})]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.createdAt).toLocaleString()})]}),e.jsx("p",{className:"text-sm",children:s.message})]},t))]})]}),e.jsxs(_,{children:[e.jsx(y,{variant:"outline",onClick:()=>ie(!1),children:"Close"}),V&&ae&&"closed"!==ae.status&&"resolved"!==ae.status&&e.jsx(y,{onClick:()=>{ie(!1),ae&&Te(ae)},children:"Reply to Ticket"})]})]})}),e.jsx(b,{open:ne,onOpenChange:ce,children:e.jsxs(w,{className:"mx-4 sm:mx-auto",children:[e.jsxs(S,{children:[e.jsx(T,{className:"text-lg sm:text-xl",children:"Reply to Support Ticket"}),e.jsxs(C,{className:"text-sm",children:["Send a response to ",ae?.sender.profile.firstName," ",ae?.sender.profile.lastName]})]}),e.jsxs("div",{className:"space-y-4",children:[ae&&e.jsxs("div",{className:"bg-muted p-3 rounded-lg",children:[e.jsx("p",{className:"text-sm font-semibold mb-1",children:"Original Message:"}),e.jsx("p",{className:"text-sm",children:ae.message})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"reply",children:"Your Response"}),e.jsx(P,{id:"reply",placeholder:"Type your response here...",value:me,onChange:e=>xe(e.target.value),rows:6,className:"mt-2"})]})]}),e.jsxs(_,{children:[e.jsx(y,{variant:"outline",onClick:()=>{ce(!1),xe("")},children:"Cancel"}),e.jsx(y,{onClick:async()=>{if(ae&&me.trim())try{pe(!0),await R.updateSupportTicket(ae._id,ae.status,me),U({title:"Success",description:"Reply sent successfully"}),ce(!1),xe(""),re(null),be()}catch(e){U({title:"Error",description:e.message||"Failed to send reply",variant:"destructive"})}finally{pe(!1)}else U({title:"Error",description:"Please enter a reply message",variant:"destructive"})},disabled:he||!me.trim(),children:he?"Sending...":"Send Reply"})]})]})}),e.jsx(b,{open:de,onOpenChange:oe,children:e.jsxs(w,{className:"mx-4 sm:mx-auto max-w-md",children:[e.jsxs(S,{children:[e.jsx(T,{className:"text-lg sm:text-xl",children:"Transfer Support Ticket"}),e.jsxs(C,{className:"text-sm",children:["Transfer #",ae?.ticketNumber," to another support team member"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{htmlFor:"role-filter",children:"Filter by Role"}),e.jsxs(i,{value:Ne,onValueChange:e=>{ve(e),ke(""),Ae(e)},children:[e.jsx(n,{className:"mt-2",children:e.jsx(c,{placeholder:"Select role"})}),e.jsxs(d,{children:[e.jsx(o,{value:"all",children:"All Available Staff"}),fe.length>0?fe.map(s=>e.jsx(o,{value:s.name,children:s.name.charAt(0).toUpperCase()+s.name.slice(1)},s._id)):e.jsxs(e.Fragment,{children:[e.jsx(o,{value:"admin",children:"Admin"}),e.jsx(o,{value:"subadmin",children:"Sub Admin"}),e.jsx(o,{value:"agent",children:"Support Agent"})]})]})]})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"transfer-to",children:"Select User"}),e.jsxs(i,{value:ye,onValueChange:ke,children:[e.jsx(n,{className:"mt-2",children:e.jsx(c,{placeholder:"Choose a user to transfer to"})}),e.jsx(d,{children:0===Pe.length?e.jsx(o,{value:"none",disabled:!0,children:"No users available"}):Pe.map(s=>e.jsx(o,{value:s._id,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{children:[s.profile?.firstName," ",s.profile?.lastName]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.email," - ",s.role]})]})},s._id))})]})]}),0===Pe.length&&"all"!==Ne&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No ",Ne," users found. Try selecting a different role."]})]}),e.jsxs(_,{children:[e.jsx(y,{variant:"outline",onClick:()=>{oe(!1),ke(""),ve("all")},children:"Cancel"}),e.jsx(y,{onClick:async()=>{if(ae&&ye)try{pe(!0);const e=await fetch(`/api/support/tickets/${ae.ticketNumber}/transfer`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({targetUserId:ye})}),s=await e.json();if(!e.ok)throw new Error(s.message||"Failed to transfer ticket");U({title:"Success",description:"Ticket transferred successfully"}),oe(!1),ke(""),ve("all"),re(null),be()}catch(e){U({title:"Error",description:e.message||"Failed to transfer ticket",variant:"destructive"})}finally{pe(!1)}else U({title:"Error",description:"Please select a user to transfer to",variant:"destructive"})},disabled:he||!ye,children:he?"Transferring...":"Transfer Ticket"})]})]})})]}):null};export{D as default};
