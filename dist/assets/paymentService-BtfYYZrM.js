import{t as c}from"./index-SPvHGBGF.js";import"./ui-DOY6021Z.js";import"./router-2SVJvIbS.js";import"./vendor-Dazix4UH.js";const y="https://squares-v2.onrender.com/api";class l{async makeRequest(r,e={}){const a=`${y}${r}`,t={headers:{"Content-Type":"application/json",...e.headers},...e},n=localStorage.getItem("token");n&&(t.headers={...t.headers,Authorization:`Bearer ${n}`});try{const o=await fetch(a,t);if(console.log("Payment API request:",{url:a,method:t.method||"GET"}),console.log("Payment API response status:",o.status),!o.ok){const d=await o.json().catch(()=>({success:!1,message:`HTTP ${o.status}: ${o.statusText}`}));throw console.log("Payment API error data:",d),new Error(d.message||"An error occurred")}return await o.json()}catch(o){throw console.error("Payment API request failed:",o),o}}loadRazorpayScript(){return new Promise((r,e)=>{if(window.Razorpay){r();return}const a=document.createElement("script");a.src="https://checkout.razorpay.com/v1/checkout.js",a.onload=()=>r(),a.onerror=()=>e(new Error("Failed to load Razorpay script")),document.head.appendChild(a)})}async createPaymentOrder(r,e="monthly"){try{const a=await this.makeRequest("/payments/create-order",{method:"POST",body:JSON.stringify({planId:r,billingCycle:e})});if(!a.success)throw new Error("Failed to create payment order");return a.data}catch(a){const t=a instanceof Error?a.message:"Failed to create payment order";throw c({title:"Payment Error",description:t,variant:"destructive"}),a}}async verifyPayment(r){try{const e=await this.makeRequest("/payments/verify-payment",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error(e.message||"Payment verification failed");return e.data}catch(e){const a=e instanceof Error?e.message:"Payment verification failed";throw c({title:"Payment Verification Failed",description:a,variant:"destructive"}),e}}async initiatePayment(r){try{await this.loadRazorpayScript();const e=await this.createPaymentOrder(r.planId,r.billingCycle),a={key:e.keyId,amount:e.amount,currency:e.currency,name:"Ninety Nine Acres",description:`Subscription to ${e.planName}`,order_id:e.orderId,prefill:{email:e.userEmail},theme:{color:"#2563eb"},handler:async n=>{try{const o=await this.verifyPayment({razorpay_order_id:n.razorpay_order_id,razorpay_payment_id:n.razorpay_payment_id,razorpay_signature:n.razorpay_signature,planId:r.planId,billingCycle:r.billingCycle||"monthly"});c({title:"Payment Successful!",description:"Your subscription has been activated successfully."}),r.onSuccess&&r.onSuccess(o)}catch(o){console.error("Payment verification failed:",o),r.onFailure&&r.onFailure(o)}},modal:{ondismiss:()=>{c({title:"Payment Cancelled",description:"Payment was cancelled by user.",variant:"destructive"}),r.onFailure&&r.onFailure(new Error("Payment cancelled"))}}};new window.Razorpay(a).open()}catch(e){console.error("Payment initiation failed:",e);const a=e instanceof Error?e.message:"Failed to initiate payment";c({title:"Payment Failed",description:a,variant:"destructive"}),r.onFailure&&r.onFailure(e)}}async processSubscriptionPayment(r){try{await this.loadRazorpayScript();const e=await this.makeRequest("/payments/create-subscription-order",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error("Failed to create payment order");const a=e.data;return new Promise((t,n)=>{const o={key:a.keyId,amount:a.amount,currency:a.currency,name:"Ninety Nine Acres",description:`Subscription to ${a.planName}${r.addons.length>0?` with ${r.addons.length} addon(s)`:""}`,order_id:a.orderId,prefill:{email:a.userEmail},theme:{color:"#2563eb"},handler:async i=>{try{const s=await this.verifySubscriptionPayment({razorpay_order_id:i.razorpay_order_id,razorpay_payment_id:i.razorpay_payment_id,razorpay_signature:i.razorpay_signature,planId:r.planId,addons:r.addons,billingCycle:r.billingCycle,totalAmount:r.totalAmount});t({success:!0,data:s})}catch(s){console.error("Payment verification failed:",s),n({success:!1,message:s instanceof Error?s.message:"Payment verification failed"})}},modal:{ondismiss:()=>{n({success:!1,message:"Payment was cancelled by user"})}}};new window.Razorpay(o).open()})}catch(e){return console.error("Subscription payment failed:",e),{success:!1,message:e instanceof Error?e.message:"Failed to process subscription payment"}}}async verifySubscriptionPayment(r){try{const e=await this.makeRequest("/payments/verify-subscription-payment",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error(e.message||"Subscription payment verification failed");return e.data}catch(e){const a=e instanceof Error?e.message:"Subscription payment verification failed";throw new Error(a)}}async processAddonPayment(r){try{const e=await this.makeRequest("/payments/create-addon-order",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error("Failed to create addon payment order");const a=e.data;if(console.log("Addon payment order created:",a),a.isMockPayment||a.keyId==="mock_key_for_development"){console.log("Processing mock addon payment for development");try{const t=await this.verifyAddonPayment({razorpay_order_id:a.orderId,razorpay_payment_id:`mock_payment_${Date.now()}`,razorpay_signature:"mock_signature",addons:r.addons,totalAmount:r.totalAmount});return console.log("Mock addon payment verification result:",t),c({title:"Payment Successful!",description:"Addons have been added to your subscription successfully."}),{success:!0,data:t}}catch(t){return console.error("Mock addon payment verification failed:",t),{success:!1,message:t instanceof Error?t.message:"Mock addon payment verification failed"}}}return await this.loadRazorpayScript(),new Promise((t,n)=>{const o={key:a.keyId,amount:a.amount,currency:a.currency,name:"Ninety Nine Acres",description:`Addon purchase - ${r.addons.length} addon(s)`,order_id:a.orderId,prefill:{email:a.userEmail},theme:{color:"#2563eb"},handler:async i=>{try{console.log("Verifying addon payment with data:",{orderId:i.razorpay_order_id,paymentId:i.razorpay_payment_id,signature:i.razorpay_signature,addons:r.addons,totalAmount:r.totalAmount});const s=await this.verifyAddonPayment({razorpay_order_id:i.razorpay_order_id,razorpay_payment_id:i.razorpay_payment_id,razorpay_signature:i.razorpay_signature,addons:r.addons,totalAmount:r.totalAmount});console.log("Addon payment verification result:",s),c({title:"Payment Successful!",description:"Addons have been added to your subscription successfully."}),t({success:!0,data:s})}catch(s){console.error("Addon payment verification failed:",s),n({success:!1,message:s instanceof Error?s.message:"Addon payment verification failed"})}},modal:{ondismiss:()=>{n({success:!1,message:"Payment was cancelled by user"})}}};new window.Razorpay(o).open()})}catch(e){return console.error("Addon payment failed:",e),{success:!1,message:e instanceof Error?e.message:"Failed to process addon payment"}}}async verifyAddonPayment(r){try{const e=await this.makeRequest("/payments/verify-addon-payment",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error(e.message||"Addon payment verification failed");return e.data}catch(e){const a=e instanceof Error?e.message:"Addon payment verification failed";throw new Error(a)}}async getPaymentStatus(r){try{return(await this.makeRequest(`/payments/${r}/status`)).data}catch(e){throw console.error("Failed to fetch payment status:",e),e}}}const g=new l;export{g as default,g as paymentService};
