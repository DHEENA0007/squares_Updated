import{j as e}from"./ui-DHQhougw.js";import{r as s}from"./router-Bi51YGN-.js";import{t,a1 as a,a2 as r,K as l,f as i,a as n,e as d,a3 as c,a4 as m,a5 as o,B as x,G as u,I as h,S as g,q as p,r as j,s as f,v as N,a6 as v,a7 as y,a8 as b,a9 as w,aa as S,ab as k,ac as M,ad as C,A as E,T,ae as R}from"./index-CV77Hym3.js";import{S as _}from"./scroll-area-DoMMBcT1.js";import{A as $,b as q,c as P,d as D,e as F,f as A,g as O,h as I}from"./alert-dialog-BmGjqxP-.js";import{m as L}from"./messageService-DOqW2lsP.js";import{R as z}from"./refresh-cw-DllRcUU9.js";import{E as U}from"./ellipsis-vertical-CxIB23yb.js";import{T as G}from"./triangle-alert-Bkqs07-F.js";import{T as H}from"./trash-2-Da1AQ7FG.js";import{S as V}from"./send-Ba1ScysA.js";import"./vendor-eVk5PToZ.js";import"./uploadService-Bwy6d1dt.js";const B=new class{async makeRequest(e,s={}){try{const t=localStorage.getItem("token"),a=await fetch(`https://api.buildhomemartsquares.com/api${e}`,{headers:{"Content-Type":"application/json",...t&&{Authorization:`Bearer ${t}`},...s.headers},...s});if(!a.ok){const e=await a.json().catch(()=>({}));throw new Error(e.message||`HTTP error! status: ${a.status}`)}return await a.json()}catch(t){throw t}}async getMessages(e={}){try{const s=new URLSearchParams;Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t&&s.append(e,t.toString())});const t=s.toString(),a="/admin/messages"+(t?`?${t}`:"");return await this.makeRequest(a)}catch(s){const e=s instanceof Error?s.message:"Failed to fetch messages";throw t({title:"Error",description:e,variant:"destructive"}),s}}async getMessageStats(){try{const e=await this.makeRequest("/admin/messages/stats");if(e.success)return e.data;throw new Error("Failed to fetch message statistics")}catch(e){const s=e instanceof Error?e.message:"Failed to fetch message statistics";throw t({title:"Error",description:s,variant:"destructive"}),e}}async updateMessageStatus(e,s){try{const a=await this.makeRequest(`/admin/messages/${e}/status`,{method:"PATCH",body:JSON.stringify({status:s})});if(a.success)return t({title:"Success",description:a.message}),a.data.message;throw new Error("Failed to update message status")}catch(a){const e=a instanceof Error?a.message:"Failed to update message status";throw t({title:"Error",description:e,variant:"destructive"}),a}}async deleteMessage(e){try{const s=await this.makeRequest(`/admin/messages/${e}`,{method:"DELETE"});if(s.success)return void t({title:"Success",description:s.message});throw new Error("Failed to delete message")}catch(s){const e=s instanceof Error?s.message:"Failed to delete message";throw t({title:"Error",description:e,variant:"destructive"}),s}}async sendReply(e,s,a){try{const r=await this.makeRequest(`/admin/messages/${e}/reply`,{method:"POST",body:JSON.stringify({content:s,subject:a})});if(r.success)return t({title:"Success",description:r.message}),r.data.reply;throw new Error("Failed to send reply")}catch(r){const e=r instanceof Error?r.message:"Failed to send reply";throw t({title:"Error",description:e,variant:"destructive"}),r}}getSenderName(e){const s=e.sender.profile;return s?.firstName&&s?.lastName?`${s.firstName} ${s.lastName}`:e.sender.email}getRecipientName(e){const s=e.recipient.profile;return s?.firstName&&s?.lastName?`${s.firstName} ${s.lastName}`:e.recipient.email}formatDate(e){const s=new Date(e),t=((new Date).getTime()-s.getTime())/36e5;return t<1?`${Math.floor(60*t)} minutes ago`:t<24?`${Math.floor(t)} hours ago`:t<48?"Yesterday":s.toLocaleDateString("en-IN",{year:"numeric",month:"short",day:"numeric"})}getStatusColor(e){return{unread:"bg-blue-100 text-blue-800",read:"bg-green-100 text-green-800",replied:"bg-purple-100 text-purple-800",flagged:"bg-red-100 text-red-800",archived:"bg-gray-100 text-gray-800"}[e]||"bg-gray-100 text-gray-800"}getPriorityColor(e){return{urgent:"bg-red-500 text-white",high:"bg-orange-500 text-white",medium:"bg-yellow-500 text-white",low:"bg-green-500 text-white"}[e]||"bg-gray-500 text-white"}getTypeDisplayName(e){return{inquiry:"General Inquiry",lead:"Lead",property_inquiry:"Property Inquiry",general:"General",support:"Support",complaint:"Complaint"}[e]||e}},J=()=>{const{isConnected:t}=a(),[J,K]=s.useState([]),[Y,Q]=s.useState([]),[W,X]=s.useState(null),[Z,ee]=s.useState(!0),[se,te]=s.useState(null),[ae,re]=s.useState("all"),[le,ie]=s.useState(""),[ne,de]=s.useState("all"),[ce,me]=s.useState("all"),[oe,xe]=s.useState("all"),[ue,he]=s.useState(""),[ge,pe]=s.useState(null),[je,fe]=s.useState({}),[Ne,ve]=s.useState(!1),[ye,be]=s.useState(!1),we=s.useRef(null),Se=s.useRef(null),[ke,Me]=s.useState({currentPage:1,totalPages:1,totalMessages:0,hasNext:!1,hasPrev:!1,limit:20});r({refreshConversations:()=>{Ee()},onNewMessage:e=>{Ee(),Te()},onMessageRead:()=>{Ee(),Te()}}),s.useEffect(()=>{Ee(),Te()},[]),s.useEffect(()=>{if(J.length>0){Ce();const e=setInterval(Ce,1e4);return()=>clearInterval(e)}},[J]);const Ce=async()=>{const e={},s=new Set(J.map(e=>e.sender._id));for(const a of s)try{const s=await L.getUserStatus(a);e[a]=s}catch(t){}fe(e)};s.useEffect(()=>()=>{we.current&&clearTimeout(we.current)},[]);const Ee=async(e={})=>{try{ee(!0);const s={page:ke.currentPage,limit:ke.limit,status:"all"!==ne?ne:void 0,type:"all"!==ce?ce:void 0,priority:"all"!==oe?oe:void 0,search:le||void 0,...e},t=await B.getMessages(s);t.success&&(K(t.data.messages),Me(t.data.pagination))}catch(s){}finally{ee(!1)}},Te=async()=>{try{const e=await B.getMessageStats();te(e)}catch(e){}};s.useEffect(()=>{Ee()},[ae,ne,ce,oe,le,ke.currentPage]),s.useEffect(()=>{let e=J;switch(ae){case"unread":e=e.filter(e=>"unread"===e.status);break;case"flagged":e=e.filter(e=>"flagged"===e.status);break;case"inquiries":e=e.filter(e=>["inquiry","lead","property_inquiry"].includes(e.type));break;case"support":e=e.filter(e=>["support","complaint"].includes(e.type))}Q(e)},[J,ae]);const Re=e=>B.getSenderName(e),_e=e=>B.formatDate(e),$e=e=>B.getStatusColor(e),qe=e=>B.getPriorityColor(e);return Z?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(l,{className:"h-6 w-6 animate-spin"}),e.jsx("span",{children:"Loading messages..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full "+(t?"bg-green-500":"bg-red-500")}),e.jsx("span",{className:"text-sm text-muted-foreground",children:t?"Real-time messaging active":"Offline mode"})]}),Z&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(l,{className:"w-4 h-4 animate-spin"}),"Loading messages..."]})]}),e.jsxs("div",{className:"flex flex-col space-y-3 md:flex-row md:justify-between md:items-center md:space-y-0",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold tracking-tight",children:"Messages"}),e.jsx("p",{className:"text-sm md:text-base text-muted-foreground",children:"Manage and respond to user messages and inquiries"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>Ee(),children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Refresh"]})})]}),se&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 md:gap-4",children:[e.jsx(n,{children:e.jsxs(d,{className:"p-3 md:p-4 text-center",children:[e.jsx("div",{className:"text-lg md:text-2xl font-bold text-blue-600",children:se.totalMessages}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"Total Messages"})]})}),e.jsx(n,{children:e.jsxs(d,{className:"p-3 md:p-4 text-center",children:[e.jsx("div",{className:"text-lg md:text-2xl font-bold text-orange-600",children:se.unreadMessages}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"Unread"})]})}),e.jsx(n,{children:e.jsxs(d,{className:"p-3 md:p-4 text-center",children:[e.jsx("div",{className:"text-lg md:text-2xl font-bold text-green-600",children:se.repliedMessages}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"Replied"})]})}),e.jsx(n,{children:e.jsxs(d,{className:"p-3 md:p-4 text-center",children:[e.jsx("div",{className:"text-lg md:text-2xl font-bold text-red-600",children:se.flaggedMessages}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"Flagged"})]})}),e.jsx(n,{children:e.jsxs(d,{className:"p-3 md:p-4 text-center",children:[e.jsx("div",{className:"text-lg md:text-2xl font-bold text-purple-600",children:se.todayMessages}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"Today"})]})}),e.jsx(n,{children:e.jsxs(d,{className:"p-3 md:p-4 text-center",children:[e.jsxs("div",{className:"text-lg md:text-2xl font-bold text-teal-600",children:[se.responseRate,"%"]}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"Response Rate"})]})}),e.jsx(n,{children:e.jsxs(d,{className:"p-3 md:p-4 text-center",children:[e.jsx("div",{className:"text-lg md:text-2xl font-bold text-indigo-600",children:se.avgResponseTime}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground",children:"Avg Response"})]})})]}),e.jsxs("div",{className:"h-[calc(100vh-16rem)] md:h-[calc(100vh-18rem)] flex gap-4 md:gap-6",children:[e.jsxs("div",{className:"w-full md:w-1/3 border-r-0 md:border-r border-border "+(W?"hidden md:block":"block"),children:[e.jsx(c,{value:ae,onValueChange:re,className:"w-full",children:e.jsxs(m,{className:"w-full grid grid-cols-3",children:[e.jsxs(o,{value:"all",className:"text-xs",children:["All ",se&&se.totalMessages>0&&e.jsx(x,{className:"ml-1 text-xs",variant:"secondary",children:se.totalMessages})]}),e.jsxs(o,{value:"unread",className:"text-xs",children:["Unread ",se&&se.unreadMessages>0&&e.jsx(x,{className:"ml-1 text-xs bg-red-500 text-white",children:se.unreadMessages})]}),e.jsxs(o,{value:"flagged",className:"text-xs",children:["Flagged ",se&&se.flaggedMessages>0&&e.jsx(x,{className:"ml-1 text-xs bg-orange-500 text-white",children:se.flaggedMessages})]})]})}),e.jsxs("div",{className:"p-3 md:p-4 border-b border-border space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(u,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(h,{placeholder:"Search conversations...",value:le,onChange:e=>ie(e.target.value),className:"pl-10 text-sm"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(g,{value:ce,onValueChange:me,children:[e.jsx(p,{className:"flex-1",children:e.jsx(j,{placeholder:"Type"})}),e.jsxs(f,{children:[e.jsx(N,{value:"all",children:"All"}),e.jsx(N,{value:"inquiry",children:"Inquiry"}),e.jsx(N,{value:"property_inquiry",children:"Property"}),e.jsx(N,{value:"support",children:"Support"})]})]}),e.jsxs(g,{value:oe,onValueChange:xe,children:[e.jsx(p,{className:"flex-1",children:e.jsx(j,{placeholder:"Priority"})}),e.jsxs(f,{children:[e.jsx(N,{value:"all",children:"All"}),e.jsx(N,{value:"urgent",children:"Urgent"}),e.jsx(N,{value:"high",children:"High"}),e.jsx(N,{value:"medium",children:"Medium"}),e.jsx(N,{value:"low",children:"Low"})]})]})]})]}),e.jsx(_,{className:"h-[calc(100%-10rem)] md:h-[calc(100%-12rem)]",children:e.jsx("div",{className:"p-2 space-y-1",children:Y.map(s=>e.jsx("div",{className:"p-3 rounded-lg cursor-pointer transition-colors hover:bg-accent/50 "+(W?._id===s._id?"bg-accent":""),onClick:()=>{X(s),"unread"===s.status&&(async e=>{try{await B.updateMessageStatus(e,"read"),Ee(),Te()}catch(s){}})(s._id)},children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs(v,{className:"w-8 h-8 md:w-10 md:h-10",children:[e.jsx(y,{src:s.sender.profile?.avatar}),e.jsx(b,{children:Re(s).charAt(0).toUpperCase()})]}),je[s.sender._id]?.isOnline?e.jsx("div",{title:"Online",children:e.jsx(w,{className:"absolute -bottom-1 -right-1 w-2 h-2 md:w-3 md:h-3 fill-green-500 text-green-500 border-2 border-background rounded-full"})}):e.jsx("div",{title:`Last seen ${je[s.sender._id]?.lastSeen?L.formatTime(je[s.sender._id].lastSeen):"recently"}`,children:e.jsx(w,{className:"absolute -bottom-1 -right-1 w-2 h-2 md:w-3 md:h-3 fill-gray-400 text-gray-400 border-2 border-background rounded-full"})}),"unread"===s.status&&e.jsx("div",{className:"absolute -top-1 -left-1 w-2 h-2 md:w-3 md:h-3 rounded-full bg-red-500"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between mb-1",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:Re(s)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:_e(s.createdAt)})]}),s.subject&&e.jsx("p",{className:"text-xs font-medium text-primary mb-1 truncate",children:s.subject}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.content}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("div",{className:"flex gap-1 flex-wrap",children:[e.jsx(x,{className:`text-xs ${qe(s.priority)}`,children:s.priority}),e.jsx(x,{className:`text-xs ${$e(s.status)}`,children:s.status})]}),e.jsxs(S,{children:[e.jsx(k,{asChild:!0,children:e.jsx(i,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",children:e.jsx(U,{className:"w-3 h-3"})})}),e.jsxs(M,{align:"end",children:[e.jsxs(C,{onClick:()=>(async e=>{try{await B.updateMessageStatus(e,"flagged"),Ee(),Te()}catch(s){}})(s._id),children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"Flag"]}),e.jsxs(C,{className:"text-red-600",onSelect:e=>{e.preventDefault(),pe(s._id)},children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]})]})]})]})},s._id))})})]}),e.jsx("div",{className:"flex-1 flex flex-col min-h-0 "+(W?"block md:flex-1":"hidden md:flex"),children:W?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-3 md:p-4 border-b border-border",children:[e.jsx("div",{className:"md:hidden mb-3",children:e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>X(null),className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"Back to Messages"]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs(v,{className:"w-8 h-8 md:w-10 md:h-10",children:[e.jsx(y,{src:W.sender.profile?.avatar}),e.jsx(b,{children:Re(W).charAt(0).toUpperCase()})]}),je[W.sender._id]?.isOnline?e.jsx("div",{title:"Online",children:e.jsx(w,{className:"absolute -bottom-1 -right-1 w-2 h-2 md:w-3 md:h-3 fill-green-500 text-green-500 border-2 border-background rounded-full"})}):e.jsx("div",{title:`Last seen ${je[W.sender._id]?.lastSeen?L.formatTime(je[W.sender._id].lastSeen):"recently"}`,children:e.jsx(w,{className:"absolute -bottom-1 -right-1 w-2 h-2 md:w-3 md:h-3 fill-gray-400 text-gray-400 border-2 border-background rounded-full"})})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"font-semibold text-sm md:text-base truncate",children:Re(W)}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:je[W.sender._id]?.isOnline?"Online":`Last seen ${je[W.sender._id]?.lastSeen?L.formatTime(je[W.sender._id].lastSeen):"recently"}`})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(x,{className:`text-xs ${qe(W.priority)}`,children:W.priority}),e.jsx(x,{className:`text-xs ${$e(W.status)}`,children:W.status})]})]}),W.property&&e.jsxs("div",{className:"mt-3 p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium",children:"Related Property:"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:W.property.title})]})]}),e.jsx(_,{className:"flex-1 p-3 md:p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"max-w-[85%] md:max-w-[70%] bg-muted p-3 rounded-lg",children:[W.subject&&e.jsx("p",{className:"font-medium text-sm mb-2",children:W.subject}),e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:W.content}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 mt-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:_e(W.createdAt)}),e.jsx(x,{variant:"outline",className:"text-xs w-fit",children:W.type?.replace("_"," ")||"general"})]})]})}),ye&&e.jsx("div",{className:"flex justify-start animate-fadeIn",children:e.jsx("div",{className:"bg-muted/80 px-4 py-2 rounded-lg border border-border/50",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground italic",children:[Re(W)," is typing..."]})]})})}),e.jsx("div",{ref:Se})]})}),e.jsx("div",{className:"p-3 md:p-4 border-t border-border",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(T,{placeholder:"Type your reply...",value:ue,onChange:e=>{return s=e.target.value,he(s),we.current&&clearTimeout(we.current),void(s.trim()&&W?(Ne||ve(!0),we.current=setTimeout(()=>{ve(!1)},3e3)):ve(!1));var s},rows:3,className:"resize-none text-sm"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(i,{onClick:async()=>{if(W&&ue.trim())try{Ne&&ve(!1),await B.sendReply(W._id,ue.trim()),he(""),Ee(),Te(),setTimeout(()=>{Se.current?.scrollIntoView({behavior:"smooth"})},100)}catch(e){}},disabled:!ue.trim(),className:"flex-1",size:"sm",children:[e.jsx(V,{className:"w-4 h-4 mr-2"}),"Send Reply"]}),e.jsx(i,{variant:"outline",onClick:()=>he(""),size:"sm",children:"Clear"})]})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(R,{className:"w-12 h-12 md:w-16 md:h-16 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg md:text-xl font-semibold mb-2",children:"Select a Conversation"}),e.jsx("p",{className:"text-sm md:text-base text-muted-foreground",children:"Choose a message from the list to start chatting"})]})})})]}),e.jsx($,{open:!!ge,onOpenChange:e=>{e||pe(null)},children:e.jsxs(q,{className:"sm:max-w-[425px] mx-4",children:[e.jsxs(P,{children:[e.jsx(D,{className:"text-base md:text-lg",children:"Delete Message"}),e.jsx(F,{className:"text-sm md:text-base",children:"Are you sure you want to delete this message? This action cannot be undone."})]}),e.jsxs(A,{className:"flex flex-col-reverse sm:flex-row gap-2 sm:gap-0",children:[e.jsx(O,{onClick:()=>pe(null),className:"w-full sm:w-auto",children:"Cancel"}),e.jsx(I,{onClick:()=>{ge&&(async e=>{try{await B.deleteMessage(e),W?._id===e&&X(null),Ee(),Te(),pe(null)}catch(s){}})(ge)},className:"bg-red-600 hover:bg-red-700 focus:ring-red-600 w-full sm:w-auto",children:"Delete Message"})]})]})})]})};export{J as default};
