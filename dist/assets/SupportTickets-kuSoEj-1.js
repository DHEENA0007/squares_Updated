import{j as e}from"./ui-BNZSgpjP.js";import{r as s}from"./router-D8v2YSKU.js";import{a2 as t,u as a,aO as r,q as i,r as l,s as n,v as c,w as d,a as o,e as x,B as m,x as u,aD as h,aE as p,f as j,aF as f,aI as g,aB as N,ap as v,ar as k,T as y,a4 as b,a5 as w,a6 as S,a7 as T,a8 as _,L as C,ae as A}from"./index-BxQlwZ4N.js";import{s as B}from"./subAdminService-FXuBf3hg.js";import{S as F,a as I,b as P,c as E,d as D}from"./sheet-BFok3I82.js";import{T as O,a as R,b as z,c as L,d as $,e as M}from"./table-DislQvtG.js";import{L as V}from"./lock-BNUYFmUg.js";import{E as q}from"./ellipsis-vertical-BDnz6YIk.js";import{P as U}from"./paperclip-CekB-vi0.js";import{D as H}from"./download-CJjNKXXO.js";import{S as J}from"./send-BUuLCIjo.js";import"./vendor-BxThA0WO.js";const G=()=>{const[G,K]=s.useState([]),[Q,W]=s.useState(!0),[X,Y]=s.useState("open"),[Z,ee]=s.useState(1),[se,te]=s.useState(1),[ae,re]=s.useState(null),[ie,le]=s.useState(!1),[ne,ce]=s.useState(!1),[de,oe]=s.useState(""),[xe,me]=s.useState(!1),[ue,he]=s.useState([]),[pe,je]=s.useState([]),[fe,ge]=s.useState("all"),[Ne,ve]=s.useState(""),{toast:ke}=t(),{user:ye}=a(),be=s.useRef(null);s.useEffect(()=>{we()},[Z,X]),s.useEffect(()=>{ie&&be.current&&be.current.scrollIntoView({behavior:"smooth"})},[ie,ae?.responses]);const we=async()=>{try{W(!0);const e=await B.getSupportTickets(Z,10,X);K(e.tickets),te(e.totalPages)}catch(e){ke({title:"Error",description:e.message||"Failed to fetch support tickets",variant:"destructive"})}finally{W(!1)}};r("support_ticket_created",e=>{ke({title:"New Support Ticket",description:"A new support ticket has been created"}),we()}),r("support_ticket_updated",e=>{we()}),r("message_received",e=>{"support"===e.type&&(we(),ae&&e.ticketId===ae._id&&B.getSupportTickets(Z,10,X).then(e=>{const s=e.tickets.find(e=>e._id===ae._id);s&&re(s)}))});const Se=e=>{switch(e){case"open":return"destructive";case"in_progress":return"default";default:return"outline"}},Te=e=>{switch(e){case"urgent":case"high":return"destructive";case"medium":return"default";case"low":return"secondary";default:return"outline"}},_e=e=>{re(e),le(!0)},Ce=async(e,s)=>{try{me(!0),await B.updateSupportTicket(e,s,""),ke({title:"Success",description:`Ticket marked as ${s.replace("_"," ")}`}),we(),ae&&ae._id===e&&re(e=>e?{...e,status:s}:null)}catch(t){423===t.status||t.message?.includes("locked")?(ke({title:"Ticket Locked",description:"This ticket is currently being handled by another user",variant:"destructive"}),we()):ke({title:"Error",description:"Failed to update ticket status",variant:"destructive"})}finally{me(!1)}},Ae=async()=>{try{const e=await fetch("/api/support/transfer-roles",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),s=await e.json();s.success&&je(s.data.roles||[])}catch(e){}},Be=async e=>{try{const s=e&&"all"!==e?`/api/support/transfer-users?role=${e}`:"/api/support/transfer-users",t=await fetch(s,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),a=await t.json();a.success&&he(a.data.users)}catch(s){}},Fe=ue.filter(e=>"all"===fe||e.role===fe);return e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Support Tickets"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage and respond to customer support requests"})]}),e.jsxs(i,{value:X,onValueChange:Y,children:[e.jsx(l,{className:"w-[180px]",children:e.jsx(n,{placeholder:"Filter by status"})}),e.jsxs(c,{children:[e.jsx(d,{value:"open",children:"Open Tickets"}),e.jsx(d,{value:"in_progress",children:"In Progress"}),e.jsx(d,{value:"closed",children:"Closed"}),e.jsx(d,{value:"all",children:"All Tickets"})]})]})]}),e.jsx(o,{children:e.jsx(x,{className:"p-0",children:e.jsxs(O,{children:[e.jsx(R,{children:e.jsxs(z,{children:[e.jsx(L,{className:"w-[100px]",children:"Ticket ID"}),e.jsx(L,{children:"Subject"}),e.jsx(L,{children:"Requester"}),e.jsx(L,{children:"Status"}),e.jsx(L,{children:"Priority"}),e.jsx(L,{children:"Assigned To"}),e.jsx(L,{children:"Created"}),e.jsx(L,{className:"text-right",children:"Actions"})]})}),e.jsx($,{children:Q?[...Array(5)].map((s,t)=>e.jsxs(z,{children:[e.jsx(M,{children:e.jsx("div",{className:"h-4 w-12 bg-muted animate-pulse rounded"})}),e.jsx(M,{children:e.jsx("div",{className:"h-4 w-32 bg-muted animate-pulse rounded"})}),e.jsx(M,{children:e.jsx("div",{className:"h-4 w-24 bg-muted animate-pulse rounded"})}),e.jsx(M,{children:e.jsx("div",{className:"h-4 w-16 bg-muted animate-pulse rounded"})}),e.jsx(M,{children:e.jsx("div",{className:"h-4 w-16 bg-muted animate-pulse rounded"})}),e.jsx(M,{children:e.jsx("div",{className:"h-4 w-24 bg-muted animate-pulse rounded"})}),e.jsx(M,{children:e.jsx("div",{className:"h-4 w-20 bg-muted animate-pulse rounded"})}),e.jsx(M,{children:e.jsx("div",{className:"h-8 w-8 bg-muted animate-pulse rounded ml-auto"})})]},t)):0===G.length?e.jsx(z,{children:e.jsx(M,{colSpan:8,className:"h-24 text-center",children:"No tickets found."})}):G.map(s=>e.jsxs(z,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>_e(s),children:[e.jsxs(M,{className:"font-medium",children:["#",s.ticketNumber]}),e.jsx(M,{className:"max-w-[200px] truncate",children:s.subject||"No Subject"}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-medium text-sm",children:[s.sender.profile.firstName," ",s.sender.profile.lastName]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.sender.email})]})}),e.jsx(M,{children:e.jsx(m,{variant:Se(s.status),children:s.status.replace("_"," ")})}),e.jsx(M,{children:s.priority&&e.jsx(m,{variant:Te(s.priority),children:s.priority})}),e.jsx(M,{children:s.lockedBy?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-orange-600 font-medium",children:[e.jsx(V,{className:"h-3 w-3"}),s.lockedBy.profile?.firstName]}):s.assignedTo?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(u,{className:"h-3 w-3"}),s.assignedTo.profile?.firstName]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Unassigned"})}),e.jsx(M,{className:"text-muted-foreground text-xs",children:new Date(s.createdAt).toLocaleDateString()}),e.jsx(M,{className:"text-right",onClick:e=>e.stopPropagation(),children:e.jsxs(h,{children:[e.jsx(p,{asChild:!0,children:e.jsxs(j,{variant:"ghost",className:"h-8 w-8 p-0",children:[e.jsx("span",{className:"sr-only",children:"Open menu"}),e.jsx(q,{className:"h-4 w-4"})]})}),e.jsxs(f,{align:"end",children:[e.jsx(g,{onClick:()=>_e(s),children:"View Details"}),(!s.lockedBy||s.lockedBy._id===ye?.id)&&e.jsxs(e.Fragment,{children:["open"===s.status&&e.jsx(g,{onClick:()=>Ce(s._id,"in_progress"),children:s.assignedTo?"Mark In Progress":"Accept"}),"in_progress"===s.status&&e.jsx(g,{onClick:()=>Ce(s._id,"closed"),children:"Mark Closed"}),e.jsx(g,{onClick:()=>(e=>{re(e),ce(!0),Ae(),Be()})(s),children:"Transfer Ticket"})]})]})]})})]},s._id))})]})})}),se>1&&e.jsxs("div",{className:"flex justify-center gap-2 mt-4",children:[e.jsx(j,{variant:"outline",disabled:1===Z,onClick:()=>ee(Z-1),children:"Previous"}),e.jsxs("span",{className:"py-2 px-3 text-sm",children:["Page ",Z," of ",se]}),e.jsx(j,{variant:"outline",disabled:Z===se,onClick:()=>ee(Z+1),children:"Next"})]}),e.jsx(F,{open:ie,onOpenChange:le,children:e.jsxs(I,{className:"w-full sm:max-w-xl flex flex-col p-0 gap-0",children:[e.jsxs(P,{className:"p-6 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(m,{variant:Se(ae?.status||"open"),children:ae?.status.replace("_"," ")}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["#",ae?.ticketNumber]})]}),e.jsx(E,{className:"text-xl text-left",children:ae?.subject||"Support Request"}),e.jsxs(D,{className:"text-left flex items-center gap-2 mt-1",children:[e.jsx(u,{className:"h-4 w-4"}),ae?.sender.profile.firstName," ",ae?.sender.profile.lastName,e.jsx("span",{className:"text-xs text-muted-foreground ml-2",children:ae&&new Date(ae.createdAt).toLocaleString()})]})]}),e.jsx(N,{className:"flex-1 p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-3",children:[e.jsx("p",{className:"text-sm leading-relaxed",children:ae?.message}),ae?.attachments&&ae.attachments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-2 border-t border-border/50",children:ae.attachments.map((s,t)=>e.jsxs("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 text-xs bg-background p-2 rounded border hover:bg-accent transition-colors",children:[e.jsx(U,{className:"h-3 w-3"}),e.jsx("span",{className:"max-w-[150px] truncate",children:s.filename}),e.jsx(H,{className:"h-3 w-3 ml-1"})]},t))})]}),ae?.responses&&ae.responses.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative flex items-center gap-4",children:[e.jsx("div",{className:"h-px bg-border flex-1"}),e.jsx("span",{className:"text-xs text-muted-foreground font-medium uppercase",children:"History"}),e.jsx("div",{className:"h-px bg-border flex-1"})]}),ae.responses.map((s,t)=>e.jsxs("div",{className:"flex gap-3 "+(s.isAdmin?"flex-row-reverse":"flex-row"),children:[e.jsx(v,{className:"h-8 w-8",children:e.jsx(k,{className:s.isAdmin?"bg-primary text-primary-foreground":"",children:s.author[0]})}),e.jsxs("div",{className:"flex flex-col max-w-[80%] "+(s.isAdmin?"items-end":"items-start"),children:[e.jsx("div",{className:"p-3 rounded-lg text-sm "+(s.isAdmin?"bg-primary text-primary-foreground rounded-tr-none":"bg-muted rounded-tl-none"),children:s.message}),e.jsx("span",{className:"text-[10px] text-muted-foreground mt-1",children:new Date(s.createdAt).toLocaleString()})]})]},t)),e.jsx("div",{ref:be})]})]})}),e.jsx("div",{className:"p-4 border-t bg-background",children:ae?.lockedBy&&ae.lockedBy._id!==ye?.id?e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-orange-50 text-orange-800 rounded-md text-sm",children:[e.jsx(V,{className:"h-4 w-4"}),"This ticket is locked by ",ae?.lockedBy.profile?.firstName]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(y,{placeholder:"Type your reply...",value:de,onChange:e=>oe(e.target.value),className:"min-h-[100px] resize-none"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-2",children:["open"===ae?.status&&e.jsx(j,{variant:"outline",size:"sm",onClick:()=>Ce(ae._id,"in_progress"),children:ae.assignedTo?"Mark In Progress":"Accept"}),"in_progress"===ae?.status&&e.jsx(j,{variant:"outline",size:"sm",onClick:()=>Ce(ae._id,"closed"),children:"Mark Closed"})]}),e.jsx(j,{onClick:async()=>{if(ae&&de.trim())try{me(!0),await B.updateSupportTicket(ae._id,ae.status,de),oe("");const e=await B.getSupportTickets(Z,10,X);K(e.tickets);const s=e.tickets.find(e=>e._id===ae._id);s&&re(s),ke({title:"Success",description:"Reply sent successfully"})}catch(e){423===e.status||e.message?.includes("locked")?(ke({title:"Ticket Locked",description:"This ticket is currently being handled by another user",variant:"destructive"}),we()):ke({title:"Error",description:e.message||"Failed to send reply",variant:"destructive"})}finally{me(!1)}},disabled:xe||!de.trim(),children:xe?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Reply"]})})]})]})})]})}),e.jsx(b,{open:ne,onOpenChange:ce,children:e.jsxs(w,{className:"sm:max-w-md",children:[e.jsxs(S,{children:[e.jsx(T,{children:"Transfer Ticket"}),e.jsx(_,{children:"Assign this ticket to another team member."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Filter by Role"}),e.jsxs(i,{value:fe,onValueChange:e=>{ge(e),ve(""),Be(e)},children:[e.jsx(l,{children:e.jsx(n,{placeholder:"Select role"})}),e.jsxs(c,{children:[e.jsx(d,{value:"all",children:"All Roles"}),pe.map(s=>e.jsx(d,{value:s.name,children:s.name},s._id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Select User"}),e.jsxs(i,{value:Ne,onValueChange:ve,children:[e.jsx(l,{children:e.jsx(n,{placeholder:"Select user"})}),e.jsx(c,{children:Fe.map(s=>e.jsxs(d,{value:s._id,children:[s.profile?.firstName," ",s.profile?.lastName]},s._id))})]})]})]}),e.jsxs(A,{children:[e.jsx(j,{variant:"outline",onClick:()=>ce(!1),children:"Cancel"}),e.jsx(j,{onClick:async()=>{if(ae&&Ne)try{me(!0);const e=await fetch(`/api/support/tickets/${ae.ticketNumber}/transfer`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({targetUserId:Ne})}),s=await e.json();if(!e.ok)throw new Error(s.message||"Failed to transfer ticket");ke({title:"Success",description:"Ticket transferred successfully"}),ce(!1),ve(""),ge("all"),le(!1),we()}catch(e){ke({title:"Error",description:e.message||"Failed to transfer ticket",variant:"destructive"})}finally{me(!1)}},disabled:xe||!Ne,children:"Transfer"})]})]})})]})};export{G as default};
