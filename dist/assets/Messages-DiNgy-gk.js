import{j as e}from"./ui-CEt46o3G.js";import{r as n}from"./router-2SVJvIbS.js";import{C as Y,a as G,b as ue,d as S}from"./card-YvDMUmzt.js";import{O as fe,u as ge,a3 as je,o as M,B as A,S as ve,I as Ne,A as J,j as Z,k as ee,D as T,l as k,a as m,m as F,n as p,z as se,M as ye,X as we,t as j}from"./index-CiYV0Sy0.js";import{T as be}from"./textarea-BbecYreM.js";import{S as te}from"./scroll-area-DSMA3UjI.js";import{S as Ce,a as Se,b as Me,c as Ae,d as I}from"./select-BHWxeluH.js";import{m as d}from"./messageService-DZmz6NiN.js";import{L as D}from"./loader-circle-Cj-dvH02.js";import{E as P}from"./ellipsis-vertical-CarBFatF.js";import{A as ae,P as re,C as ie,I as Te}from"./paperclip-CpfacleD.js";import{T as _}from"./trash-2-Dj_If1Zn.js";import{P as ke}from"./phone-BlyPoB6i.js";import{S as Fe}from"./send-DboPqPcs.js";import"./vendor-Dazix4UH.js";import"./index-BdQq_4o_.js";import"./index-DHzxUTm5.js";import"./chevron-down-DeDu0PPf.js";const Ze=()=>{const{isConnected:E}=fe(),{user:ne}=ge(),[r,U]=n.useState(null),[u,z]=n.useState(""),[w,le]=n.useState(""),[b,R]=n.useState([]),[ce,x]=n.useState([]),[$,L]=n.useState(!0),[v,O]=n.useState(!1),[y,oe]=n.useState("all"),[f,C]=n.useState([]),[N,B]=n.useState(!1),[Ie,De]=n.useState(!1),[de,Pe]=n.useState(!1),V=n.useRef(null),H=n.useRef(null);je({refreshConversations:()=>{console.log("Conversations updated via realtime"),g()},onNewMessage:s=>{console.log("New message received:",s),r&&s.conversationId===r&&x(t=>[...t,s]),g()},onMessageRead:s=>{console.log("Message read:",s),g()}});const g=async()=>{try{L(!0);const s=await d.getConversations({status:y!=="all"?y:void 0,limit:50});R(s.conversations)}catch(s){console.error("Failed to load conversations:",s),j({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{L(!1)}},me=async s=>{try{x([]);const t=await d.getConversationMessages(s,1,50,!0);t&&(x(t.messages),await d.updateActiveStatus(s,"online"),g())}catch(t){console.error("Failed to load messages:",t)}};n.useEffect(()=>{g()},[y]),n.useEffect(()=>{r?me(r):x([])},[r]);const c=b.find(s=>(s.id||s._id)===r),K=async()=>{if(!(!u.trim()&&f.length===0)){if(!r){console.error("No conversation selected");return}try{O(!0);let s=[];if(f.length>0){B(!0);for(const l of f)try{const o=await d.uploadAttachment(l);s.push(o)}catch(o){console.error(`Failed to upload ${l.name}:`,o)}B(!1)}if(!r||!c)throw new Error("No conversation selected");const t=r,a=c.otherUser._id;await d.updateActiveStatus(t,"online");const i=await d.sendMessage(t,u.trim(),a,s);x(l=>[...l,i]),z(""),C([]),g()}catch(s){console.error("Failed to send message:",s)}finally{O(!1)}}},xe=async()=>{r&&await d.updateActiveStatus(r,"typing")},Q=async()=>{r&&await d.updateActiveStatus(r,"online")};n.useEffect(()=>{let s;return u.trim()?(xe(),s&&clearTimeout(s),s=setTimeout(()=>{Q()},2e3)):Q(),()=>{s&&clearTimeout(s)}},[u]),n.useEffect(()=>()=>{r&&d.updateActiveStatus(r,"offline")},[r]);const q=(s,t)=>{const a=s.target.files;if(!a)return;const i=Array.from(a),l=[];for(const o of i){if(o.size>10*1024*1024){j({title:"File too large",description:`${o.name} exceeds 10MB limit`,variant:"destructive"});continue}if(t==="image"){if(!o.type.startsWith("image/")){j({title:"Invalid file type",description:`${o.name} is not an image`,variant:"destructive"});continue}}else if(!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(o.type)){j({title:"Invalid file type",description:`${o.name} is not a supported document type`,variant:"destructive"});continue}l.push(o)}C(o=>[...o,...l]),s.target&&(s.target.value="")},he=s=>{C(t=>t.filter((a,i)=>i!==s))},W=async s=>{if(window.confirm("Are you sure you want to delete this conversation? This action cannot be undone."))try{await d.deleteConversation(s),R(t=>t.filter(a=>(a.id||a._id)!==s)),r===s&&(U(null),x([])),j({title:"Success",description:"Conversation deleted successfully!"})}catch(t){console.error("Failed to delete conversation:",t)}},pe=async s=>{if(window.confirm("Are you sure you want to delete this message? This action cannot be undone."))try{await d.deleteMessage(s),x(t=>t.filter(a=>a._id!==s)),j({title:"Success",description:"Message deleted successfully!"})}catch(t){console.error("Failed to delete message:",t)}},h=s=>s.otherUser||{_id:"",name:"Unknown User",email:""},X=b.filter(s=>{const a=h(s).name||"",i=s.property?.title||"";return a.toLowerCase().includes(w.toLowerCase())||i.toLowerCase().includes(w.toLowerCase())});return e.jsxs("div",{className:"space-y-6 pt-16",children:[e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${E?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-sm text-muted-foreground",children:E?"Real-time messaging active":"Offline mode"})]}),$&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(D,{className:"w-4 h-4 animate-spin"}),"Loading conversations..."]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(M,{className:"w-8 h-8 text-primary"}),"Messages"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Communicate with property agents and owners"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(Ce,{value:y,onValueChange:oe,children:[e.jsx(Se,{className:"w-[180px]",children:e.jsx(Me,{placeholder:"Filter by status"})}),e.jsxs(Ae,{children:[e.jsx(I,{value:"all",children:"All Messages"}),e.jsx(I,{value:"unread",children:"Unread"}),e.jsx(I,{value:"read",children:"Read"})]})]})})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6 h-[calc(100vh-12rem)]",children:[e.jsxs(Y,{className:"lg:col-span-1",children:[e.jsxs(G,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ue,{className:"text-lg",children:"Conversations"}),e.jsx(A,{variant:"secondary",children:b.length})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Ne,{type:"text",placeholder:"Search conversations...",className:"pl-10",value:w,onChange:s=>le(s.target.value)})]})]}),e.jsx(S,{className:"p-0",children:e.jsx(te,{className:"h-[calc(100vh-20rem)]",children:e.jsx("div",{className:"space-y-1 p-3",children:$?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(D,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):X.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(M,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Start by sending a message to a property"})]}):X.map(s=>{const a=h(s).name||"Unknown User",i=s.id||s._id||"";return e.jsx("div",{className:`group p-3 rounded-lg cursor-pointer transition-colors ${r===i?"bg-primary/10 border border-primary/20":"hover:bg-muted/50"}`,onClick:()=>U(i),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(J,{className:"w-12 h-12",children:[e.jsx(Z,{src:void 0}),e.jsx(ee,{children:a.split(" ").map(l=>l[0]).join("")})]}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white bg-green-500",title:"Online"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("p",{className:"font-semibold text-sm truncate",children:a})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:d.formatTime(s.lastMessage.createdAt)})]}),s.property&&e.jsx("p",{className:"text-xs text-primary font-medium mb-1 truncate",children:s.property.title}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.lastMessage.message}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[s.unreadCount>0&&e.jsx(A,{className:"bg-primary text-white text-xs px-2 py-1",children:s.unreadCount}),e.jsxs(T,{children:[e.jsx(k,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:l=>l.stopPropagation(),children:e.jsx(P,{className:"w-3 h-3"})})}),e.jsxs(F,{align:"end",children:[e.jsxs(p,{children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(p,{children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"Archive"]}),e.jsxs(p,{className:"text-red-600 focus:text-red-600",onClick:l=>{l.stopPropagation(),W(i)},children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]})]})},i)})})})})]}),e.jsx(Y,{className:"lg:col-span-2",children:c?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"pb-3 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(J,{className:"w-10 h-10",children:[e.jsx(Z,{src:void 0}),e.jsx(ee,{children:h(c).name.split(" ").map(s=>s[0]).join("")})]}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-white bg-green-500",title:"Online"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h3",{className:"font-semibold",children:h(c).name})}),c.property&&e.jsx("p",{className:"text-sm text-muted-foreground",children:c.property.title})]})]}),e.jsxs("div",{className:"flex gap-2",children:[h(c).phone&&e.jsx(m,{size:"sm",variant:"outline",asChild:!0,children:e.jsx("a",{href:`tel:${h(c).phone}`,children:e.jsx(ke,{className:"w-4 h-4"})})}),e.jsxs(T,{children:[e.jsx(k,{asChild:!0,children:e.jsx(m,{size:"sm",variant:"outline",children:e.jsx(P,{className:"w-4 h-4"})})}),e.jsxs(F,{align:"end",children:[e.jsxs(p,{children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(p,{children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"Archive Conversation"]}),e.jsxs(p,{className:"text-red-600 focus:text-red-600",onClick:()=>W(r),children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]})}),c.property&&e.jsx("div",{className:"px-6 py-3 bg-muted/30 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:c.property.title})]}),e.jsxs("span",{className:"text-sm font-semibold text-primary",children:["â‚¹",c.property.price.toLocaleString("en-IN")]})]})}),e.jsxs(S,{className:"p-0",children:[e.jsx(te,{className:"h-[calc(100vh-28rem)] p-4",children:e.jsxs("div",{className:"space-y-4",children:[ce.map(s=>{const t=typeof s.sender=="string"?s.sender:s.sender._id,a=ne?.id===t;return e.jsx("div",{className:`group flex ${a?"justify-end":"justify-start"} hover:bg-muted/30 rounded-lg p-1 transition-colors`,children:e.jsxs("div",{className:`max-w-[70%] p-3 rounded-lg ${a?"bg-primary text-primary-foreground":"bg-muted"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:s.attachments.map((i,l)=>e.jsx("div",{children:i.type==="image"?e.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:i.url,alt:i.name,className:"max-w-full rounded border border-border cursor-pointer hover:opacity-90",style:{maxHeight:"200px"}})}):e.jsxs("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 p-2 rounded border ${a?"border-primary-foreground/20 hover:bg-primary-foreground/10":"border-border bg-background hover:bg-muted"}`,children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm truncate",children:i.name})]})},l))}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs opacity-70",children:d.formatTime(s.createdAt)}),a&&e.jsx(A,{variant:"outline",className:"text-xs px-1 py-0",children:"You"})]}),e.jsx("div",{className:"flex items-center gap-1",children:a&&e.jsxs(e.Fragment,{children:[s.read?e.jsx(ie,{className:"w-3 h-3 text-blue-500"}):e.jsx(ie,{className:"w-3 h-3 text-gray-400"}),e.jsxs(T,{children:[e.jsx(k,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-50 group-hover:opacity-100 transition-opacity hover:bg-destructive/10",title:"Message options",children:e.jsx(P,{className:"w-3 h-3"})})}),e.jsx(F,{align:"end",children:e.jsxs(p,{className:"text-red-600 focus:text-red-600",onClick:()=>pe(s._id),children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Delete Message"]})})]})]})})]})]})},s._id)}),de&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-muted p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:[h(c).name," is typing..."]})]})})})]})}),e.jsxs("div",{className:"p-4 border-t",children:[f.length>0&&e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:f.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2 bg-muted px-3 py-2 rounded-lg",children:[e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name}),e.jsx(m,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>he(t),children:e.jsx(we,{className:"w-3 h-3"})})]},t))}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("input",{ref:V,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:s=>q(s,"document"),multiple:!0}),e.jsx("input",{ref:H,type:"file",className:"hidden",accept:"image/*",onChange:s=>q(s,"image"),multiple:!0}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>V.current?.click(),disabled:N||v,title:"Attach document",children:e.jsx(re,{className:"w-4 h-4"})}),e.jsx(m,{size:"sm",variant:"outline",onClick:()=>H.current?.click(),disabled:N||v,title:"Attach image",children:e.jsx(Te,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1",children:e.jsx(be,{placeholder:"Type your message...",value:u,onChange:s=>z(s.target.value),onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),K())},className:"min-h-[40px] resize-none",disabled:v||N})}),e.jsx(m,{onClick:K,disabled:!u.trim()&&f.length===0||v||N,children:v||N?e.jsx(D,{className:"w-4 h-4 animate-spin"}):e.jsx(Fe,{className:"w-4 h-4"})})]})]})]})]}):e.jsx(S,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the left to start messaging"})]})})})]})]})};export{Ze as default};
