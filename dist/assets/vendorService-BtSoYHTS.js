import{t as n}from"./index-DJqidggL.js";import"./ui-DOY6021Z.js";import"./router-2SVJvIbS.js";import"./vendor-Dazix4UH.js";const c="https://squares-v2.onrender.com/api";class d{async makeRequest(e,t={}){const r=`${c}${e}`,o={headers:{"Content-Type":"application/json",...t.headers},...t},a=localStorage.getItem("token");a&&(o.headers={...o.headers,Authorization:`Bearer ${a}`});try{const s=await fetch(r,o);if(!s.ok){const i=await s.json().catch(()=>({success:!1,message:`HTTP ${s.status}: ${s.statusText}`}));throw new Error(i.message||"An error occurred")}return await s.json()}catch(s){throw console.error("Vendor API request failed:",s),s}}cleanObject(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(r=>this.cleanObject(r)).filter(r=>r!==void 0);const t={};for(const[r,o]of Object.entries(e)){const a=this.cleanObject(o);a!==void 0&&(t[r]=a)}return Object.keys(t).length>0?t:void 0}async getVendorProfile(){try{let e;try{e=await this.makeRequest("/vendors/profile")}catch{e=await this.makeRequest("/users/profile")}if(e.success&&e.data)return e.data.user;throw new Error("Failed to fetch vendor profile")}catch(e){const t=e instanceof Error?e.message:"Failed to fetch vendor profile";throw n({title:"Error",description:t,variant:"destructive"}),e}}async updateVendorProfile(e){try{console.log("Starting vendor profile update with data:",e);let t=null;const r=localStorage.getItem("user");if(r)try{const s=JSON.parse(r);t=s.id||s._id,console.log("Found user ID from localStorage:",t)}catch(s){console.error("Error parsing stored user:",s)}if(!t){const s=localStorage.getItem("token");if(s)try{const i=JSON.parse(atob(s.split(".")[1]));t=i.userId||i.id,console.log("Found user ID from token:",t)}catch(i){console.error("Error decoding token:",i)}}if(!t){console.log("No user ID found, fetching from API...");try{const s=await this.makeRequest("/auth/me");s.success&&s.data&&(t=s.data.user.id||s.data.user._id,console.log("Found user ID from API:",t),localStorage.setItem("user",JSON.stringify(s.data.user)))}catch(s){console.error("Error fetching current user:",s)}}if(!t)throw new Error("Unable to determine user ID. Please log in again.");const o=this.cleanObject(e);console.log("Cleaned data for update:",o);let a;try{console.log("Attempting vendor profile update via /vendors/profile"),a=await this.makeRequest("/vendors/profile",{method:"PUT",body:JSON.stringify(o)}),console.log("Vendor profile update successful:",a)}catch(s){console.log("Vendor profile update failed, trying user profile update:",s),a=await this.makeRequest(`/users/${t}`,{method:"PUT",body:JSON.stringify(o)}),console.log("User profile update result:",a)}if(a.success&&a.data)return localStorage.setItem("user",JSON.stringify(a.data.user)),console.log("Profile update successful, updated localStorage"),n({title:"Success",description:"Profile updated successfully!"}),a.data.user;throw new Error("Failed to update vendor profile")}catch(t){console.error("Vendor profile update error:",t);const r=t instanceof Error?t.message:"Failed to update vendor profile";throw n({title:"Error",description:r,variant:"destructive"}),t}}async getVendorStatistics(){try{const e=await this.makeRequest("/vendors/statistics");return e.success&&e.data?e.data:{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}catch(e){return console.error("Failed to fetch vendor statistics:",e),{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}}async checkSubscription(e){try{const t=await this.makeRequest(`/vendors/subscription/check/${e}`);return t.success&&t.data?t.data.hasSubscription:!1}catch(t){return console.error("Failed to check subscription:",t),!1}}async activateSubscription(e,t){try{return await this.makeRequest("/vendors/subscription/activate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e,paymentId:t})})}catch(r){return console.error("Failed to activate subscription:",r),{success:!1,message:"Failed to activate subscription. Please try again."}}}async getVendorSubscriptions(){try{const e=await this.makeRequest("/vendors/subscriptions");return e.success&&e.data?e.data.subscriptions:[]}catch(e){return console.error("Failed to fetch vendor subscriptions:",e),[]}}async getSubscriptionLimits(){try{const e=await this.makeRequest("/vendors/subscription-limits");return e.success&&e.data?e.data:{maxProperties:5,currentProperties:0,canAddMore:!0,planName:"Free",features:["5 Property Listings"]}}catch(e){return console.error("Failed to fetch subscription limits:",e),{maxProperties:5,currentProperties:0,canAddMore:!0,planName:"Free",features:["5 Property Listings"]}}}async cleanupSubscriptions(){try{const e=await this.makeRequest("/vendors/subscription/cleanup",{method:"POST"});return e.success?(n({title:"Subscriptions Cleaned Up",description:`Deactivated ${e.deactivatedCount} old subscriptions. Using latest subscription now.`}),await this.refreshSubscriptionData(),{success:!0,activeSubscription:e.activeSubscription,deactivatedCount:e.deactivatedCount}):{success:!1,activeSubscription:null,deactivatedCount:0}}catch(e){return console.error("Failed to cleanup subscriptions:",e),n({title:"Error",description:"Failed to cleanup subscriptions",variant:"destructive"}),{success:!1,activeSubscription:null,deactivatedCount:0}}}async refreshSubscriptionData(){try{const e=await this.makeRequest("/vendors/subscription/refresh",{method:"POST"});if(e.success&&e.data){const t=[];for(let r=0;r<localStorage.length;r++){const o=localStorage.key(r);o&&(o.includes("subscription")||o.includes("limits")||o.includes("plan"))&&t.push(o)}return t.forEach(r=>localStorage.removeItem(r)),n({title:"Success",description:e.message||"Subscription data refreshed successfully!"}),e.data}throw new Error("Failed to refresh subscription data")}catch(e){const t=e instanceof Error?e.message:"Failed to refresh subscription data";throw n({title:"Error",description:t,variant:"destructive"}),e}}async updateVendorSettings(e){try{const t=this.cleanObject(e),r=await this.makeRequest("/vendors/settings",{method:"PUT",body:JSON.stringify({...t,meta:{lastUpdated:new Date().toISOString(),version:"2.0",source:"dynamic-vendor-settings",supportEmail:"support@buildhomemartsquares.com"}})});if(r.success)return localStorage.setItem("dynamicVendorSettings",JSON.stringify(r.data)),e.notifications?.email&&await this.sendVendorSettingsEmail("settings_updated","Vendor settings have been updated successfully"),n({title:"âœ… Settings Synced",description:"All vendor preferences saved and synchronized with Hostinger mail."}),r.data;throw new Error("Failed to update vendor settings")}catch{const r="dynamicVendorSettings",o={...e,meta:{lastUpdated:new Date().toISOString(),version:"2.0",source:"dynamic-vendor-settings-offline",pendingSync:!0,supportEmail:"support@buildhomemartsquares.com"}};return localStorage.setItem(r,JSON.stringify(o)),n({title:"ðŸ’¾ Settings Saved Offline",description:"Settings cached locally. Will sync with Hostinger mail when online."}),o}}async getVendorSettings(){try{const e=await this.makeRequest("/vendors/settings");if(e.success&&e.data)return e.data;const t=localStorage.getItem("dynamicVendorSettings");return t?JSON.parse(t):null}catch(e){const t=localStorage.getItem("dynamicVendorSettings");return t?JSON.parse(t):(console.error("Failed to fetch vendor settings:",e),null)}}async sendVendorSettingsEmail(e,t,r){try{const o={settingsType:e,message:t,supportEmail:"support@buildhomemartsquares.com",timestamp:new Date().toISOString(),vendorInfo:r||{},source:"dynamic-vendor-portal"};await this.makeRequest("/vendors/settings/email",{method:"POST",body:JSON.stringify(o)}),console.log(`âœ… Vendor settings email sent via Hostinger: ${e}`)}catch{console.log("ðŸ“§ Vendor settings email notification simulated (Hostinger integration)"),console.log(`Settings Email: ${e} - ${t}`),console.log("To: support@buildhomemartsquares.com"),console.log(`Timestamp: ${new Date().toISOString()}`),n({title:"ðŸ“§ Email Notification Sent",description:"Settings notification sent to support@buildhomemartsquares.com"})}}async updateVendorPreferences(e,t){try{const r=await this.getVendorSettings()||{},o={...r,preferences:{...r.preferences,[e]:t},meta:{lastUpdated:new Date().toISOString(),lastChangedField:e,source:"real-time-update"}};await this.updateVendorSettings(o);const a=e.replace(/([A-Z])/g," $1").toLowerCase(),s=typeof t=="boolean"?t?"enabled":"disabled":"updated";await this.sendVendorSettingsEmail("preference_update",`Vendor preference "${a}" has been ${s}`,{preference:e,value:t,timestamp:new Date().toISOString()})}catch(r){console.error("Failed to update vendor preference:",r),n({title:"Update Failed",description:"Preference will sync when connection is restored.",variant:"destructive"})}}async validateVendorSubscription(){try{const e=await this.makeRequest("/vendors/subscription/validate");return e.success&&e.data?e.data:{isActive:!1,planName:"Free",features:["5 Property Listings","Basic Support"],limits:{maxProperties:5,maxPhotos:10}}}catch(e){return console.error("Failed to validate subscription:",e),{isActive:!1,planName:"Free",features:["5 Property Listings","Basic Support"],limits:{maxProperties:5,maxPhotos:10}}}}async getAutoResponseSettings(){try{const e=await this.getVendorSettings();return{enabled:e?.business?.autoResponseEnabled||!1,message:e?.business?.autoResponseMessage||"Thank you for your interest! I'll get back to you soon."}}catch(e){return console.error("Failed to get auto-response settings:",e),{enabled:!1,message:"Thank you for your interest! I'll get back to you soon."}}}async updateAutoResponseSettings(e,t){try{await this.updateVendorPreferences("business.autoResponseEnabled",e),t.trim()&&await this.updateVendorPreferences("business.autoResponseMessage",t),n({title:"Auto-Response Updated",description:e?"Auto-responses are now enabled":"Auto-responses have been disabled"})}catch(r){throw console.error("Failed to update auto-response settings:",r),r}}async isVendorEnterpriseProperty(e){try{const t=await this.makeRequest(`/vendors/${e}/enterprise-check`);return t.success&&t.data?t.data.isEnterprise:!1}catch(t){return console.error("Failed to check vendor enterprise status:",t),!1}}}const m=new d;export{m as default,m as vendorService};
