import{t,c as e,d as n,f as o,a,g as r,e as i,h as s,i as c}from"./en-US-Blz_tpgH.js";import{r as u}from"./router-Bi51YGN-.js";import{u as f,q as d,t as l}from"./index-B494FSRu.js";function h(e,n){const o=t(e),a=t(n),r=o.getTime()-a.getTime();return r<0?-1:r>0?1:r}function m(e){const o=t(e);return+function(e){const n=t(e);return n.setHours(23,59,59,999),n}(o)===+n(o)}function w(e,n,o){const a=function(e,n){return+t(e)-+t(n)}(e,n)/1e3;return(r=o?.roundingMethod,t=>{const e=(r?Math[r]:Math.trunc)(t);return 0===e?0:e})(a);var r}function p(e,n,u){const f=r(),d=u?.locale??f.locale??i,l=h(e,n);if(isNaN(l))throw new RangeError("Invalid time value");const p=Object.assign({},u,{addSuffix:u?.addSuffix,comparison:l});let y,T;l>0?(y=t(n),T=t(e)):(y=t(e),T=t(n));const S=w(T,y),g=(a(T)-a(y))/1e3,N=Math.round((S-g)/60);let v;if(N<2)return u?.includeSeconds?S<5?d.formatDistance("lessThanXSeconds",5,p):S<10?d.formatDistance("lessThanXSeconds",10,p):S<20?d.formatDistance("lessThanXSeconds",20,p):S<40?d.formatDistance("halfAMinute",0,p):S<60?d.formatDistance("lessThanXMinutes",1,p):d.formatDistance("xMinutes",1,p):0===N?d.formatDistance("lessThanXMinutes",1,p):d.formatDistance("xMinutes",N,p);if(N<45)return d.formatDistance("xMinutes",N,p);if(N<90)return d.formatDistance("aboutXHours",1,p);if(N<s){const t=Math.round(N/60);return d.formatDistance("aboutXHours",t,p)}if(N<2520)return d.formatDistance("xDays",1,p);if(N<c){const t=Math.round(N/s);return d.formatDistance("xDays",t,p)}if(N<2*c)return v=Math.round(N/c),d.formatDistance("aboutXMonths",v,p);if(v=function(e,n){const a=t(e),r=t(n),i=h(a,r),s=Math.abs(o(a,r));let c;if(s<1)c=0;else{1===a.getMonth()&&a.getDate()>27&&a.setDate(30),a.setMonth(a.getMonth()-i*s);let n=h(a,r)===-i;m(t(e))&&1===s&&1===h(e,r)&&(n=!1),c=i*(s-Number(n))}return 0===c?0:c}(T,y),v<12){const t=Math.round(N/c);return d.formatDistance("xMonths",t,p)}{const t=v%12,e=Math.trunc(v/12);return t<3?d.formatDistance("aboutXYears",e,p):t<9?d.formatDistance("overXYears",e,p):d.formatDistance("almostXYears",e+1,p)}}function y(t,n){return p(t,function(t){return e(t,Date.now())}(t),n)}const T=()=>{const[t,e]=u.useState(!1),[n,o]=u.useState([]),[a,r]=u.useState(null),i=u.useRef(null),s=u.useRef(new Set),{user:c}=f(),h=()=>{const t=d.getToken();if(!c||!t||i.current)return;const n=`https://api.buildhomemartsquares.com/api/notifications/stream?token=${encodeURIComponent(t)}`,a=new EventSource(n);a.onopen=()=>{e(!0)},a.onmessage=t=>{try{const e=JSON.parse(t.data),n=`${e.type}-${e.timestamp}-${e.userId}`;if(s.current.has(n))return;if("connection"===e.type)return;if(s.current.add(n),s.current.size>100){const t=Array.from(s.current)[0];s.current.delete(t)}w(e),o(t=>[e,...t].slice(0,20))}catch(e){}},a.onerror=()=>{e(!1),i.current===a&&(a.close(),i.current=null),setTimeout(()=>{const t=d.getToken();c&&t&&!i.current&&h()},5e3)},i.current=a},m=()=>{i.current&&(i.current.close(),i.current=null,e(!1))},w=t=>{const e=p(t);if(e.showToast&&l({title:t.title,description:t.message,variant:e.variant,duration:e.duration}),e.playSound){!1!==c?.profile?.preferences?.notifications?.sound&&y()}e.showBrowserNotification&&"granted"===Notification.permission&&new Notification(t.title,{body:t.message,icon:"/favicon.png",tag:t.type})},p=t=>{const e={property_alert:{showToast:!0,variant:"default",duration:5e3,playSound:!0,showBrowserNotification:!0},price_alert:{showToast:!0,variant:"default",duration:6e3,playSound:!0,showBrowserNotification:!0},new_message:{showToast:!0,variant:"default",duration:4e3,playSound:!0,showBrowserNotification:!0},service_update:{showToast:!0,variant:"default",duration:5e3,playSound:!1,showBrowserNotification:!0},property_update:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!1},broadcast:{showToast:!0,variant:"default",duration:8e3,playSound:!1,showBrowserNotification:!0},announcement:{showToast:!0,variant:"default",duration:8e3,playSound:!1,showBrowserNotification:!0},lead_alert:{showToast:!0,variant:"default",duration:6e3,playSound:!0,showBrowserNotification:!0},inquiry_received:{showToast:!0,variant:"default",duration:5e3,playSound:!0,showBrowserNotification:!0},weekly_report:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!0},business_update:{showToast:!0,variant:"default",duration:5e3,playSound:!1,showBrowserNotification:!0},default:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!1}};return e[t.type]||e.default},y=()=>{try{const t=new Audio("/mixkit-software-interface-start-2574.wav");t.volume=.6,t.play().catch(t=>{try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.frequency.value=800,e.type="sine",n.gain.setValueAtTime(.3,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),e.start(t.currentTime),e.stop(t.currentTime+.5)}catch(e){}})}catch(t){}};return u.useEffect(()=>{const t=d.getToken();return c&&t&&!i.current&&h(),()=>{m()}},[c]),u.useEffect(()=>()=>{m()},[]),{isConnected:t,notifications:n,stats:a,connect:h,disconnect:m,sendTestNotification:async()=>{const t=d.getToken();if(t)try{const e="https://api.buildhomemartsquares.com/api";if(!(await fetch(`${e}/notifications/test`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include",body:JSON.stringify({type:"test",message:"This is a test notification from the real-time system!"})})).ok)throw new Error("Failed to send test notification")}catch(e){l({title:"Error",description:"Failed to send test notification",variant:"destructive"})}},getNotificationStats:async()=>{const t=d.getToken();if(t)try{const e="https://api.buildhomemartsquares.com/api",n=await fetch(`${e}/notifications/stats`,{method:"GET",headers:{Authorization:`Bearer ${t}`},credentials:"include"});if(!n.ok)throw new Error("Failed to fetch notification stats");const o=await n.json();return r(o.data),o.data}catch(e){return null}},clearNotifications:()=>{o([]),s.current.clear()},markAsRead:t=>{o(e=>e.map(e=>e.timestamp===t?{...e,read:!0}:e))},requestNotificationPermission:async()=>{if("Notification"in window&&"default"===Notification.permission){return"granted"===await Notification.requestPermission()}return"granted"===Notification.permission}}};export{y as f,T as u};
