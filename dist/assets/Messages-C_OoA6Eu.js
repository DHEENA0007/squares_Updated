import{j as e}from"./ui-CEFKCYQo.js";import{r as s}from"./router-Bi51YGN-.js";import{a3 as a,u as t,a4 as r,t as i,a5 as n,S as l,r as c,s as d,v as o,w as m,a as x,b as h,c as p,B as u,Q as j,I as f,e as g,G as v,a6 as N,a7 as y,a8 as w,a9 as b,aa as C,f as S,ab as k,ac as A,ad as M,A as _,y as z,P as I,i as T,k as U,h as E,X as P,T as D}from"./index-DbnZmv1f.js";import{S as R}from"./scroll-area-CB9icgFC.js";import{m as L}from"./messageService-D7x-Sweu.js";import{u as F}from"./use-mobile-WsBtvUz6.js";import{E as $}from"./ellipsis-vertical-iVuKNVWh.js";import{A as B,C as O}from"./check-check-DGaNXFFE.js";import{T as K}from"./trash-2-HWhiIvIZ.js";import{P as H}from"./paperclip-CAE9qruf.js";import{I as V}from"./image-BbaG3H-c.js";import{S as G}from"./send-DQkUHG4H.js";import"./vendor-eVk5PToZ.js";import"./uploadService-Bwy6d1dt.js";const J=()=>{const{isConnected:J}=a(),{user:Q}=t(),W=F(),[Y,q]=s.useState(null),[X,Z]=s.useState(""),[ee,se]=s.useState(""),[ae,te]=s.useState([]),[re,ie]=s.useState([]),[ne,le]=s.useState(!0),[ce,de]=s.useState(!1),[oe,me]=s.useState("all"),[xe,he]=s.useState([]),[pe,ue]=s.useState(!1),[je,fe]=s.useState(!1),[ge,ve]=s.useState(!1),[Ne,ye]=s.useState({}),[we,be]=s.useState({}),[Ce,Se]=s.useState(!0),ke=s.useRef(null),Ae=s.useRef(null);s.useRef(null),s.useRef(null),s.useRef(null),r({refreshConversations:()=>{Me()},onNewMessage:e=>{e.conversationId===Y&&_e(Y),Me()},onMessageRead:e=>{e.conversationId===Y&&_e(Y)}});const Me=async()=>{try{le(!0);const e=await L.getConversations({status:"all"!==oe?oe:void 0,limit:50});te(e.conversations)}catch(e){i({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{le(!1)}},_e=async e=>{try{ie([]);const s=await L.getConversationMessages(e,1,50,!0);s&&(ie(s.messages),await L.updateActiveStatus(e,"online"),Me())}catch(s){}},ze=async()=>{const e={};for(const a of ae)try{const s=await L.getUserStatus(a.otherUser._id);e[a.otherUser._id]=s}catch(s){}ye(e)};s.useEffect(()=>{Me()},[oe]),s.useEffect(()=>{Y?(_e(Y),W&&Se(!1)):ie([])},[Y]),s.useEffect(()=>{if(ae.length>0){ze();const e=setInterval(()=>{ze()},3e4);return()=>clearInterval(e)}},[ae]);const Ie=ae.find(e=>(e.id||e._id)===Y),Te=async()=>{if((X.trim()||0!==xe.length)&&Y)try{de(!0);const s=[];if(xe.length>0){ue(!0);for(const a of xe)try{const e=await L.uploadAttachment(a);s.push(e)}catch(e){}ue(!1)}if(!Y||!Ie)throw new Error("No conversation selected");const a=Y,t=Ie.otherUser._id;await L.updateActiveStatus(a,"online");const r=X.trim()||(s.length>0?"[Attachment]":""),i=await L.sendMessage(a,r,t,s);ie(e=>[...e,i]),Z(""),he([]),Me()}catch(e){}finally{de(!1)}},Ue=async()=>{Y&&await L.updateActiveStatus(Y,"online")};s.useEffect(()=>{let e;return X.trim()?((async()=>{Y&&await L.updateActiveStatus(Y,"typing")})(),e&&clearTimeout(e),e=setTimeout(()=>{Ue()},2e3)):Ue(),()=>{e&&clearTimeout(e)}},[X]),s.useEffect(()=>()=>{Y&&L.updateActiveStatus(Y,"offline")},[Y]);const Ee=(e,s)=>{const a=e.target.files;if(!a)return;const t=Array.from(a),r=[];for(const n of t)if(n.size>10485760)i({title:"File too large",description:`${n.name} exceeds 10MB limit`,variant:"destructive"});else{if("image"===s){if(!n.type.startsWith("image/")){i({title:"Invalid file type",description:`${n.name} is not an image`,variant:"destructive"});continue}}else{if(!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(n.type)){i({title:"Invalid file type",description:`${n.name} is not a supported document type`,variant:"destructive"});continue}}r.push(n)}he(e=>[...e,...r]),e.target&&(e.target.value="")},Pe=async e=>{if(window.confirm("Are you sure you want to delete this conversation? This action cannot be undone."))try{await L.deleteConversation(e),te(s=>s.filter(s=>(s.id||s._id)!==e)),Y===e&&(q(null),ie([])),i({title:"Success",description:"Conversation deleted successfully!"})}catch(s){}},De=e=>e.otherUser||{_id:"",name:"Unknown User",email:""},Re=ae.filter(e=>{const s=De(e).name||"",a=e.property?.title||"";return s.toLowerCase().includes(ee.toLowerCase())||a.toLowerCase().includes(ee.toLowerCase())});return e.jsxs("div",{className:"flex flex-col h-screen pt-16",children:[e.jsx("div",{className:"flex-shrink-0 px-6 py-4 border-b bg-background",children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(n,{className:"w-8 h-8 text-primary"}),"Messages"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Communicate with property agents and owners"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(l,{value:oe,onValueChange:me,children:[e.jsx(c,{className:"w-[180px]",children:e.jsx(d,{placeholder:"Filter by status"})}),e.jsxs(o,{children:[e.jsx(m,{value:"all",children:"All Messages"}),e.jsx(m,{value:"unread",children:"Unread"}),e.jsx(m,{value:"read",children:"Read"})]})]})})]})}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsxs(x,{className:"flex flex-col "+(W?Ce?"flex":"hidden":"w-1/3 border-r"),children:[e.jsxs(h,{className:"flex-shrink-0 pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(p,{className:"text-lg",children:"Conversations"}),e.jsx(u,{variant:"secondary",children:ae.length})]}),e.jsxs("div",{className:"relative",children:[e.jsx(j,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(f,{type:"text",placeholder:"Search conversations...",className:"pl-10",value:ee,onChange:e=>se(e.target.value)})]})]}),e.jsx(g,{className:"flex-1 p-0 overflow-hidden",children:e.jsx(R,{className:"h-full",children:e.jsx("div",{className:"space-y-1 p-3",children:ne?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(v,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):0===Re.length?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(n,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Start by sending a message to a property"})]}):Re.map(s=>{const a=De(s),t=a.name||"Unknown User",r=s.id||s._id||"";return e.jsx("div",{className:"group p-3 rounded-lg cursor-pointer transition-colors "+(Y===r?"bg-primary/10 border border-primary/20":"hover:bg-muted/50"),onClick:()=>q(r),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"relative",children:e.jsxs(N,{className:"w-12 h-12",children:[e.jsx(y,{src:void 0}),e.jsx(w,{children:t.split(" ").map(e=>e[0]).join("")})]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-semibold text-sm truncate",children:t}),Ne[a._id]?.isOnline&&e.jsx("span",{className:"text-[10px] text-green-600 font-medium",children:"● Online"})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:L.formatTime(s.lastMessage.createdAt)})]}),s.property&&e.jsx("p",{className:"text-xs text-primary font-medium mb-1 truncate",children:s.property.title}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.lastMessage.message}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[s.unreadCount>0&&e.jsx(u,{className:"bg-primary text-white text-xs px-2 py-1",children:s.unreadCount}),e.jsxs(b,{children:[e.jsx(C,{asChild:!0,children:e.jsx(S,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:e=>e.stopPropagation(),children:e.jsx($,{className:"w-3 h-3"})})}),e.jsxs(k,{align:"end",children:[e.jsxs(A,{children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(A,{children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Archive"]}),e.jsxs(A,{className:"text-red-600 focus:text-red-600",onClick:e=>{e.stopPropagation(),Pe(r)},children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]})]})},r)})})})})]}),e.jsx(x,{className:"flex flex-col "+(W?Ce?"hidden":"flex":"flex-1"),children:Ie?e.jsxs(e.Fragment,{children:[e.jsxs(h,{className:"flex-shrink-0 pb-3 border-b",children:[W&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(S,{variant:"ghost",size:"sm",onClick:()=>Se(!0),className:"p-2",children:e.jsx(_,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-sm font-medium",children:"Back to Conversations"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"relative",children:e.jsxs(N,{className:"w-10 h-10",children:[e.jsx(y,{src:void 0}),e.jsx(w,{children:De(Ie).name.split(" ").map(e=>e[0]).join("")})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:De(Ie).name}),Ne[De(Ie)._id]?.isOnline&&e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"● Active now"})]}),Ie.property&&e.jsx("p",{className:"text-sm text-muted-foreground",children:Ie.property.title})]})]}),e.jsxs("div",{className:"flex gap-2",children:[De(Ie).phone?W?e.jsx(S,{size:"sm",variant:"outline",asChild:!0,children:e.jsx("a",{href:`tel:${De(Ie).phone}`,children:e.jsx(z,{className:"w-4 h-4"})})}):e.jsxs(I,{children:[e.jsx(T,{asChild:!0,children:e.jsx(S,{size:"sm",variant:"outline",title:"View phone number",children:e.jsx(z,{className:"w-4 h-4"})})}),e.jsx(U,{className:"w-auto p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Phone Number"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-lg font-semibold",children:De(Ie).phone}),e.jsx(S,{size:"sm",variant:"outline",onClick:()=>{navigator.clipboard.writeText(De(Ie).phone||""),i({title:"Copied!",description:"Phone number copied to clipboard"})},children:"Copy"})]})]})})]}):null,e.jsxs(b,{children:[e.jsx(C,{asChild:!0,children:e.jsx(S,{size:"sm",variant:"outline",children:e.jsx($,{className:"w-4 h-4"})})}),e.jsxs(k,{align:"end",children:[e.jsxs(A,{children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(A,{children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Archive Conversation"]}),e.jsxs(A,{className:"text-red-600 focus:text-red-600",onClick:()=>Pe(Y),children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]})]}),Ie.property&&e.jsx("div",{className:"flex-shrink-0 px-6 py-3 bg-muted/30 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:Ie.property.title})]}),e.jsxs("span",{className:"text-sm font-semibold text-primary",children:["₹",Ie.property.price.toLocaleString("en-IN")]})]})}),e.jsx(g,{className:"flex-1 p-0 overflow-hidden",children:e.jsx(R,{className:"h-full p-4",children:e.jsxs("div",{className:"space-y-4",children:[re.map(s=>{const a="string"==typeof s.sender?s.sender:s.sender._id,t=Q?.id===a;return e.jsx("div",{className:`group flex ${t?"justify-end":"justify-start"} hover:bg-muted/30 rounded-lg p-1 transition-colors`,children:e.jsxs("div",{className:"max-w-[70%] p-3 rounded-lg "+(t?"bg-primary text-primary-foreground":"bg-muted"),children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:s.attachments.map((s,a)=>e.jsx("div",{children:"image"===s.type?e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:s.url,alt:s.name,className:"max-w-full rounded border border-border cursor-pointer hover:opacity-90",style:{maxHeight:"200px"}})}):e.jsxs("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 rounded border "+(t?"border-primary-foreground/20 hover:bg-primary-foreground/10":"border-border bg-background hover:bg-muted"),children:[e.jsx(H,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm truncate",children:s.name})]})},a))}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs opacity-70",children:L.formatTime(s.createdAt)}),t&&e.jsx(u,{variant:"outline",className:"text-xs px-1 py-0",children:"You"})]}),e.jsx("div",{className:"flex items-center gap-1",children:t&&e.jsxs(e.Fragment,{children:[s.read?e.jsx(O,{className:"w-3 h-3 text-blue-500"}):e.jsx(O,{className:"w-3 h-3 text-gray-400"}),e.jsxs(b,{children:[e.jsx(C,{asChild:!0,children:e.jsx(S,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-50 group-hover:opacity-100 transition-opacity hover:bg-destructive/10",title:"Message options",children:e.jsx($,{className:"w-3 h-3"})})}),e.jsx(k,{align:"end",children:e.jsxs(A,{className:"text-red-600 focus:text-red-600",onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this message? This action cannot be undone."))try{await L.deleteMessage(e),ie(s=>s.filter(s=>s._id!==e)),i({title:"Success",description:"Message deleted successfully!"})}catch(s){}})(s._id),children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Delete Message"]})})]})]})})]})]})},s._id)}),ge&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-muted p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:[De(Ie).name," is typing..."]})]})})})]})})}),e.jsxs("div",{className:"flex-shrink-0 p-4 border-t",children:[xe.length>0&&e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:xe.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 bg-muted px-3 py-2 rounded-lg",children:[e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name}),e.jsx(S,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>(e=>{he(s=>s.filter((s,a)=>a!==e))})(a),children:e.jsx(P,{className:"w-3 h-3"})})]},a))}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("input",{ref:ke,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:e=>Ee(e,"document"),multiple:!0}),e.jsx("input",{ref:Ae,type:"file",className:"hidden",accept:"image/*",onChange:e=>Ee(e,"image"),multiple:!0}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(S,{size:"sm",variant:"outline",onClick:()=>ke.current?.click(),disabled:pe||ce,title:"Attach document",children:e.jsx(H,{className:"w-4 h-4"})}),e.jsx(S,{size:"sm",variant:"outline",onClick:()=>Ae.current?.click(),disabled:pe||ce,title:"Attach image",children:e.jsx(V,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1",children:e.jsx(D,{placeholder:"Type your message...",value:X,onChange:e=>Z(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Te())},className:"min-h-[40px] resize-none",disabled:ce||pe})}),e.jsx(S,{onClick:Te,disabled:!X.trim()&&0===xe.length||ce||pe,children:ce||pe?e.jsx(v,{className:"w-4 h-4 animate-spin"}):e.jsx(G,{className:"w-4 h-4"})})]})]})]}):e.jsx(g,{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(n,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the left to start messaging"})]})})})]})]})};export{J as default};
