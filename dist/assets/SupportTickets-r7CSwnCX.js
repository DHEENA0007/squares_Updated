import{j as e}from"./ui-s1SEoZIF.js";import{r as s}from"./router-D8v2YSKU.js";import{D as a,a2 as t,u as l,aQ as r,q as i,r as n,s as c,v as d,w as o,a as m,e as x,W as h,b as u,c as p,B as j,x as f,M as g,h as N,am as v,f as y,E as k,a4 as b,a5 as w,a6 as S,a7 as T,a8 as C,ae as _,L as A,T as F}from"./index-DvBXyKtT.js";import{s as B}from"./subAdminService-C-E5YIAJ.js";import{L as E}from"./lock-a8rc1irF.js";import{P as R}from"./paperclip-TrPEIYGf.js";import{A as z}from"./arrow-right-left-DAYlyu04.js";import{D as L}from"./download-BpA-30tD.js";import"./vendor-BxThA0WO.js";const P=a("LockOpen",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]]),$=()=>{const[a,$]=s.useState([]),[O,M]=s.useState(!0),[D,I]=s.useState("open"),[q,V]=s.useState(1),[U,J]=s.useState(1),[Q,W]=s.useState(null),[Y,G]=s.useState(!1),[H,K]=s.useState(!1),[X,Z]=s.useState(!1),[ee,se]=s.useState(""),[ae,te]=s.useState(!1),[le,re]=s.useState([]),[ie,ne]=s.useState([]),[ce,de]=s.useState("all"),[oe,me]=s.useState(""),{toast:xe}=t(),{user:he}=l();s.useEffect(()=>{ue()},[q,D]);const ue=async()=>{try{M(!0);const e=await B.getSupportTickets(q,10,D);$(e.tickets),J(e.totalPages)}catch(e){xe({title:"Error",description:e.message||"Failed to fetch support tickets",variant:"destructive"})}finally{M(!1)}};r("support_ticket_created",e=>{xe({title:"New Support Ticket",description:"A new support ticket has been created"}),ue()}),r("support_ticket_updated",e=>{ue()}),r("message_received",e=>{"support"===e.type&&ue()});const pe=e=>{switch(e){case"open":return"destructive";case"in_progress":return"default";case"resolved":return"secondary";default:return"outline"}},je=e=>{switch(e){case"urgent":case"high":return"destructive";case"medium":return"default";case"low":return"secondary";default:return"outline"}},fe=e=>{W(e),K(!0)},ge=async(e,s)=>{try{te(!0),await B.updateSupportTicket(e,s,""),xe({title:"Success",description:`Ticket marked as ${s.replace("_"," ")}`}),ue()}catch(a){423===a.status||a.message?.includes("locked")||a.message?.includes("being handled")?(xe({title:"Ticket Locked",description:a.message||"This ticket is currently being handled by another user",variant:"destructive"}),ue()):xe({title:"Error",description:a.message||"Failed to update ticket status",variant:"destructive"})}finally{te(!1)}},Ne=async()=>{try{const e=await fetch("/api/support/transfer-roles",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),s=await e.json();s.success?ne(s.data.roles||[]):xe({title:"Error",description:s.message||"Failed to fetch available roles",variant:"destructive"})}catch(e){xe({title:"Error",description:"Failed to fetch available roles",variant:"destructive"})}},ve=async e=>{try{const s=e&&"all"!==e?`/api/support/transfer-users?role=${e}`:"/api/support/transfer-users",a=await fetch(s,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),t=await a.json();t.success&&re(t.data.users)}catch(s){}},ye=le.filter(e=>"all"===ce||e.role===ce);return O&&0===a.length?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Support Tickets"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage customer support requests and complaints"})]}),e.jsx("div",{className:"animate-pulse space-y-4",children:[1,2,3].map(s=>e.jsx("div",{className:"h-32 bg-gray-200 rounded-lg"},s))})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Support Tickets"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage customer support requests and complaints"})]}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-4",children:e.jsxs(i,{value:D,onValueChange:I,children:[e.jsx(n,{className:"w-full sm:w-48",children:e.jsx(c,{placeholder:"Filter by status"})}),e.jsxs(d,{children:[e.jsx(o,{value:"open",children:"Open Tickets"}),e.jsx(o,{value:"in_progress",children:"In Progress"}),e.jsx(o,{value:"resolved",children:"Resolved"}),e.jsx(o,{value:"closed",children:"Closed"}),e.jsx(o,{value:"all",children:"All Tickets"})]})]})}),e.jsx("div",{className:"space-y-4",children:0===a.length?e.jsx(m,{children:e.jsxs(x,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(h,{className:"h-12 w-12 text-blue-500 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold",children:"No Support Tickets"}),e.jsx("p",{className:"text-muted-foreground text-center",children:"open"===D?"No open support tickets at the moment.":`No ${D} tickets found.`})]})}):a.map(s=>e.jsxs(m,{children:[e.jsx(u,{children:e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[e.jsxs(p,{className:"text-lg",children:[s.ticketNumber&&e.jsxs("span",{className:"text-muted-foreground mr-2",children:["#",s.ticketNumber]}),s.subject||"Support Request"]}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.jsx(j,{variant:pe(s.status),children:s.status.replace("_"," ")}),s.priority&&e.jsx(j,{variant:je(s.priority),children:s.priority}),s.category&&e.jsx(j,{variant:"outline",children:s.category})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(f,{className:"h-3 w-3 flex-shrink-0"}),e.jsxs("span",{className:"truncate",children:[s.sender.profile.firstName," ",s.sender.profile.lastName]})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(g,{className:"h-3 w-3 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.sender.email})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(N,{className:"h-3 w-3 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:new Date(s.createdAt).toLocaleDateString()})]})]}),s.lockedBy&&e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsx(E,{className:"h-3 w-3 text-orange-600"}),e.jsxs("span",{className:"text-orange-600 font-medium",children:["Being handled by ",s.lockedBy.profile?.firstName," ",s.lockedBy.profile?.lastName||s.lockedBy.email]})]}),s.assignedTo&&!s.lockedBy&&e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsx(P,{className:"h-3 w-3 text-blue-600"}),e.jsxs("span",{className:"text-blue-600",children:["Assigned to ",s.assignedTo.profile?.firstName," ",s.assignedTo.profile?.lastName||s.assignedTo.email]})]})]})]})})}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted p-3 sm:p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(v,{className:"h-4 w-4 mt-1 text-muted-foreground flex-shrink-0"}),e.jsx("p",{className:"text-sm leading-relaxed break-words",children:s.message})]}),s.attachments&&s.attachments.length>0&&e.jsxs("div",{className:"flex items-center gap-1 mt-2 text-xs text-muted-foreground",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsxs("span",{children:[s.attachments.length," attachment",s.attachments.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>(e=>{W(e),G(!0)})(s),className:"flex-1 touch-manipulation min-h-[40px]",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"View Full Conversation"]}),(!s.lockedBy||s.lockedBy._id===he?.id)&&e.jsxs(e.Fragment,{children:["closed"!==s.status&&"resolved"!==s.status&&e.jsxs(y,{size:"sm",onClick:()=>fe(s),className:"flex-1 touch-manipulation min-h-[40px]",children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Reply"]}),"open"===s.status&&(s.assignedTo?e.jsx(y,{size:"sm",variant:"secondary",onClick:()=>ge(s._id,"in_progress"),disabled:ae,className:"flex-1 touch-manipulation min-h-[40px]",children:"Mark In Progress"}):e.jsx(y,{size:"sm",variant:"secondary",onClick:()=>ge(s._id,"in_progress"),disabled:ae,className:"flex-1 touch-manipulation min-h-[40px]",children:"Accept"})),"in_progress"===s.status&&e.jsx(y,{size:"sm",variant:"secondary",onClick:()=>ge(s._id,"resolved"),disabled:ae,className:"flex-1 touch-manipulation min-h-[40px]",children:"Mark Resolved"})]}),s.lockedBy&&s.lockedBy._id===he?.id&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>(e=>{W(e),Z(!0),Ne(),ve()})(s),className:"flex-1 touch-manipulation min-h-[40px]",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Transfer"]})]})]})]},s._id))}),U>1&&e.jsxs("div",{className:"flex flex-col sm:flex-row justify-center items-center gap-2",children:[e.jsx(y,{variant:"outline",disabled:1===q,onClick:()=>V(q-1),className:"w-full sm:w-auto",children:"Previous"}),e.jsxs("span",{className:"px-3 py-2 text-sm text-center",children:["Page ",q," of ",U]}),e.jsx(y,{variant:"outline",disabled:q===U,onClick:()=>V(q+1),className:"w-full sm:w-auto",children:"Next"})]}),e.jsx(b,{open:Y,onOpenChange:G,children:e.jsxs(w,{className:"max-w-3xl max-h-[80vh] overflow-y-auto mx-4 sm:mx-auto",children:[e.jsxs(S,{children:[e.jsxs(T,{className:"text-lg sm:text-xl",children:[Q?.ticketNumber&&`#${Q.ticketNumber} - `,Q?.subject||"Support Ticket"]}),e.jsxs(C,{className:"text-sm",children:["Conversation history with ",Q?.sender.profile.firstName," ",Q?.sender.profile.lastName]})]}),Q&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{className:"h-4 w-4"}),e.jsxs("span",{className:"font-semibold text-sm",children:[Q.sender.profile.firstName," ",Q.sender.profile.lastName]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(Q.createdAt).toLocaleString()})]}),e.jsx("p",{className:"text-sm",children:Q.message}),Q.attachments&&Q.attachments.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(R,{className:"h-3 w-3"}),e.jsxs("span",{children:[Q.attachments.length," attachment",Q.attachments.length>1?"s":""]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:Q.attachments.map((s,a)=>{const t=/\.(jpg|jpeg|png|gif|webp)$/i.test(s.filename);return e.jsxs("div",{className:"border rounded-lg overflow-hidden bg-white dark:bg-gray-900",children:[t?e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"block",children:e.jsx("img",{src:s.url,alt:s.filename,className:"w-full h-32 object-cover cursor-pointer hover:opacity-90 transition"})}):e.jsx("div",{className:"flex items-center justify-center h-32 bg-gray-100 dark:bg-gray-800",children:e.jsx(R,{className:"h-8 w-8 text-muted-foreground"})}),e.jsxs("div",{className:"p-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-xs truncate flex-1 mr-2",title:s.filename,children:s.filename}),e.jsx("a",{href:s.url,download:s.filename,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-700",children:e.jsx(L,{className:"h-3 w-3"})})]})]},a)})})]})]}),Q.responses&&Q.responses.length>1&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Responses"}),Q.responses.slice(1).map((s,a)=>e.jsxs("div",{className:"p-4 rounded-lg "+(s.isAdmin?"bg-blue-50 dark:bg-blue-950":"bg-muted"),children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.isAdmin?e.jsx(h,{className:"h-4 w-4 text-blue-600"}):e.jsx(f,{className:"h-4 w-4"}),e.jsxs("span",{className:"font-semibold text-sm",children:[s.author,s.isAdmin&&e.jsx(j,{variant:"outline",className:"ml-2",children:"Support"})]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.createdAt).toLocaleString()})]}),e.jsx("p",{className:"text-sm",children:s.message})]},a))]})]}),e.jsxs(_,{children:[e.jsx(y,{variant:"outline",onClick:()=>G(!1),children:"Close"}),e.jsx(y,{onClick:()=>{G(!1),Q&&fe(Q)},children:"Reply to Ticket"})]})]})}),e.jsx(b,{open:H,onOpenChange:K,children:e.jsxs(w,{className:"mx-4 sm:mx-auto",children:[e.jsxs(S,{children:[e.jsx(T,{className:"text-lg sm:text-xl",children:"Reply to Support Ticket"}),e.jsxs(C,{className:"text-sm",children:["Send a response to ",Q?.sender.profile.firstName," ",Q?.sender.profile.lastName]})]}),e.jsxs("div",{className:"space-y-4",children:[Q&&e.jsxs("div",{className:"bg-muted p-3 rounded-lg",children:[e.jsx("p",{className:"text-sm font-semibold mb-1",children:"Original Message:"}),e.jsx("p",{className:"text-sm",children:Q.message})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"reply",children:"Your Response"}),e.jsx(F,{id:"reply",placeholder:"Type your response here...",value:ee,onChange:e=>se(e.target.value),rows:6,className:"mt-2"})]})]}),e.jsxs(_,{children:[e.jsx(y,{variant:"outline",onClick:()=>{K(!1),se("")},children:"Cancel"}),e.jsx(y,{onClick:async()=>{if(Q&&ee.trim())try{te(!0),await B.updateSupportTicket(Q._id,Q.status,ee),xe({title:"Success",description:"Reply sent successfully"}),K(!1),se(""),W(null),ue()}catch(e){423===e.status||e.message?.includes("locked")||e.message?.includes("being handled")?(xe({title:"Ticket Locked",description:e.message||"This ticket is currently being handled by another user",variant:"destructive"}),K(!1),ue()):xe({title:"Error",description:e.message||"Failed to send reply",variant:"destructive"})}finally{te(!1)}else xe({title:"Error",description:"Please enter a reply message",variant:"destructive"})},disabled:ae||!ee.trim(),children:ae?"Sending...":"Send Reply"})]})]})}),e.jsx(b,{open:X,onOpenChange:Z,children:e.jsxs(w,{className:"mx-4 sm:mx-auto max-w-md",children:[e.jsxs(S,{children:[e.jsx(T,{className:"text-lg sm:text-xl",children:"Transfer Support Ticket"}),e.jsxs(C,{className:"text-sm",children:["Transfer #",Q?.ticketNumber," to another support team member"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{htmlFor:"role-filter",children:"Filter by Role"}),e.jsxs(i,{value:ce,onValueChange:e=>{de(e),me(""),ve(e)},children:[e.jsx(n,{className:"mt-2",children:e.jsx(c,{placeholder:"Select role"})}),e.jsxs(d,{children:[e.jsx(o,{value:"all",children:"All Available Staff"}),ie.length>0?ie.map(s=>e.jsx(o,{value:s.name,children:s.name.charAt(0).toUpperCase()+s.name.slice(1)},s._id)):e.jsxs(e.Fragment,{children:[e.jsx(o,{value:"admin",children:"Admin"}),e.jsx(o,{value:"subadmin",children:"Sub Admin"}),e.jsx(o,{value:"agent",children:"Support Agent"})]})]})]})]}),e.jsxs("div",{children:[e.jsx(A,{htmlFor:"transfer-to",children:"Select User"}),e.jsxs(i,{value:oe,onValueChange:me,children:[e.jsx(n,{className:"mt-2",children:e.jsx(c,{placeholder:"Choose a user to transfer to"})}),e.jsx(d,{children:0===ye.length?e.jsx(o,{value:"none",disabled:!0,children:"No users available"}):ye.map(s=>e.jsx(o,{value:s._id,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{children:[s.profile?.firstName," ",s.profile?.lastName]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.email," - ",s.role]})]})},s._id))})]})]}),0===ye.length&&"all"!==ce&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No ",ce," users found. Try selecting a different role."]})]}),e.jsxs(_,{children:[e.jsx(y,{variant:"outline",onClick:()=>{Z(!1),me(""),de("all")},children:"Cancel"}),e.jsx(y,{onClick:async()=>{if(Q&&oe)try{te(!0);const e=await fetch(`/api/support/tickets/${Q.ticketNumber}/transfer`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({targetUserId:oe})}),s=await e.json();if(!e.ok)throw new Error(s.message||"Failed to transfer ticket");xe({title:"Success",description:"Ticket transferred successfully"}),Z(!1),me(""),de("all"),W(null),ue()}catch(e){xe({title:"Error",description:e.message||"Failed to transfer ticket",variant:"destructive"})}finally{te(!1)}else xe({title:"Error",description:"Please select a user to transfer to",variant:"destructive"})},disabled:ae||!oe,children:ae?"Transferring...":"Transfer Ticket"})]})]})})]})};export{$ as default};
