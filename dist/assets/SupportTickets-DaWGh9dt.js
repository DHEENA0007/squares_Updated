import{j as e}from"./ui-BNZSgpjP.js";import{d as s,r as t}from"./router-D8v2YSKU.js";import{u as a,a2 as r,aO as i,q as l,r as n,s as c,v as d,w as o,a as m,e as x,B as u,x as p,aD as h,aE as j,f,aF as g,aI as v,aB as N,ap as k,ar as y,T as b,a4 as w,a5 as S,a6 as T,a7 as _,a8 as C,L as A,ae as P,Z as E}from"./index-BUFRx16p.js";import{s as I}from"./subAdminService-DFZLcIE9.js";import{S as R,a as O,b as D,c as B,d as F}from"./sheet-Cutm-LHo.js";import{T as L,a as U,b as z,c as $,d as V,e as Y}from"./table-DP60n6HD.js";import{L as K}from"./lock--BIkchZP.js";import{E as M}from"./ellipsis-vertical-BeZSNIEr.js";import{P as q}from"./paperclip-kBGZ1-dL.js";import{D as H}from"./download-CvWdhTp5.js";import{S as J}from"./send-BTDJ3su-.js";import"./vendor-BxThA0WO.js";const W=()=>{const{user:W}=a(),Z=s(),G=W?.rolePermissions||[],{toast:Q}=r(),X=t.useRef(null),ee="admin"===W?.role||"superadmin"===W?.role||"subadmin"===W?.role,se=e=>G.includes(e),te=ee||se(E.SUPPORT_TICKETS_READ),ae=ee||se(E.SUPPORT_TICKETS_VIEW),re=ee||se(E.SUPPORT_TICKETS_REPLY),ie=ee||se(E.SUPPORT_TICKETS_STATUS)||se(E.SUPPORT_TICKETS_REPLY),[le,ne]=t.useState([]),[ce,de]=t.useState(!0),[oe,me]=t.useState("open"),[xe,ue]=t.useState(1),[pe,he]=t.useState(1),[je,fe]=t.useState(null),[ge,ve]=t.useState(!1),[Ne,ke]=t.useState(!1),[ye,be]=t.useState(""),[we,Se]=t.useState(!1),[Te,_e]=t.useState([]),[Ce,Ae]=t.useState([]),[Pe,Ee]=t.useState("all"),[Ie,Re]=t.useState("");t.useEffect(()=>{if(!te)return Q({title:"Access Denied",description:"You don't have permission to view support tickets.",variant:"destructive"}),void Z("/rolebased");Oe()},[xe,oe]),t.useEffect(()=>{ge&&X.current&&X.current.scrollIntoView({behavior:"smooth"})},[ge,je?.responses]);const Oe=async()=>{if(te)try{de(!0);const e=await I.getSupportTickets(xe,10,oe);ne(e.tickets),he(e.totalPages)}catch(e){Q({title:"Error",description:e.message||"Failed to fetch support tickets",variant:"destructive"})}finally{de(!1)}};i("support_ticket_created",e=>{Q({title:"New Support Ticket",description:"A new support ticket has been created"}),Oe()}),i("support_ticket_updated",e=>{Oe()}),i("message_received",e=>{"support"===e.type&&(Oe(),je&&e.ticketId===je._id&&I.getSupportTickets(xe,10,oe).then(e=>{const s=e.tickets.find(e=>e._id===je._id);s&&fe(s)}))});const De=e=>{switch(e){case"open":return"destructive";case"in_progress":return"default";default:return"outline"}},Be=e=>{switch(e){case"urgent":case"high":return"destructive";case"medium":return"default";case"low":return"secondary";default:return"outline"}},Fe=e=>{ae?(fe(e),ve(!0)):Q({title:"Access Denied",description:"You don't have permission to view conversations.",variant:"destructive"})},Le=async(e,s)=>{if(ie)try{Se(!0),await I.updateSupportTicket(e,s,""),Q({title:"Success",description:`Ticket marked as ${s.replace("_"," ")}`}),Oe(),je&&je._id===e&&fe(e=>e?{...e,status:s}:null)}catch(t){423===t.status||t.message?.includes("locked")?(Q({title:"Ticket Locked",description:"This ticket is currently being handled by another user",variant:"destructive"}),Oe()):Q({title:"Error",description:"Failed to update ticket status",variant:"destructive"})}finally{Se(!1)}else Q({title:"Access Denied",description:"You don't have permission to update ticket status.",variant:"destructive"})},Ue=async()=>{try{const e=await fetch("/api/support/transfer-roles",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),s=await e.json();s.success&&Ae(s.data.roles||[])}catch(e){}},ze=async e=>{try{const s=e&&"all"!==e?`/api/support/transfer-users?role=${e}`:"/api/support/transfer-users",t=await fetch(s,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),a=await t.json();a.success&&_e(a.data.users)}catch(s){}},$e=Te.filter(e=>"all"===Pe||e.role===Pe);return te?e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Support Tickets"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage and respond to customer support requests"})]}),e.jsxs(l,{value:oe,onValueChange:me,children:[e.jsx(n,{className:"w-[180px]",children:e.jsx(c,{placeholder:"Filter by status"})}),e.jsxs(d,{children:[e.jsx(o,{value:"open",children:"Open Tickets"}),e.jsx(o,{value:"in_progress",children:"In Progress"}),e.jsx(o,{value:"closed",children:"Closed"}),e.jsx(o,{value:"all",children:"All Tickets"})]})]})]}),e.jsx(m,{children:e.jsx(x,{className:"p-0",children:e.jsxs(L,{children:[e.jsx(U,{children:e.jsxs(z,{children:[e.jsx($,{className:"w-[100px]",children:"Ticket ID"}),e.jsx($,{children:"Subject"}),e.jsx($,{children:"Requester"}),e.jsx($,{children:"Status"}),e.jsx($,{children:"Priority"}),e.jsx($,{children:"Assigned To"}),e.jsx($,{children:"Created"}),e.jsx($,{className:"text-right",children:"Actions"})]})}),e.jsx(V,{children:ce?[...Array(5)].map((s,t)=>e.jsxs(z,{children:[e.jsx(Y,{children:e.jsx("div",{className:"h-4 w-12 bg-muted animate-pulse rounded"})}),e.jsx(Y,{children:e.jsx("div",{className:"h-4 w-32 bg-muted animate-pulse rounded"})}),e.jsx(Y,{children:e.jsx("div",{className:"h-4 w-24 bg-muted animate-pulse rounded"})}),e.jsx(Y,{children:e.jsx("div",{className:"h-4 w-16 bg-muted animate-pulse rounded"})}),e.jsx(Y,{children:e.jsx("div",{className:"h-4 w-16 bg-muted animate-pulse rounded"})}),e.jsx(Y,{children:e.jsx("div",{className:"h-4 w-24 bg-muted animate-pulse rounded"})}),e.jsx(Y,{children:e.jsx("div",{className:"h-4 w-20 bg-muted animate-pulse rounded"})}),e.jsx(Y,{children:e.jsx("div",{className:"h-8 w-8 bg-muted animate-pulse rounded ml-auto"})})]},t)):0===le.length?e.jsx(z,{children:e.jsx(Y,{colSpan:8,className:"h-24 text-center",children:"No tickets found."})}):le.map(s=>e.jsxs(z,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>Fe(s),children:[e.jsxs(Y,{className:"font-medium",children:["#",s.ticketNumber]}),e.jsx(Y,{className:"max-w-[200px] truncate",children:s.subject||"No Subject"}),e.jsx(Y,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-medium text-sm",children:[s.sender.profile.firstName," ",s.sender.profile.lastName]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.sender.email})]})}),e.jsx(Y,{children:e.jsx(u,{variant:De(s.status),children:s.status.replace("_"," ")})}),e.jsx(Y,{children:s.priority&&e.jsx(u,{variant:Be(s.priority),children:s.priority})}),e.jsx(Y,{children:s.lockedBy?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-orange-600 font-medium",children:[e.jsx(K,{className:"h-3 w-3"}),s.lockedBy.profile?.firstName]}):s.assignedTo?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(p,{className:"h-3 w-3"}),s.assignedTo.profile?.firstName]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Unassigned"})}),e.jsx(Y,{className:"text-muted-foreground text-xs",children:new Date(s.createdAt).toLocaleDateString()}),e.jsx(Y,{className:"text-right",onClick:e=>e.stopPropagation(),children:e.jsxs(h,{children:[e.jsx(j,{asChild:!0,children:e.jsxs(f,{variant:"ghost",className:"h-8 w-8 p-0",children:[e.jsx("span",{className:"sr-only",children:"Open menu"}),e.jsx(M,{className:"h-4 w-4"})]})}),e.jsxs(g,{align:"end",children:[e.jsx(v,{onClick:()=>Fe(s),children:"View Details"}),(!s.lockedBy||s.lockedBy._id===W?.id)&&e.jsxs(e.Fragment,{children:[ie&&"open"===s.status&&e.jsx(v,{onClick:()=>Le(s._id,"in_progress"),children:s.assignedTo?"Mark In Progress":"Accept"}),ie&&"in_progress"===s.status&&e.jsx(v,{onClick:()=>Le(s._id,"closed"),children:"Mark Closed"}),ie&&e.jsx(v,{onClick:()=>(e=>{ie&&(fe(e),ke(!0),Ue(),ze())})(s),children:"Transfer Ticket"})]})]})]})})]},s._id))})]})})}),pe>1&&e.jsxs("div",{className:"flex justify-center gap-2 mt-4",children:[e.jsx(f,{variant:"outline",disabled:1===xe,onClick:()=>ue(xe-1),children:"Previous"}),e.jsxs("span",{className:"py-2 px-3 text-sm",children:["Page ",xe," of ",pe]}),e.jsx(f,{variant:"outline",disabled:xe===pe,onClick:()=>ue(xe+1),children:"Next"})]}),e.jsx(R,{open:ge,onOpenChange:ve,children:e.jsxs(O,{className:"w-full sm:max-w-xl flex flex-col p-0 gap-0",children:[e.jsxs(D,{className:"p-6 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(u,{variant:De(je?.status||"open"),children:je?.status.replace("_"," ")}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["#",je?.ticketNumber]})]}),e.jsx(B,{className:"text-xl text-left",children:je?.subject||"Support Request"}),e.jsxs(F,{className:"text-left flex items-center gap-2 mt-1",children:[e.jsx(p,{className:"h-4 w-4"}),je?.sender.profile.firstName," ",je?.sender.profile.lastName,e.jsx("span",{className:"text-xs text-muted-foreground ml-2",children:je&&new Date(je.createdAt).toLocaleString()})]})]}),e.jsx(N,{className:"flex-1 p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-3",children:[e.jsx("p",{className:"text-sm leading-relaxed",children:je?.message}),je?.attachments&&je.attachments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-2 border-t border-border/50",children:je.attachments.map((s,t)=>e.jsxs("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 text-xs bg-background p-2 rounded border hover:bg-accent transition-colors",children:[e.jsx(q,{className:"h-3 w-3"}),e.jsx("span",{className:"max-w-[150px] truncate",children:s.filename}),e.jsx(H,{className:"h-3 w-3 ml-1"})]},t))})]}),je?.responses&&je.responses.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative flex items-center gap-4",children:[e.jsx("div",{className:"h-px bg-border flex-1"}),e.jsx("span",{className:"text-xs text-muted-foreground font-medium uppercase",children:"History"}),e.jsx("div",{className:"h-px bg-border flex-1"})]}),je.responses.map((s,t)=>e.jsxs("div",{className:"flex gap-3 "+(s.isAdmin?"flex-row-reverse":"flex-row"),children:[e.jsx(k,{className:"h-8 w-8",children:e.jsx(y,{className:s.isAdmin?"bg-primary text-primary-foreground":"",children:s.author[0]})}),e.jsxs("div",{className:"flex flex-col max-w-[80%] "+(s.isAdmin?"items-end":"items-start"),children:[e.jsx("div",{className:"p-3 rounded-lg text-sm "+(s.isAdmin?"bg-primary text-primary-foreground rounded-tr-none":"bg-muted rounded-tl-none"),children:s.message}),e.jsx("span",{className:"text-[10px] text-muted-foreground mt-1",children:new Date(s.createdAt).toLocaleString()})]})]},t)),e.jsx("div",{ref:X})]})]})}),e.jsx("div",{className:"p-4 border-t bg-background",children:je?.lockedBy&&je.lockedBy._id!==W?.id?e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-orange-50 text-orange-800 rounded-md text-sm",children:[e.jsx(K,{className:"h-4 w-4"}),"This ticket is locked by ",je?.lockedBy.profile?.firstName]}):e.jsx("div",{className:"space-y-4",children:re&&e.jsxs(e.Fragment,{children:[e.jsx(b,{placeholder:"Type your reply...",value:ye,onChange:e=>be(e.target.value),className:"min-h-[100px] resize-none"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-2",children:[ie&&"open"===je?.status&&e.jsx(f,{variant:"outline",size:"sm",onClick:()=>Le(je._id,"in_progress"),children:je.assignedTo?"Mark In Progress":"Accept"}),ie&&"in_progress"===je?.status&&e.jsx(f,{variant:"outline",size:"sm",onClick:()=>Le(je._id,"closed"),children:"Mark Closed"})]}),e.jsx(f,{onClick:async()=>{if(re){if(je&&ye.trim())if("closed"!==je.status)try{Se(!0),await I.updateSupportTicket(je._id,je.status,ye),be("");const e=await I.getSupportTickets(xe,10,oe);ne(e.tickets);const s=e.tickets.find(e=>e._id===je._id);s&&fe(s),Q({title:"Success",description:"Reply sent successfully"})}catch(e){423===e.status||e.message?.includes("locked")?(Q({title:"Ticket Locked",description:"This ticket is currently being handled by another user",variant:"destructive"}),Oe()):Q({title:"Error",description:e.message||"Failed to send reply",variant:"destructive"})}finally{Se(!1)}else Q({title:"Cannot Reply",description:`This ticket is ${je.status}. Only open or in-progress tickets can receive replies.`,variant:"destructive"})}else Q({title:"Access Denied",description:"You don't have permission to reply to tickets.",variant:"destructive"})},disabled:we||!ye.trim(),children:we?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Reply"]})})]})]})})})]})}),e.jsx(w,{open:Ne,onOpenChange:ke,children:e.jsxs(S,{className:"sm:max-w-md",children:[e.jsxs(T,{children:[e.jsx(_,{children:"Transfer Ticket"}),e.jsx(C,{children:"Assign this ticket to another team member."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Filter by Role"}),e.jsxs(l,{value:Pe,onValueChange:e=>{Ee(e),Re(""),ze(e)},children:[e.jsx(n,{children:e.jsx(c,{placeholder:"Select role"})}),e.jsxs(d,{children:[e.jsx(o,{value:"all",children:"All Roles"}),Ce.map(s=>e.jsx(o,{value:s.name,children:s.name},s._id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Select User"}),e.jsxs(l,{value:Ie,onValueChange:Re,children:[e.jsx(n,{children:e.jsx(c,{placeholder:"Select user"})}),e.jsx(d,{children:$e.map(s=>e.jsxs(o,{value:s._id,children:[s.profile?.firstName," ",s.profile?.lastName]},s._id))})]})]})]}),e.jsxs(P,{children:[e.jsx(f,{variant:"outline",onClick:()=>ke(!1),children:"Cancel"}),e.jsx(f,{onClick:async()=>{if(je&&Ie)try{Se(!0);const e=await fetch(`/api/support/tickets/${je.ticketNumber}/transfer`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({targetUserId:Ie})}),s=await e.json();if(!e.ok)throw new Error(s.message||"Failed to transfer ticket");Q({title:"Success",description:"Ticket transferred successfully"}),ke(!1),Re(""),Ee("all"),ve(!1),Oe()}catch(e){Q({title:"Error",description:e.message||"Failed to transfer ticket",variant:"destructive"})}finally{Se(!1)}},disabled:we||!Ie,children:"Transfer"})]})]})})]}):null};export{W as default};
