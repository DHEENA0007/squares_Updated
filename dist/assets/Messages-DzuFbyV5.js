import{j as e}from"./ui-DOY6021Z.js";import{r as c}from"./router-2SVJvIbS.js";import{t as x,f as M,a as g,e as p,T as ae,K as re,L as k,B as u,H as le,I as ie,q as I,r as L,s as U,v as H,w as d,O,Q as V,R as B,V as ne,W as ce,Y as oe,Z as z,$ as de}from"./index-DJqidggL.js";import{T as me}from"./textarea-DO9hd5Hf.js";import{S as G}from"./scroll-area-4cosYoBm.js";import{A as xe,b as ue,c as he,d as ge,e as pe,f as je,g as fe,h as Ne}from"./alert-dialog-nMYiUnKa.js";import{L as ye}from"./loader-circle-C0zUPQir.js";import{R as ve}from"./refresh-cw-C3gAEdXw.js";import{E as we}from"./ellipsis-vertical-BFXsvqj0.js";import{T as be}from"./triangle-alert-0uhB3Tk-.js";import{T as Se}from"./trash-2-BwLQT3fy.js";import{S as Me}from"./send-d1uHhC4x.js";import"./vendor-Dazix4UH.js";const Ce="https://squares-v2.onrender.com/api";class Te{async makeRequest(r,a={}){try{const l=localStorage.getItem("token"),t=await fetch(`${Ce}${r}`,{headers:{"Content-Type":"application/json",...l&&{Authorization:`Bearer ${l}`},...a.headers},...a});if(!t.ok){const m=await t.json().catch(()=>({}));throw new Error(m.message||`HTTP error! status: ${t.status}`)}return await t.json()}catch(l){throw console.error("API request failed:",l),l}}async getMessages(r={}){try{const a=new URLSearchParams;Object.entries(r).forEach(([m,j])=>{j!=null&&j!==""&&a.append(m,j.toString())});const l=a.toString(),t=`/admin/messages${l?`?${l}`:""}`;return await this.makeRequest(t)}catch(a){const l=a instanceof Error?a.message:"Failed to fetch messages";throw x({title:"Error",description:l,variant:"destructive"}),a}}async getMessageStats(){try{const r=await this.makeRequest("/admin/messages/stats");if(r.success)return r.data;throw new Error("Failed to fetch message statistics")}catch(r){const a=r instanceof Error?r.message:"Failed to fetch message statistics";throw x({title:"Error",description:a,variant:"destructive"}),r}}async updateMessageStatus(r,a){try{const l=await this.makeRequest(`/admin/messages/${r}/status`,{method:"PATCH",body:JSON.stringify({status:a})});if(l.success)return x({title:"Success",description:l.message}),l.data.message;throw new Error("Failed to update message status")}catch(l){const t=l instanceof Error?l.message:"Failed to update message status";throw x({title:"Error",description:t,variant:"destructive"}),l}}async deleteMessage(r){try{const a=await this.makeRequest(`/admin/messages/${r}`,{method:"DELETE"});if(a.success){x({title:"Success",description:a.message});return}throw new Error("Failed to delete message")}catch(a){const l=a instanceof Error?a.message:"Failed to delete message";throw x({title:"Error",description:l,variant:"destructive"}),a}}async sendReply(r,a,l){try{const t=await this.makeRequest(`/admin/messages/${r}/reply`,{method:"POST",body:JSON.stringify({content:a,subject:l})});if(t.success)return x({title:"Success",description:t.message}),t.data.reply;throw new Error("Failed to send reply")}catch(t){const m=t instanceof Error?t.message:"Failed to send reply";throw x({title:"Error",description:m,variant:"destructive"}),t}}getSenderName(r){const a=r.sender.profile;return a?.firstName&&a?.lastName?`${a.firstName} ${a.lastName}`:r.sender.email}getRecipientName(r){const a=r.recipient.profile;return a?.firstName&&a?.lastName?`${a.firstName} ${a.lastName}`:r.recipient.email}formatDate(r){const a=new Date(r),t=(new Date().getTime()-a.getTime())/(1e3*60*60);return t<1?`${Math.floor(t*60)} minutes ago`:t<24?`${Math.floor(t)} hours ago`:t<48?"Yesterday":a.toLocaleDateString("en-IN",{year:"numeric",month:"short",day:"numeric"})}getStatusColor(r){return{unread:"bg-blue-100 text-blue-800",read:"bg-green-100 text-green-800",replied:"bg-purple-100 text-purple-800",flagged:"bg-red-100 text-red-800",archived:"bg-gray-100 text-gray-800"}[r]||"bg-gray-100 text-gray-800"}getPriorityColor(r){return{urgent:"bg-red-500 text-white",high:"bg-orange-500 text-white",medium:"bg-yellow-500 text-white",low:"bg-green-500 text-white"}[r]||"bg-gray-500 text-white"}getTypeDisplayName(r){return{inquiry:"General Inquiry",lead:"Lead",property_inquiry:"Property Inquiry",general:"General",support:"Support",complaint:"Complaint"}[r]||r}}const o=new Te,Oe=()=>{const[C,r]=c.useState([]),[a,l]=c.useState([]),[t,m]=c.useState(null),[j,q]=c.useState(!0),[n,J]=c.useState(null),[N,Y]=c.useState("all"),[T,K]=c.useState(""),[A,Ae]=c.useState("all"),[y,Q]=c.useState("all"),[v,W]=c.useState("all"),[w,D]=c.useState(""),[F,b]=c.useState(null),[E,Z]=c.useState({currentPage:1,totalPages:1,totalMessages:0,hasNext:!1,hasPrev:!1,limit:20});c.useEffect(()=>{h(),f()},[]);const h=async(s={})=>{try{q(!0);const i={page:E.currentPage,limit:E.limit,status:A!=="all"?A:void 0,type:y!=="all"?y:void 0,priority:v!=="all"?v:void 0,search:T||void 0,...s},R=await o.getMessages(i);R.success&&(r(R.data.messages),Z(R.data.pagination))}catch(i){console.error("Failed to load messages:",i)}finally{q(!1)}},f=async()=>{try{const s=await o.getMessageStats();J(s)}catch(s){console.error("Failed to load message stats:",s)}};c.useEffect(()=>{h()},[N,A,y,v,T,E.currentPage]),c.useEffect(()=>{let s=C;switch(N){case"unread":s=s.filter(i=>i.status==="unread");break;case"flagged":s=s.filter(i=>i.status==="flagged");break;case"inquiries":s=s.filter(i=>["inquiry","lead","property_inquiry"].includes(i.type));break;case"support":s=s.filter(i=>["support","complaint"].includes(i.type));break}l(s)},[C,N]);const S=s=>o.getSenderName(s),P=s=>o.formatDate(s),$=s=>o.getStatusColor(s),_=s=>o.getPriorityColor(s),X=async s=>{try{await o.updateMessageStatus(s,"read"),h(),f()}catch(i){console.error("Failed to mark message as read:",i)}},ee=async s=>{try{await o.updateMessageStatus(s,"flagged"),h(),f()}catch(i){console.error("Failed to flag message:",i)}},se=async s=>{try{await o.deleteMessage(s),t?._id===s&&m(null),h(),f(),b(null)}catch(i){console.error("Failed to delete message:",i)}},te=async()=>{if(!(!t||!w.trim()))try{await o.sendReply(t._id,w.trim()),D(""),h(),f()}catch(s){console.error("Failed to send reply:",s)}};return j?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ye,{className:"h-6 w-6 animate-spin"}),e.jsx("span",{children:"Loading messages..."})]})}):e.jsxs("div",{className:"space-y-6 relative top-[60px]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Messages"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage and respond to user messages and inquiries"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(M,{variant:"outline",onClick:()=>h(),children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"Refresh"]})})]}),n&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-4",children:[e.jsx(g,{children:e.jsxs(p,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:n.totalMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total Messages"})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:n.unreadMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Unread"})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:n.repliedMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Replied"})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:n.flaggedMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Flagged"})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:n.todayMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Today"})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-4 text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-teal-600",children:[n.responseRate,"%"]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Response Rate"})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-indigo-600",children:n.avgResponseTime}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Avg Response"})]})})]}),e.jsxs("div",{className:"h-[calc(100vh-16rem)] flex gap-6",children:[e.jsxs("div",{className:"w-1/3 border-r border-border",children:[e.jsx(ae,{value:N,onValueChange:Y,className:"w-full",children:e.jsxs(re,{className:"w-full grid grid-cols-3",children:[e.jsxs(k,{value:"all",className:"text-xs",children:["All ",n&&n.totalMessages>0&&e.jsx(u,{className:"ml-1 text-xs",variant:"secondary",children:n.totalMessages})]}),e.jsxs(k,{value:"unread",className:"text-xs",children:["Unread ",n&&n.unreadMessages>0&&e.jsx(u,{className:"ml-1 text-xs bg-red-500 text-white",children:n.unreadMessages})]}),e.jsxs(k,{value:"flagged",className:"text-xs",children:["Flagged ",n&&n.flaggedMessages>0&&e.jsx(u,{className:"ml-1 text-xs bg-orange-500 text-white",children:n.flaggedMessages})]})]})}),e.jsxs("div",{className:"p-4 border-b border-border space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(le,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ie,{placeholder:"Search conversations...",value:T,onChange:s=>K(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(I,{value:y,onValueChange:Q,children:[e.jsx(L,{className:"flex-1",children:e.jsx(U,{placeholder:"Type"})}),e.jsxs(H,{children:[e.jsx(d,{value:"all",children:"All"}),e.jsx(d,{value:"inquiry",children:"Inquiry"}),e.jsx(d,{value:"property_inquiry",children:"Property"}),e.jsx(d,{value:"support",children:"Support"})]})]}),e.jsxs(I,{value:v,onValueChange:W,children:[e.jsx(L,{className:"flex-1",children:e.jsx(U,{placeholder:"Priority"})}),e.jsxs(H,{children:[e.jsx(d,{value:"all",children:"All"}),e.jsx(d,{value:"urgent",children:"Urgent"}),e.jsx(d,{value:"high",children:"High"}),e.jsx(d,{value:"medium",children:"Medium"}),e.jsx(d,{value:"low",children:"Low"})]})]})]})]}),e.jsx(G,{className:"h-[calc(100%-12rem)]",children:e.jsx("div",{className:"p-2 space-y-1",children:a.map(s=>e.jsx("div",{className:`p-3 rounded-lg cursor-pointer transition-colors hover:bg-accent/50 ${t?._id===s._id?"bg-accent":""}`,onClick:()=>{m(s),s.status==="unread"&&X(s._id)},children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(O,{className:"w-10 h-10",children:[e.jsx(V,{src:s.sender.profile?.avatar}),e.jsx(B,{children:S(s).charAt(0).toUpperCase()})]}),s.status==="unread"&&e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 rounded-full bg-red-500"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:S(s)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:P(s.createdAt)})]}),s.subject&&e.jsx("p",{className:"text-xs font-medium text-primary mb-1 truncate",children:s.subject}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.content}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx(u,{className:`text-xs ${_(s.priority)}`,children:s.priority}),e.jsx(u,{className:`text-xs ${$(s.status)}`,children:s.status})]}),e.jsxs(ne,{children:[e.jsx(ce,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",children:e.jsx(we,{className:"w-3 h-3"})})}),e.jsxs(oe,{align:"end",children:[e.jsxs(z,{onClick:()=>ee(s._id),children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Flag"]}),e.jsxs(z,{className:"text-red-600",onSelect:i=>{i.preventDefault(),b(s._id)},children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]})]})]})]})},s._id))})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(O,{className:"w-10 h-10",children:[e.jsx(V,{src:t.sender.profile?.avatar}),e.jsx(B,{children:S(t).charAt(0).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:S(t)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.sender.email})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{className:_(t.priority),children:t.priority}),e.jsx(u,{className:$(t.status),children:t.status})]})]}),t.property&&e.jsxs("div",{className:"mt-3 p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium",children:"Related Property:"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.property.title})]})]}),e.jsx(G,{className:"flex-1 p-4",children:e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"max-w-[70%] bg-muted p-3 rounded-lg",children:[t.subject&&e.jsx("p",{className:"font-medium text-sm mb-2",children:t.subject}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:P(t.createdAt)}),e.jsx(u,{variant:"outline",className:"text-xs",children:t.type?.replace("_"," ")||"general"})]})]})})})}),e.jsx("div",{className:"p-4 border-t border-border",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(me,{placeholder:"Type your reply...",value:w,onChange:s=>D(s.target.value),rows:3,className:"resize-none"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(M,{onClick:te,disabled:!w.trim(),className:"flex-1",children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Send Reply"]}),e.jsx(M,{variant:"outline",onClick:()=>D(""),children:"Clear"})]})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(de,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a Conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a message from the list to start chatting"})]})})})]}),e.jsx(xe,{open:!!F,onOpenChange:s=>{s||b(null)},children:e.jsxs(ue,{className:"sm:max-w-[425px]",children:[e.jsxs(he,{children:[e.jsx(ge,{children:"Delete Message"}),e.jsx(pe,{children:"Are you sure you want to delete this message? This action cannot be undone."})]}),e.jsxs(je,{children:[e.jsx(fe,{onClick:()=>b(null),children:"Cancel"}),e.jsx(Ne,{onClick:()=>{F&&se(F)},className:"bg-red-600 hover:bg-red-700 focus:ring-red-600",children:"Delete Message"})]})]})})]})};export{Oe as default};
