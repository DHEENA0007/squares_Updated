import{j as e}from"./ui-DOY6021Z.js";import{r as n,R as U}from"./router-2SVJvIbS.js";import{A as le,u as ce,t as c,H as oe,I as de,O as E,Q as P,R as $,B as z,f as x,y as me,V as R,W as V,Y as B,Z as j,ai as ue,n as xe,$ as he,l as pe}from"./index-DJqidggL.js";import{S as O}from"./scroll-area-4cosYoBm.js";import{T as fe}from"./textarea-DO9hd5Hf.js";import{m as o}from"./messageService-DGuX3xJM.js";import{V as ge}from"./video-DCSz15tc.js";import{E as H}from"./ellipsis-vertical-BFXsvqj0.js";import{A as je,P as Q,C as q}from"./paperclip-BnXS1-L9.js";import{I as ve}from"./image-B4yukkwo.js";import{S as ye}from"./send-d1uHhC4x.js";import"./vendor-Dazix4UH.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=le("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]),Ue=()=>{const{user:W}=ce(),[i,v]=n.useState(null),[h,M]=n.useState(""),[m,Y]=n.useState(""),[G,A]=n.useState(!0),[y,N]=n.useState([]),[Z,g]=n.useState([]),[J,k]=n.useState(!1),[p,w]=n.useState([]),[f,T]=n.useState(!1),[X,Ne]=n.useState(!1),F=U.useRef(null),_=U.useRef(null);n.useEffect(()=>{b()},[]),n.useEffect(()=>{b()},[m]),n.useEffect(()=>{i&&ee(i)},[i]);const b=async()=>{try{A(!0);const s={page:1,limit:50,...m&&{search:m}},t=await o.getConversations(s);N(t.conversations),!i&&t.conversations.length>0&&v(t.conversations[0].id||t.conversations[0]._id||"")}catch(s){console.error("Failed to load conversations:",s),c({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{A(!1)}},ee=async s=>{try{k(!0);const t=await o.getConversationMessages(s,1,50,!0);t&&(g(t.messages),await o.updateActiveStatus(s,"online"),b(),c({title:"Messages loaded",description:`${t.messages.length} messages loaded and marked as read`}))}catch(t){console.error("Failed to load messages:",t)}finally{k(!1)}},L=async()=>{if(!h.trim()&&p.length===0||!i)return;const s=y.find(t=>(t.id||t._id)===i);if(s)try{T(!0),await o.updateActiveStatus(i,"online");const t=[];for(const r of p){const l=await o.uploadAttachment(r);t.push(l)}const a=await o.sendMessage(i,h.trim()||"(Attachment)",s.otherUser._id,t);g(r=>[...r,a]),M(""),w([]),N(r=>r.map(l=>(l.id||l._id)===i?{...l,lastMessage:{_id:a._id,message:a.message,createdAt:a.createdAt,isFromMe:!0},updatedAt:a.createdAt}:l)),c({title:"Success",description:"Message sent successfully!"})}catch(t){console.error("Failed to send message:",t),c({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})}finally{T(!1)}},D=(s,t)=>{const a=s.target.files;if(!a)return;const r=Array.from(a),l=[];for(const d of r){if(d.size>10*1024*1024){c({title:"File too large",description:`${d.name} exceeds 10MB limit`,variant:"destructive"});continue}if(t==="image"){if(!d.type.startsWith("image/")){c({title:"Invalid file type",description:`${d.name} is not an image`,variant:"destructive"});continue}}else if(!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(d.type)){c({title:"Invalid file type",description:`${d.name} is not a supported document type`,variant:"destructive"});continue}l.push(d)}w(d=>[...d,...l]),s.target&&(s.target.value="")},se=s=>{w(t=>t.filter((a,r)=>r!==s))},te=async()=>{i&&await o.updateActiveStatus(i,"typing")},I=async()=>{i&&await o.updateActiveStatus(i,"online")};n.useEffect(()=>{let s;return h.trim()?(te(),s&&clearTimeout(s),s=setTimeout(()=>{I()},2e3)):I(),()=>{s&&clearTimeout(s)}},[h]),n.useEffect(()=>()=>{i&&o.updateActiveStatus(i,"offline")},[i]);const ae=async s=>{if(window.confirm("Are you sure you want to delete this conversation?"))try{await o.deleteConversation(s),N(t=>t.filter(a=>(a.id||a._id)!==s)),i===s&&(v(null),g([])),c({title:"Success",description:"Conversation deleted successfully!"})}catch(t){console.error("Failed to delete conversation:",t),c({title:"Error",description:"Failed to delete conversation. Please try again.",variant:"destructive"})}},re=async s=>{if(window.confirm("Are you sure you want to delete this message? This action cannot be undone."))try{await o.deleteMessage(s),g(t=>t.filter(a=>a._id!==s)),c({title:"Success",description:"Message deleted successfully!"})}catch(t){console.error("Failed to delete message:",t),c({title:"Error",description:"Failed to delete message. Please try again.",variant:"destructive"})}},C=s=>s.otherUser,ie=s=>{switch(s){case"sent":return e.jsx(pe,{className:"w-3 h-3 text-gray-400"});case"delivered":return e.jsx(q,{className:"w-3 h-3 text-gray-400"});case"read":return e.jsx(q,{className:"w-3 h-3 text-blue-500"});default:return null}},u=y.find(s=>(s.id||s._id)===i),S=u?C(u):null;if(G)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading messages..."})]})});const ne=y.filter(s=>{if(!m)return!0;const t=C(s);return t?(t.name||"Unknown User").toLowerCase().includes(m.toLowerCase())||s.lastMessage?.message.toLowerCase().includes(m.toLowerCase())||s.property?.title.toLowerCase().includes(m.toLowerCase()):!1});return e.jsxs("div",{className:"h-[calc(100vh-8rem)] flex",children:[e.jsxs("div",{className:"w-1/3 border-r border-border",children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Messages"}),e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(de,{placeholder:"Search conversations...",value:m,onChange:s=>Y(s.target.value),className:"pl-10"})]})]}),e.jsx(O,{className:"h-[calc(100%-8rem)]",children:e.jsx("div",{className:"p-2",children:ne.map(s=>{const a=C(s)?.name||"Unknown User",r=s.id||s._id||"";return e.jsx("div",{className:`p-3 rounded-lg cursor-pointer transition-colors hover:bg-muted ${i===r?"bg-muted":""}`,onClick:()=>v(r),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"relative",children:e.jsxs(E,{className:"h-10 w-10",children:[e.jsx(P,{src:void 0}),e.jsx($,{children:a.charAt(0).toUpperCase()})]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-sm font-semibold truncate",children:a}),e.jsx("div",{className:"flex items-center space-x-1",children:s.unreadCount>0&&e.jsx(z,{className:"bg-primary text-primary-foreground text-xs px-2",children:s.unreadCount})})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-1 truncate",children:s.property?.title||"General inquiry"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate flex-1",children:s.lastMessage?.message}),e.jsx("span",{className:"text-xs text-muted-foreground ml-2",children:new Date(s.lastMessage?.createdAt||"").toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})]})},r)})})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:u?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"relative",children:e.jsxs(E,{className:"h-10 w-10",children:[e.jsx(P,{src:void 0}),e.jsx($,{children:S?.name?.charAt(0).toUpperCase()||"U"})]})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:S?.name||"Unknown User"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Interested in property"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(x,{size:"sm",variant:"outline",children:e.jsx(me,{className:"w-4 h-4"})}),e.jsx(x,{size:"sm",variant:"outline",children:e.jsx(ge,{className:"w-4 h-4"})}),e.jsxs(R,{children:[e.jsx(V,{asChild:!0,children:e.jsx(x,{size:"sm",variant:"outline",children:e.jsx(H,{className:"w-4 h-4"})})}),e.jsxs(B,{align:"end",children:[e.jsxs(j,{children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(j,{children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"Archive"]}),e.jsxs(j,{className:"text-red-600",onClick:()=>ae(u.id||u._id||""),children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]}),u.property&&e.jsxs("div",{className:"mt-3 p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium",children:u.property.title}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["₹",u.property.price.toLocaleString()]})]})]}),e.jsx(O,{className:"flex-1 p-4",children:J?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading messages..."})]})}):e.jsxs("div",{className:"space-y-4",children:[Z.map(s=>{const t=typeof s.sender=="string"?s.sender:s.sender._id,a=W?.id===t;return e.jsx("div",{className:`group flex ${a?"justify-end":"justify-start"} hover:bg-muted/30 rounded-lg p-1 transition-colors`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg p-3 ${a?"bg-primary text-primary-foreground":"bg-muted"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:s.attachments.map((r,l)=>e.jsx("div",{children:r.type==="image"?e.jsx("a",{href:r.url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:r.url,alt:r.name,className:"max-w-full rounded border border-border cursor-pointer hover:opacity-90",style:{maxHeight:"200px"}})}):e.jsxs("a",{href:r.url,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 p-2 rounded border ${a?"border-primary-foreground/20 hover:bg-primary-foreground/10":"border-border bg-background hover:bg-muted"}`,children:[e.jsx(Q,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm truncate",children:r.name})]})},l))}),e.jsxs("div",{className:`flex items-center justify-between mt-1 ${a?"text-primary-foreground/70":"text-muted-foreground"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs",children:new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),a&&e.jsx(z,{variant:"outline",className:"text-xs px-1 py-0",children:"You"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[a&&ie(s.status),a&&e.jsxs(R,{children:[e.jsx(V,{asChild:!0,children:e.jsx(x,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 opacity-50 group-hover:opacity-100 transition-opacity hover:bg-destructive/10",title:"Message options",children:e.jsx(H,{className:"w-3 h-3"})})}),e.jsx(B,{align:"end",children:e.jsxs(j,{className:"text-red-600 focus:text-red-600",onClick:()=>re(s._id),children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Delete Message"]})})]})]})]})]})},s._id)}),X&&e.jsx("div",{className:"flex justify-start mt-4",children:e.jsx("div",{className:"bg-muted p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[S?.name," is typing..."]})]})})})]})}),e.jsxs("div",{className:"p-4 border-t border-border",children:[p.length>0&&e.jsx("div",{className:"mb-2 flex flex-wrap gap-2",children:p.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2 bg-muted px-3 py-1 rounded-lg",children:[e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name}),e.jsx(x,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0",onClick:()=>se(t),children:"×"})]},t))}),e.jsxs("div",{className:"flex items-end space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("input",{ref:F,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:s=>D(s,"document"),multiple:!0}),e.jsx("input",{ref:_,type:"file",className:"hidden",accept:"image/*",onChange:s=>D(s,"image"),multiple:!0}),e.jsx(x,{size:"sm",variant:"outline",onClick:()=>F.current?.click(),disabled:f,children:e.jsx(Q,{className:"w-4 h-4"})}),e.jsx(x,{size:"sm",variant:"outline",onClick:()=>_.current?.click(),disabled:f,children:e.jsx(ve,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1",children:e.jsx(fe,{placeholder:"Type your message...",value:h,onChange:s=>M(s.target.value),className:"min-h-[60px] resize-none",onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),L())},disabled:f})}),e.jsx(x,{onClick:L,disabled:!h.trim()&&p.length===0||f,children:f?e.jsx(xe,{className:"w-4 h-4 animate-spin"}):e.jsx(ye,{className:"w-4 h-4"})})]})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(he,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the list to start messaging"})]})})})]})};export{Ue as default};
