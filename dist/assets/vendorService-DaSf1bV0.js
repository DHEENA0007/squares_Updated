import{t}from"./index-Ds-LUfCl.js";import{r as e}from"./reviewsService-BjiyFrCd.js";import"./ui-CEFKCYQo.js";import"./router-Bi51YGN-.js";import"./vendor-eVk5PToZ.js";const s=new class{async makeRequest(t,e={}){const s=`http://localhost:3001/api${t}`,a={headers:{"Content-Type":"application/json",...e.headers},...e},r=localStorage.getItem("token");r&&(a.headers={...a.headers,Authorization:`Bearer ${r}`});try{const t=await fetch(s,a);if(!t.ok){const e=await t.json().catch(()=>({success:!1,message:`HTTP ${t.status}: ${t.statusText}`}));throw new Error(e.message||"An error occurred")}return await t.json()}catch(i){throw i}}cleanObject(t){if(null===t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(t=>this.cleanObject(t)).filter(t=>void 0!==t);const e={};for(const[s,a]of Object.entries(t)){const t=this.cleanObject(a);void 0!==t&&(e[s]=t)}return Object.keys(e).length>0?e:void 0}async getVendorProfile(){try{let t;try{t=await this.makeRequest("/vendors/profile")}catch(s){t=await this.makeRequest("/users/profile")}if(t.success&&t.data){const s=t.data.user;try{const t=await e.getReviewStats();s.profile?.vendorInfo?.rating?(s.profile.vendorInfo.rating.average=t.averageRating,s.profile.vendorInfo.rating.count=t.totalReviews):s.profile?.vendorInfo&&(s.profile.vendorInfo.rating={average:t.averageRating,count:t.totalReviews})}catch(a){}return s}throw new Error("Failed to fetch vendor profile")}catch(r){const e=r instanceof Error?r.message:"Failed to fetch vendor profile";throw t({title:"Error",description:e,variant:"destructive"}),r}}async updateVendorProfile(e){try{let n=null;const o=localStorage.getItem("user");if(o)try{const t=JSON.parse(o);n=t.id||t._id}catch(s){}if(!n){const t=localStorage.getItem("token");if(t)try{const e=JSON.parse(atob(t.split(".")[1]));n=e.userId||e.id}catch(a){}}if(!n)try{const t=await this.makeRequest("/auth/me");t.success&&t.data&&(n=t.data.user.id||t.data.user._id,localStorage.setItem("user",JSON.stringify(t.data.user)))}catch(r){}if(!n)throw new Error("Unable to determine user ID. Please log in again.");const c=this.cleanObject(e);let d;try{d=await this.makeRequest("/vendors/profile",{method:"PUT",body:JSON.stringify(c)})}catch(i){d=await this.makeRequest(`/users/${n}`,{method:"PUT",body:JSON.stringify(c)})}if(d.success&&d.data)return localStorage.setItem("user",JSON.stringify(d.data.user)),t({title:"Success",description:"Profile updated successfully!"}),d.data.user;throw new Error("Failed to update vendor profile")}catch(n){const e=n instanceof Error?n.message:"Failed to update vendor profile";throw t({title:"Error",description:e,variant:"destructive"}),n}}async getVendorStatistics(){try{const t=await this.makeRequest("/vendors/statistics");return t.success&&t.data?t.data:{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}catch(t){return{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}}async checkSubscription(t){try{const e=await this.makeRequest(`/vendors/subscription/check/${t}`);return!(!e.success||!e.data)&&e.data.hasSubscription}catch(e){return!1}}async activateSubscription(t,e){try{return await this.makeRequest("/vendors/subscription/activate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,paymentId:e})})}catch(s){return{success:!1,message:"Failed to activate subscription. Please try again."}}}async getVendorSubscriptions(){try{const t=await this.makeRequest("/vendors/subscriptions");return t.success&&t.data?t.data.subscriptions:[]}catch(t){return[]}}async getSubscriptionLimits(){try{const t=await this.makeRequest("/vendors/subscription-limits");if(!t.success||!t.data)throw new Error("Failed to fetch subscription limits from server");return t.data}catch(t){throw t}}async cleanupSubscriptions(){try{const e=await this.makeRequest("/vendors/subscription/cleanup",{method:"POST"});return e.success?(t({title:"Subscriptions Cleaned Up",description:`Deactivated ${e.deactivatedCount} old subscriptions. Using latest subscription now.`}),await this.refreshSubscriptionData(),{success:!0,activeSubscription:e.activeSubscription,deactivatedCount:e.deactivatedCount}):{success:!1,activeSubscription:null,deactivatedCount:0}}catch(e){return t({title:"Error",description:"Failed to cleanup subscriptions",variant:"destructive"}),{success:!1,activeSubscription:null,deactivatedCount:0}}}async refreshSubscriptionData(){try{const e=await this.makeRequest("/vendors/subscription/refresh",{method:"POST"});if(e.success&&e.data){const s=[];for(let t=0;t<localStorage.length;t++){const e=localStorage.key(t);e&&(e.includes("subscription")||e.includes("limits")||e.includes("plan"))&&s.push(e)}return s.forEach(t=>localStorage.removeItem(t)),t({title:"Success",description:e.message||"Subscription data refreshed successfully!"}),e.data}throw new Error("Failed to refresh subscription data")}catch(e){const s=e instanceof Error?e.message:"Failed to refresh subscription data";throw t({title:"Error",description:s,variant:"destructive"}),e}}async updateVendorSettings(e){try{const s=this.cleanObject(e),a=await this.makeRequest("/vendors/settings",{method:"PUT",body:JSON.stringify({...s,meta:{lastUpdated:(new Date).toISOString(),version:"2.0",source:"dynamic-vendor-settings",supportEmail:"support@buildhomemartsquares.com"}})});if(a.success)return localStorage.setItem("dynamicVendorSettings",JSON.stringify(a.data)),t({title:"âœ… Settings Synced",description:"All vendor preferences saved successfully."}),a.data;throw new Error("Failed to update vendor settings")}catch(s){const a="dynamicVendorSettings",r={...e,meta:{lastUpdated:(new Date).toISOString(),version:"2.0",source:"dynamic-vendor-settings-offline",pendingSync:!0,supportEmail:"support@buildhomemartsquares.com"}};return localStorage.setItem(a,JSON.stringify(r)),t({title:"ðŸ’¾ Settings Saved Offline",description:"Settings cached locally. Will sync when online."}),r}}async getVendorSettings(){try{const t=await this.makeRequest("/vendors/settings");if(t.success&&t.data)return t.data;const e=localStorage.getItem("dynamicVendorSettings");return e?JSON.parse(e):null}catch(t){const e=localStorage.getItem("dynamicVendorSettings");return e?JSON.parse(e):null}}async sendVendorSettingsNotification(t,e,s){try{(new Date).toISOString()}catch(a){}}async updateVendorPreferences(e,s){try{const t=await this.getVendorSettings()||{},a={...t,preferences:{...t.preferences,[e]:s},meta:{lastUpdated:(new Date).toISOString(),lastChangedField:e,source:"real-time-update"}};await this.updateVendorSettings(a);e.replace(/([A-Z])/g," $1").toLowerCase()}catch(a){t({title:"Update Failed",description:"Preference will sync when connection is restored.",variant:"destructive"})}}async validateVendorSubscription(){try{const t=await this.makeRequest("/vendors/subscription/validate");if(!t.success||!t.data)throw new Error("Failed to validate subscription from server");return t.data}catch(t){throw t}}async getAutoResponseSettings(){try{const t=await this.getVendorSettings();return{enabled:t?.business?.autoResponseEnabled||!1,message:t?.business?.autoResponseMessage||"Thank you for your interest! I'll get back to you soon."}}catch(t){return{enabled:!1,message:"Thank you for your interest! I'll get back to you soon."}}}async updateAutoResponseSettings(e,s){try{await this.updateVendorPreferences("business.autoResponseEnabled",e),s.trim()&&await this.updateVendorPreferences("business.autoResponseMessage",s),t({title:"Auto-Response Updated",description:e?"Auto-responses are now enabled":"Auto-responses have been disabled"})}catch(a){throw a}}async isVendorEnterpriseProperty(t){try{const e=await this.makeRequest(`/vendors/${t}/enterprise-check`);return!(!e.success||!e.data)&&e.data.isEnterprise}catch(e){return!1}}};export{s as default,s as vendorService};
