import{j as e}from"./ui-s1SEoZIF.js";import{u as s,B as a,ab as t,ac as i,ad as l,ae as n,a as c,b as r,c as d,e as o,aN as m,M as h,I as u,T as x,m as j,n as f,o as p,p as N,q as g,U as v,a0 as b,aO as y,f as w,E as S,a1 as D,a2 as C,a3 as T,aB as I,a9 as k,V as A,W as _,h as E,C as P}from"./index-YrVmIx3a.js";import{d as $,r as M}from"./router-D8v2YSKU.js";import{C as O}from"./checkbox-OYdlbG4C.js";import{T as F,a as B,b as R,c as z,d as L,e as V}from"./table-BdC2txne.js";import{L as q}from"./lock-boUV--bw.js";import{S as H}from"./send-IVeIvFQ5.js";import{S as Y}from"./square-pen-PCmihWrK.js";import{R as W}from"./rotate-ccw-BQgocZh5.js";import{f as U}from"./format-C8LJbt2l.js";import"./vendor-BxThA0WO.js";const J=()=>{const{user:J}=s(),G=$(),K=J?.rolePermissions||[],Q=e=>K.includes(e),X=Q(A.NOTIFICATIONS_SEND),Z=Q(A.NOTIFICATIONS_DELETE),[ee,se]=M.useState("compose"),[ae,te]=M.useState("all_users"),[ie,le]=M.useState(""),[ne,ce]=M.useState(""),[re,de]=M.useState(""),[oe,me]=M.useState(""),[he,ue]=M.useState(!1),[xe,je]=M.useState(["push"]),[fe,pe]=M.useState(!1),[Ne,ge]=M.useState(null),[ve,be]=M.useState({all_users:0,customers:0,vendors:0,active_users:0,premium_users:0}),[ye,we]=M.useState([]),[Se,De]=M.useState(!1);M.useEffect(()=>{if(!Q(A.NOTIFICATIONS_VIEW))return void G("/rolebased");(async()=>{try{const e=await fetch("/api/admin/notifications/audience-counts",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(e.ok){const s=await e.json();s.success&&be(s.counts)}}catch(e){}})()},[K]),M.useEffect(()=>{"history"===ee&&Ce()},[ee]);const Ce=async(e=!1)=>{e||De(!0);try{const e=await fetch("/api/admin/notifications/history",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(e.ok){const s=await e.json();s.success&&we(s.notifications)}}catch(s){}finally{e||De(!1)}};if(!Q(A.NOTIFICATIONS_VIEW))return null;const[Te,Ie]=M.useState(new Date);M.useEffect(()=>{if(!ye.some(e=>"scheduled"===e.status&&e.scheduledDate))return;const e=setInterval(()=>{Ie(new Date)},1e3);return()=>clearInterval(e)},[ye]),M.useEffect(()=>{if(!ye.some(e=>{if("sending"===e.status)return!0;if("scheduled"===e.status&&e.scheduledDate){return new Date(e.scheduledDate).getTime()<=Date.now()+12e4}return!1})||"history"!==ee)return;const e=setInterval(()=>{Ce(!0)},5e3);return()=>clearInterval(e)},[ye,ee]);const ke=[{value:"all_users",label:"All Users",count:ve.all_users},{value:"customers",label:"Customers Only",count:ve.customers},{value:"vendors",label:"Vendors/Builders",count:ve.vendors},{value:"active_users",label:"Active Users (Last 30 days)",count:ve.active_users},{value:"premium_users",label:"Premium Subscribers",count:ve.premium_users}],Ae=[{id:"push",label:"Push Notifications",icon:m,description:"Mobile and web push notifications"},{id:"email",label:"Email",icon:h,description:"Email notifications"}],_e=()=>ke.find(e=>e.value===ae)||ke[0],Ee=s=>{switch(s){case"sent":return e.jsxs(a,{className:"bg-green-500 hover:bg-green-600",children:[e.jsx(P,{className:"w-3 h-3 mr-1"})," Sent"]});case"sending":return e.jsxs(a,{className:"bg-blue-500 hover:bg-blue-600",children:[e.jsx(W,{className:"w-3 h-3 mr-1 animate-spin"})," Sending"]});case"scheduled":return e.jsxs(a,{className:"bg-yellow-500 hover:bg-yellow-600",children:[e.jsx(E,{className:"w-3 h-3 mr-1"})," Scheduled"]});case"draft":return e.jsxs(a,{variant:"secondary",children:[e.jsx(Y,{className:"w-3 h-3 mr-1"})," Draft"]});case"failed":return e.jsxs(a,{variant:"destructive",children:[e.jsx(_,{className:"w-3 h-3 mr-1"})," Failed"]});default:return e.jsx(a,{variant:"secondary",children:s})}};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Notifications"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage and send system notifications"})]}),!X&&e.jsxs(a,{variant:"destructive",className:"flex gap-1 items-center",children:[e.jsx(q,{className:"w-3 h-3"}),"View Only Mode"]})]}),e.jsxs(t,{defaultValue:"compose",value:ee,onValueChange:se,className:"space-y-6",children:[e.jsxs(i,{children:[e.jsx(l,{value:"compose",children:"Compose Notification"}),e.jsx(l,{value:"history",children:"Notification History"})]}),e.jsx(n,{value:"compose",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(c,{className:X?"":"opacity-60 pointer-events-none",children:[e.jsx(r,{children:e.jsx(d,{children:"Quick Templates"})}),e.jsx(o,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[{_id:"1",name:"New Properties Alert",subject:"New Properties in Your Area!",content:"Discover amazing new properties that match your preferences. Check them out now!",type:"promotional",channels:["push","email"]},{_id:"2",name:"Price Drop Alert",subject:"Price Drop Alert - Save Big!",content:"Great news! Properties you're watching have reduced their prices. Don't miss out!",type:"alert",channels:["push","email"]},{_id:"3",name:"System Maintenance",subject:"Scheduled Maintenance Notice",content:"We'll be performing system maintenance on [DATE]. The platform will be unavailable for 2 hours.",type:"informational",channels:["email","push"]}].map(s=>e.jsxs("div",{className:"p-3 border rounded-lg cursor-pointer hover:bg-accent transition-colors",onClick:()=>(e=>{if(!X)return;le(e.subject),ce(e.content);const s=e.channels.filter(e=>"sms"!==e);je(s.length>0?s:["push"]),ge(null)})(s),children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:s.subject}),e.jsx("div",{className:"flex gap-1 mt-2",children:s.channels.filter(e=>"sms"!==e).map(s=>{const a=Ae.find(e=>e.id===s),t=a?.icon||m;return e.jsx(t,{className:"w-3 h-3 text-muted-foreground"},s)})})]},s._id))})})]}),e.jsxs(c,{children:[e.jsx(r,{children:e.jsx(d,{children:"Notification Content"})}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Subject/Title *"}),e.jsx(u,{placeholder:"Enter notification subject...",value:ie,onChange:e=>le(e.target.value),disabled:!X})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Message Content *"}),e.jsx(x,{placeholder:"Enter your notification message...",value:ne,onChange:e=>ce(e.target.value),rows:6,disabled:!X})]})]})]}),e.jsxs(c,{children:[e.jsx(r,{children:e.jsx(d,{children:"Delivery Channels *"})}),e.jsx(o,{children:e.jsx("div",{className:"space-y-3",children:Ae.map(s=>{const a=s.icon;return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(O,{id:s.id,checked:xe.includes(s.id),onCheckedChange:e=>((e,s)=>{X&&je(s?[...xe,e]:xe.filter(s=>s!==e))})(s.id,e),disabled:!X}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(a,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("label",{htmlFor:s.id,className:"text-sm font-medium cursor-pointer",children:s.label})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.description})]},s.id)})})})]}),e.jsxs(c,{children:[e.jsx(r,{children:e.jsx(d,{children:"Scheduling"})}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{id:"schedule",checked:he,onCheckedChange:e=>ue(e),disabled:!X}),e.jsx("label",{htmlFor:"schedule",className:"text-sm font-medium cursor-pointer",children:"Schedule for later"})]}),he&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Date"}),e.jsx(u,{type:"date",value:re,onChange:e=>de(e.target.value),min:(new Date).toISOString().split("T")[0],disabled:!X})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Time"}),e.jsx(u,{type:"time",value:oe,onChange:e=>me(e.target.value),disabled:!X})]})]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(c,{children:[e.jsx(r,{children:e.jsx(d,{children:"Target Audience"})}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs(j,{value:ae,onValueChange:te,disabled:!X,children:[e.jsx(f,{children:e.jsx(p,{})}),e.jsx(N,{children:ke.map(s=>e.jsx(g,{value:s.value,children:e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("span",{children:s.label}),s.count>=0&&e.jsx(a,{variant:"secondary",className:"ml-2",children:s.count.toLocaleString()})]})},s.value))})]}),e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(v,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"font-medium text-sm",children:"Estimated Reach"})]}),e.jsxs("div",{className:"text-lg font-bold text-blue-600",children:[_e().count.toLocaleString()," users"]})]})]})]}),e.jsxs(c,{children:[e.jsx(r,{children:e.jsx(d,{children:"Preview"})}),e.jsx(o,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs(b,{children:[e.jsx(y,{asChild:!0,children:e.jsxs(w,{variant:"outline",className:"w-full",children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"Preview Notification"]})}),e.jsxs(D,{children:[e.jsx(C,{children:e.jsx(T,{children:"Notification Preview"})}),e.jsxs("div",{className:"space-y-4",children:[xe.includes("push")&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm mb-2",children:"Push Notification"}),e.jsxs("div",{className:"p-3 border rounded-lg bg-gray-50 max-w-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(m,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"font-medium text-sm",children:"BuildHomeMartSquares"})]}),e.jsx("div",{className:"font-medium text-sm mb-1",children:ie||"Subject"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:ne||"Message content will appear here..."})]})]}),xe.includes("email")&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm mb-2",children:"Email"}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"border-b pb-2 mb-3",children:[e.jsx("div",{className:"font-medium",children:ie||"Subject"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"from: noreply@ninetyniineacres.com"})]}),e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:ne||"Message content will appear here..."})]})]})]})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Channels:"}),e.jsx("span",{children:xe.length})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Recipients:"}),e.jsx("span",{children:_e().count.toLocaleString()})]}),he&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Scheduled:"}),e.jsxs("span",{children:[re," ",oe]})]})]})]})})]}),e.jsx(c,{children:e.jsx(o,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(w,{onClick:async()=>{if(X)if(ie.trim()&&ne.trim()&&0!==xe.length){pe(!0);try{const e={subject:ie,message:ne,targetAudience:ae,channels:xe,isScheduled:he,scheduledDate:he?`${re}T${oe}`:null,notificationId:Ne},s=await fetch("/api/admin/notifications/send",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),a=await s.json();if(s.ok&&a.success){let e="Notification processed successfully!";a.detailedStatus&&(e+=` (Email: ${a.detailedStatus.email?.sent||0} sent, Push: ${a.detailedStatus.push?.sent||0} sent)`),alert(e),le(""),ce(""),je(["push"]),ue(!1),de(""),me(""),ge(null),"history"===ee&&Ce()}else alert(a.message||"Failed to send notification")}catch(e){alert("Failed to send notification")}finally{pe(!1)}}else alert("Please fill in all required fields and select at least one channel");else alert("You do not have permission to send notifications.")},disabled:fe||!X||!ie.trim()||!ne.trim()||0===xe.length,className:"w-full",children:fe?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Sending..."]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{className:"w-4 h-4"}),X?he?"Schedule Notification":"Send Now":"Permission Required"]})}),X&&e.jsx(w,{onClick:async()=>{if(X)if(ie.trim()){pe(!0);try{const e={subject:ie,message:ne,targetAudience:ae,channels:xe,isScheduled:he,scheduledDate:he?`${re}T${oe}`:null,saveAsDraft:!0,notificationId:Ne},s=await fetch("/api/admin/notifications/send",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),a=await s.json();s.ok&&a.success?(alert("Draft saved successfully"),a.notification&&ge(a.notification._id)):alert(a.message||"Failed to save draft")}catch(e){alert("Failed to save draft")}finally{pe(!1)}}else alert("Please enter a subject to save as draft");else alert("You do not have permission to save drafts.")},disabled:fe||!ie.trim(),variant:"outline",className:"w-full",children:"Save as Draft"})]})})})]})]})}),e.jsx(n,{value:"history",children:e.jsxs(c,{children:[e.jsx(r,{children:e.jsx(d,{children:"Notification History"})}),e.jsx(o,{children:Se?e.jsx("div",{className:"text-center py-8",children:"Loading history..."}):0===ye.length?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No notifications sent yet."}):e.jsxs(F,{children:[e.jsx(B,{children:e.jsxs(R,{children:[e.jsx(z,{children:"Date"}),e.jsx(z,{children:"Subject"}),e.jsx(z,{children:"Audience"}),e.jsx(z,{children:"Channels"}),e.jsx(z,{children:"Recipients"}),e.jsx(z,{children:"Read Rate"}),e.jsx(z,{children:"Status"}),(X||Z)&&e.jsx(z,{className:"text-right",children:"Actions"})]})}),e.jsx(L,{children:ye.map(s=>{let t=null;if("scheduled"===s.status&&s.scheduledDate){const e=new Date(s.scheduledDate).getTime()-Te.getTime();if(e>0){const s=Math.floor(e/864e5),a=Math.floor(e%864e5/36e5),i=Math.floor(e%36e5/6e4),l=Math.floor(e%6e4/1e3);t=s>0?`${s}d ${a}h`:a>0?`${a}h ${i}m`:`${i}m ${l}s`}else t="Processing..."}return e.jsxs(R,{children:[e.jsx(V,{className:"font-medium text-xs text-muted-foreground",children:U(new Date(s.createdAt),"MMM d, yyyy HH:mm")}),e.jsxs(V,{children:[e.jsx("div",{className:"font-medium",children:s.subject}),e.jsx("div",{className:"text-xs text-muted-foreground line-clamp-1",children:s.message})]}),e.jsx(V,{children:e.jsx(a,{variant:"outline",className:"capitalize",children:s.targetAudience.replace("_"," ")})}),e.jsx(V,{children:e.jsxs("div",{className:"flex gap-1",children:[s.channels.includes("push")&&e.jsx(m,{className:"w-4 h-4 text-blue-500"}),s.channels.includes("email")&&e.jsx(h,{className:"w-4 h-4 text-purple-500"}),s.channels.includes("sms")&&e.jsx(I,{className:"w-4 h-4 text-green-500"})]})}),e.jsx(V,{children:s.statistics?.totalRecipients||0}),e.jsx(V,{children:"sent"===s.status&&s.statistics?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium",children:[s.statistics.opened||0,"/",s.statistics.delivered||0]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"read"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.statistics.delivered||0,"/",s.statistics.totalRecipients||0," delivered"]})}),s.statistics.openRate>0&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-xs text-green-600 font-medium",children:[s.statistics.openRate?.toFixed(1),"% rate"]})})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"N/A"})}),e.jsx(V,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[Ee(s.status),t&&e.jsxs("span",{className:"text-xs font-mono text-blue-600 bg-blue-50 px-1 py-0.5 rounded w-fit",children:["in ",t]})]})}),(X||Z)&&e.jsx(V,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[X&&"draft"===s.status&&e.jsx(w,{size:"sm",variant:"ghost",onClick:()=>(e=>{if(X){if(le(e.subject),ce(e.message),te(e.targetAudience),je(e.channels),ge(e._id),e.isScheduled&&e.scheduledDate){ue(!0);const s=new Date(e.scheduledDate);de(s.toISOString().split("T")[0]),me(s.toTimeString().slice(0,5))}else ue(!1),de(""),me("");se("compose")}else alert("You do not have permission to edit drafts.")})(s),title:"Edit Draft",children:e.jsx(Y,{className:"w-4 h-4"})}),Z&&e.jsx(w,{size:"sm",variant:"ghost",className:"text-red-600 hover:text-red-700 hover:bg-red-50",onClick:()=>(async e=>{if(Z){if(confirm("Are you sure you want to delete this notification?"))try{const s=await fetch(`/api/admin/notifications/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),a=await s.json();s.ok&&a.success?(alert("Notification deleted successfully"),Ce()):alert(a.message||"Failed to delete notification")}catch(s){alert("Failed to delete notification")}}else alert("You do not have permission to delete notifications.")})(s._id),title:"Delete Notification",children:e.jsx(k,{className:"w-4 h-4"})})]})})]},s._id)})})]})})]})})]})]})};export{J as default};
