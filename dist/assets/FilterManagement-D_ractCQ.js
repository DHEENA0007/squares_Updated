import{j as e}from"./ui-BNZSgpjP.js";import{r as s,d as a}from"./router-D8v2YSKU.js";import{u as l,a2 as t,l as r,a3 as i,f as n,a9 as c,af as d,ag as o,ah as u,ai as h,a4 as p,a5 as x,a6 as m,a7 as j,a8 as v,L as y,q as g,r as f,s as F,v as N,w as _,B as b,ad as C,I as w,G as T,ae as S,Z as E,ac as V,aj as R,a as A,e as D}from"./index-AgUnwITA.js";import{T as L,a as k,b as O,c as I,d as P,e as z}from"./table-DK1Ni377.js";import{P as M}from"./pencil-CTVUUVC2.js";import{A as q,a as U}from"./alert-CCpzKqmA.js";import"./vendor-BxThA0WO.js";const B=()=>{const{user:a}=l(),{toast:R}=t(),A=a?.rolePermissions||[],D="admin"===a?.role||"superadmin"===a?.role,q=e=>A.includes(e),U=D||q(E.FILTER_CREATE_NTP),B=D||q(E.FILTER_CREATE_FTO),$=D||q(E.FILTER_EDIT),K=D||q(E.FILTER_DELETE),Y=D||q(E.FILTER_STATUS);D||q(E.FILTER_ORDER);const[G,Z]=s.useState([]),[H,J]=s.useState([]),[Q,W]=s.useState(!0),[X,ee]=s.useState(!1),[se,ae]=s.useState(!1),[le,te]=s.useState(null),[re,ie]=s.useState(""),[ne,ce]=s.useState(""),[de,oe]=s.useState(""),[ue,he]=s.useState({filter_type:"",name:"",value:"",min_value:void 0,max_value:void 0,display_label:"",display_order:0}),[pe,xe]=s.useState([]),[me,je]=s.useState(!1),[ve,ye]=s.useState({targetFilterType:"",sourceFilterType:"",sourceFilterValues:[]}),[ge,fe]=s.useState([]),[Fe,Ne]=s.useState(""),[_e,be]=s.useState([]),[Ce,we]=s.useState(!1),[Te,Se]=s.useState(r.isReady());s.useEffect(()=>{Ve(),Ee(),r.initialize().then(()=>{Se(!0)}).catch(console.error)},[]);const Ee=async()=>{try{const e=await i.getFilterDependencies();xe(e)}catch(e){}};s.useEffect(()=>{(async()=>{if(ve.sourceFilterType)if("property_type"===ve.sourceFilterType){const e=await i.getAllPropertyTypes(!1);fe(e.map(e=>({label:e.name,value:e.value})))}else{const e=Re(ve.sourceFilterType);fe(e.map(e=>({label:e.displayLabel||e.name,value:e.value})))}else fe([])})()},[ve.sourceFilterType,G]);const Ve=async()=>{try{W(!0);const e=await i.getAllFilterConfigurations(!0);Z(e);const s=Array.from(new Set(e.map(e=>e.filterType)));J(s.sort()),s.length>0&&!re&&ie(s[0])}catch(e){R({title:"Error",description:"Failed to fetch filter configurations",variant:"destructive"})}finally{W(!1)}},Re=e=>G.filter(s=>s.filterType===e).sort((e,s)=>e.displayOrder-s.displayOrder),Ae=()=>{if(!ne.trim())return;const e=ne.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"");H.includes(e)?R({title:"Error",description:"Filter type already exists",variant:"destructive"}):(J([...H,e].sort()),ie(e),ae(!1),ce(""),R({title:"Success",description:`Filter type "${e}" created. You can now add options to it.`}))},De=e=>{e?(te(e),he({filter_type:e.filterType,name:e.name,value:e.value,min_value:e.minValue,max_value:e.maxValue,display_label:e.displayLabel,display_order:e.displayOrder}),"location"===e.filterType&&Ne(e.name)):(te(null),he({filter_type:re,name:"",value:"",min_value:void 0,max_value:void 0,display_label:"",display_order:0}),Ne("")),ee(!0)},Le=()=>{ee(!1),te(null),he({filter_type:"",name:"",value:"",min_value:void 0,max_value:void 0,display_label:"",display_order:0}),Ne(""),be([])},ke=s=>{const a=Re(s);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{children:e.jsxs("h4",{className:"text-sm font-medium text-muted-foreground",children:[a.length," options configured"]})}),B&&e.jsxs(n,{size:"sm",onClick:()=>De(),children:[e.jsx(c,{className:"h-4 w-4 mr-2"}),"Add Option"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(L,{children:[e.jsx(k,{children:e.jsxs(O,{children:[e.jsx(I,{children:"Display Order"}),e.jsx(I,{children:"Name"}),e.jsx(I,{children:"Value"}),e.jsx(I,{children:"Display Label"}),e.jsx(I,{children:"Status"}),e.jsx(I,{className:"text-right",children:"Actions"})]})}),e.jsx(P,{children:0===a.length?e.jsx(O,{children:e.jsx(z,{colSpan:6,className:"text-center py-8 text-muted-foreground",children:"No options found for this filter type."})}):a.map(s=>e.jsxs(O,{children:[e.jsx(z,{children:s.displayOrder}),e.jsx(z,{className:"font-medium",children:s.name}),e.jsx(z,{children:e.jsx(b,{variant:"outline",children:s.value})}),e.jsx(z,{children:s.displayLabel||"-"}),e.jsx(z,{children:e.jsx(V,{checked:s.isActive,onCheckedChange:()=>Y&&(async e=>{try{await i.updateFilterConfiguration(e.id,{isActive:!e.isActive}),R({title:"Success",description:`Filter ${e.isActive?"deactivated":"activated"} successfully`}),Ve()}catch(s){R({title:"Error",description:"Failed to update filter status",variant:"destructive"})}})(s),disabled:!Y})}),e.jsx(z,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[$&&e.jsx(n,{variant:"ghost",size:"icon",onClick:()=>De(s),children:e.jsx(M,{className:"h-4 w-4"})}),K&&e.jsx(n,{variant:"ghost",size:"icon",className:"text-destructive hover:text-destructive",onClick:()=>(async e=>{if(confirm("Are you sure you want to delete this filter option?"))try{await i.deleteFilterConfiguration(e),R({title:"Success",description:"Filter deleted successfully"}),Ve()}catch(s){R({title:"Error",description:"Failed to delete filter",variant:"destructive"})}})(s.id),children:e.jsx(C,{className:"h-4 w-4"})})]})})]},s.id))})]})})]})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Filter Configurations"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage filter options for property search and filtering"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{variant:"outline",onClick:()=>je(!0),children:"Manage Dependencies"}),U&&e.jsxs(n,{onClick:()=>ae(!0),children:[e.jsx(c,{className:"h-4 w-4 mr-2"}),"New Filter Type"]})]})]}),0===H.length?e.jsxs("div",{className:"border rounded-lg p-8 text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"No filter types found. Create your first filter type to get started."}),U&&e.jsxs(n,{onClick:()=>ae(!0),children:[e.jsx(c,{className:"h-4 w-4 mr-2"}),"Create First Filter Type"]})]}):e.jsxs(d,{value:re,onValueChange:ie,children:[e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto",children:e.jsx(o,{className:"inline-flex",children:H.map(s=>e.jsx(u,{value:s,children:s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},s))})}),H.map(s=>e.jsx(h,{value:s,children:ke(s)},s))]}),e.jsx(p,{open:me,onOpenChange:je,children:e.jsxs(x,{className:"max-w-3xl",children:[e.jsxs(m,{children:[e.jsx(j,{children:"Manage Filter Dependencies"}),e.jsx(v,{children:"Configure which filters should appear based on other filter selections."})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 items-end border p-4 rounded-lg bg-muted/20",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Target Filter (Show this...)"}),e.jsxs(g,{value:ve.targetFilterType,onValueChange:e=>ye({...ve,targetFilterType:e}),children:[e.jsx(f,{children:e.jsx(F,{placeholder:"Select filter"})}),e.jsx(N,{children:H.map(s=>e.jsx(_,{value:s,children:s.replace(/_/g," ")},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Source Filter (...when this is selected)"}),e.jsxs(g,{value:ve.sourceFilterType,onValueChange:e=>ye({...ve,sourceFilterType:e,sourceFilterValues:[]}),children:[e.jsx(f,{children:e.jsx(F,{placeholder:"Select parent filter"})}),e.jsxs(N,{children:[e.jsx(_,{value:"property_type",children:"Property Type"}),H.filter(e=>e!==ve.targetFilterType).map(s=>e.jsx(_,{value:s,children:s.replace(/_/g," ")},s))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Trigger Values (Matches any)"}),e.jsxs(g,{disabled:!ve.sourceFilterType,onValueChange:e=>{ve.sourceFilterValues.includes(e)||ye({...ve,sourceFilterValues:[...ve.sourceFilterValues,e]})},children:[e.jsx(f,{children:e.jsx(F,{placeholder:"Add value..."})}),e.jsx(N,{children:ge.map(s=>e.jsx(_,{value:s.value,children:s.label},s.value))})]}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:ve.sourceFilterValues.map(s=>e.jsxs(b,{variant:"secondary",className:"cursor-pointer",onClick:()=>{ye({...ve,sourceFilterValues:ve.sourceFilterValues.filter(e=>e!==s)})},children:[ge.find(e=>e.value===s)?.label||s," ×"]},s))})]})]}),e.jsx(n,{onClick:async()=>{if(!ve.targetFilterType||!ve.sourceFilterType||0===ve.sourceFilterValues.length)return void R({title:"Error",description:"Please fill all fields",variant:"destructive"});const e=[...pe,ve];try{await i.saveFilterDependencies(e),xe(e),je(!1),ye({targetFilterType:"",sourceFilterType:"",sourceFilterValues:[]}),R({title:"Success",description:"Dependency saved successfully"})}catch(s){R({title:"Error",description:"Failed to save dependency",variant:"destructive"})}},className:"w-full",children:"Add Rule"}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(L,{children:[e.jsx(k,{children:e.jsxs(O,{children:[e.jsx(I,{children:"Target Filter"}),e.jsx(I,{children:"Depends On"}),e.jsx(I,{children:"Values"}),e.jsx(I,{className:"text-right",children:"Action"})]})}),e.jsx(P,{children:0===pe.length?e.jsx(O,{children:e.jsx(z,{colSpan:4,className:"text-center text-muted-foreground",children:"No dependencies configured"})}):pe.map((s,a)=>e.jsxs(O,{children:[e.jsx(z,{className:"font-medium",children:s.targetFilterType}),e.jsx(z,{children:s.sourceFilterType}),e.jsx(z,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:s.sourceFilterValues.map(s=>e.jsx(b,{variant:"outline",className:"text-xs",children:s},s))})}),e.jsx(z,{className:"text-right",children:e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>(async e=>{const s=pe.filter((s,a)=>a!==e);try{await i.saveFilterDependencies(s),xe(s),R({title:"Success",description:"Dependency deleted successfully"})}catch(a){R({title:"Error",description:"Failed to delete dependency",variant:"destructive"})}})(a),children:e.jsx(C,{className:"h-4 w-4 text-destructive"})})})]},a))})]})})]})]})}),e.jsx(p,{open:X,onOpenChange:ee,children:e.jsxs(x,{children:[e.jsxs(m,{children:[e.jsx(j,{children:le?"Edit Filter":"Add Filter"}),e.jsx(v,{children:le?"Update the filter details below":"Create a new filter option"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"filter_type",children:"Filter Type"}),e.jsxs(g,{value:ue.filter_type,onValueChange:e=>{he({...ue,filter_type:e}),"location"!==e&&(Ne(""),be([]))},disabled:!!le,children:[e.jsx(f,{children:e.jsx(F,{})}),e.jsx(N,{children:H.map(s=>e.jsx(_,{value:s,children:s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},s))})]})]}),"location"===ue.filter_type?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"location_search",children:"Search Location"}),e.jsxs("div",{className:"relative",children:[e.jsx(w,{id:"location_search",value:Fe,onChange:e=>{const s=e.target.value;Ne(s),s.length>2?(we(!0),setTimeout(()=>{const e=r.searchLocations(s);be(e),we(!1)},100)):be([])},placeholder:r.isReady()?"Search city, district, or pincode...":"Initializing location database...",className:"pr-10",disabled:!r.isReady()}),(!r.isReady()||Ce)&&e.jsx("div",{className:"absolute right-3 top-2.5",children:e.jsx(T,{className:"h-4 w-4 animate-spin text-muted-foreground"})}),Fe.length>2&&0===_e.length&&!Ce&&r.isReady()&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-md p-4 text-sm text-center text-muted-foreground",children:['No locations found matching "',Fe,'"']}),_e.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-md max-h-60 overflow-y-auto",children:_e.map((s,a)=>e.jsxs("div",{className:"px-4 py-2 hover:bg-accent hover:text-accent-foreground cursor-pointer text-sm border-b last:border-0",onClick:()=>{const e=s.city,a=s.city.toLowerCase().replace(/\s+/g,"-");he({...ue,name:e,value:a,display_label:e}),Ne(e),be([])},children:[e.jsx("div",{className:"font-medium text-foreground",children:s.city}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.district,", ",s.state," - ",s.pincode]})]},`${s.pincode}-${a}`))})]}),!r.isReady()&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Please wait while we load the location database (approx. 20MB)..."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"name",children:"Selected Name"}),e.jsx(w,{id:"name",value:ue.name,onChange:e=>he({...ue,name:e.target.value}),readOnly:!0,className:"bg-muted"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"value",children:"Selected Value"}),e.jsx(w,{id:"value",value:ue.value,onChange:e=>he({...ue,value:e.target.value}),readOnly:!0,className:"bg-muted"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"name",children:"Name *"}),e.jsx(w,{id:"name",value:ue.name,onChange:e=>he({...ue,name:e.target.value}),placeholder:"e.g., For Sale",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"value",children:"Value (Unique ID) *"}),e.jsx(w,{id:"value",value:ue.value,onChange:e=>he({...ue,value:e.target.value}),placeholder:"e.g., sale",disabled:!!le,required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"display_label",children:"Display Label (Optional)"}),e.jsx(w,{id:"display_label",value:ue.display_label,onChange:e=>he({...ue,display_label:e.target.value}),placeholder:"Defaults to Name if not provided"})]}),["budget","area"].includes(ue.filter_type)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{htmlFor:"min_value",children:["Min Value ","budget"===ue.filter_type?"(₹)":"(sq ft)"]}),e.jsx(w,{id:"min_value",type:"number",value:ue.min_value||"",onChange:e=>he({...ue,min_value:e.target.value?parseFloat(e.target.value):void 0}),placeholder:"budget"===ue.filter_type?"e.g., 2000000":"e.g., 1000"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{htmlFor:"max_value",children:["Max Value ","budget"===ue.filter_type?"(₹)":"(sq ft)"]}),e.jsx(w,{id:"max_value",type:"number",value:ue.max_value||"",onChange:e=>he({...ue,max_value:e.target.value?parseFloat(e.target.value):void 0}),placeholder:"budget"===ue.filter_type?"e.g., 4000000":"e.g., 2000"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"display_order",children:"Display Order"}),e.jsx(w,{id:"display_order",type:"number",value:ue.display_order,onChange:e=>he({...ue,display_order:parseInt(e.target.value)||0})})]})]}),e.jsxs(S,{children:[e.jsx(n,{variant:"outline",onClick:Le,children:"Cancel"}),e.jsx(n,{onClick:async()=>{try{if(!ue.filter_type||!ue.name||!ue.value)return void R({title:"Error",description:"Please fill in all required fields",variant:"destructive"});le?(await i.updateFilterConfiguration(le.id,ue),R({title:"Success",description:"Filter updated successfully"})):(await i.createFilterConfiguration(ue),R({title:"Success",description:"Filter created successfully"})),Ve(),Le()}catch(e){R({title:"Error",description:"Failed to save filter configuration",variant:"destructive"})}},children:le?"Update":"Create"})]})]})}),e.jsx(p,{open:se,onOpenChange:ae,children:e.jsxs(x,{children:[e.jsxs(m,{children:[e.jsx(j,{children:"Create New Filter Type"}),e.jsx(v,{children:"Create a new filter category to organize your property search filters"})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"newFilterTypeName",children:"Filter Type Name *"}),e.jsx(w,{id:"newFilterTypeName",value:ne,onChange:e=>ce(e.target.value),placeholder:"e.g., Property Status, Location Type, Price Range",onKeyDown:e=>{"Enter"===e.key&&Ae()}}),e.jsx("p",{className:"text-xs text-muted-foreground",children:'This will be converted to lowercase with underscores (e.g., "property_status")'})]})}),e.jsxs(S,{children:[e.jsx(n,{variant:"outline",onClick:()=>{ae(!1),ce("")},children:"Cancel"}),e.jsx(n,{onClick:Ae,children:"Create Filter Type"})]})]})})]})},$=()=>{const{user:r}=l(),i=a(),{toast:n}=t(),c=r?.rolePermissions||[],d="admin"===r?.role||"superadmin"===r?.role||(o=E.FILTER_READ,c.includes(o));var o;return s.useEffect(()=>{d||(n({title:"Access Denied",description:"You don't have permission to view filter management.",variant:"destructive"}),i("/rolebased"))},[d,i,n]),d?e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(R,{className:"h-8 w-8"}),"Filter Management"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Configure search filters for the property search page"})]})}),e.jsx(q,{children:e.jsxs(U,{children:[e.jsx("strong",{children:"Note:"})," These filters appear on the customer property search page. Create dynamic filter types like Bedrooms, Budget, Listing Type, Furnishing, etc."]})}),e.jsx(A,{children:e.jsx(D,{className:"pt-6",children:e.jsx(B,{})})})]}):null};export{$ as default};
