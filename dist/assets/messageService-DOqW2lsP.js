import{t as e}from"./index-CV77Hym3.js";import{u as t}from"./uploadService-Bwy6d1dt.js";const s="https://api.buildhomemartsquares.com/api";class a{async makeRequest(e,t={}){const a=`${s}${e}`,r={headers:{"Content-Type":"application/json",...t.headers},...t},n=localStorage.getItem("token");n&&(r.headers={...r.headers,Authorization:`Bearer ${n}`});try{const e=await fetch(a,r);if(!e.ok){const t=await e.json().catch(()=>({success:!1,message:`HTTP ${e.status}: ${e.statusText}`}));throw new Error(t.message||"An error occurred")}return await e.json()}catch(i){throw i}}async getConversations(t={}){try{const e=new URLSearchParams;t.page&&e.append("page",t.page.toString()),t.limit&&e.append("limit",t.limit.toString()),t.search&&e.append("search",t.search),t.status&&"all"!==t.status&&e.append("status",t.status),t.type&&"all"!==t.type&&e.append("type",t.type);const s="/messages/conversations"+(e.toString()?`?${e.toString()}`:""),a=await this.makeRequest(s);if(a.success&&a.data)return a.data;throw new Error("Failed to fetch conversations")}catch(s){const t=s instanceof Error?s.message:"Failed to fetch conversations";throw e({title:"Error",description:t,variant:"destructive"}),s}}async getConversationMessages(t,s=1,a=50,r=!0){try{const e=new URLSearchParams;e.append("page",s.toString()),e.append("limit",a.toString()),e.append("markAsRead",r.toString());const n=`/messages/conversation/${t}?${e.toString()}`,i=await this.makeRequest(n);if(i.success&&i.data)return i.data;throw new Error("Failed to fetch conversation messages")}catch(n){const t=n instanceof Error?n.message:"Failed to fetch conversation messages";throw e({title:"Error",description:t,variant:"destructive"}),n}}async sendMessage(t,s,a,r){try{if(!t)throw new Error("Conversation ID is required");if(!(s?.trim()||r&&0!==r.length))throw new Error("Message content or attachments are required");let n=a;if(!n){const e=t.split("_"),s=localStorage.getItem("userId");if(n=e.find(e=>e!==s),!n)throw new Error("Unable to determine recipient")}const i=await this.makeRequest("/messages",{method:"POST",body:JSON.stringify({conversationId:t,recipientId:n,content:s.trim(),attachments:r||[]})});if(i.success&&i.data)return e({title:"Success",description:"Message sent successfully!"}),i.data.message;throw new Error("Failed to send message")}catch(n){const t=n instanceof Error?n.message:"Failed to send message";throw e({title:"Error",description:t,variant:"destructive"}),n}}async uploadAttachment(s){try{const e=10485760;if(s.size>e)throw new Error("File size must be less than 10MB");const a=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],r=["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(s.type),n=a.includes(s.type);if(!r&&!n)throw new Error("File type not supported. Please upload images (jpg, png, gif, webp) or documents (pdf, doc, docx)");return{type:r?"image":"document",url:(await t.uploadSingle(s,"messages")).data.url,name:s.name,size:s.size}}catch(a){const t=a instanceof Error?a.message:"Failed to upload file";throw e({title:"Upload Error",description:t,variant:"destructive"}),a}}static async sendPropertyInquiry(t,a,r){try{const n=localStorage.getItem("token");if(!n)throw e({title:"Error",description:"Please login to send messages",variant:"destructive"}),new Error("Not authenticated");const i=await fetch(`${s}/messages/property-inquiry`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({propertyId:t,subject:a,content:r})}),o=await i.json();if(!i.ok)throw new Error(o.message||"Failed to send message");return e({title:"Success",description:"Message sent successfully"}),o.data}catch(n){throw e({title:"Error",description:n.message||"Failed to send message",variant:"destructive"}),n}}async markMessageAsRead(e){try{if(!(await this.makeRequest(`/messages/${e}/read`,{method:"PATCH"})).success)throw new Error("Failed to mark message as read")}catch(t){}}async markConversationAsRead(e){try{if(!(await this.makeRequest(`/messages/conversation/${e}/read`,{method:"PATCH"})).success)throw new Error("Failed to mark conversation as read")}catch(t){}}async markSingleMessageAsRead(e){try{const t=await this.makeRequest(`/messages/${e}/read`,{method:"PATCH"});if(!t.success)throw new Error("Failed to mark message as read");return t.data}catch(t){}}async updateTypingStatus(e,t){try{if(!e)return;await this.makeRequest("/messages/typing-status",{method:"POST",body:JSON.stringify({conversationId:e,isTyping:t})})}catch(s){}}async getTypingStatus(e){try{return(await this.makeRequest(`/messages/typing-status/${e}`)).data.isTyping}catch(t){return!1}}async updateOnlineStatus(e){try{await this.makeRequest("/messages/online-status",{method:"POST",body:JSON.stringify({status:e})})}catch(t){}}async getUserOnlineStatus(e){try{const t=await this.makeRequest(`/messages/online-status/${e}`);return{isOnline:t.data.isOnline||!1,lastSeen:t.data.lastSeen?new Date(t.data.lastSeen):null}}catch(t){return{isOnline:!1,lastSeen:null}}}async getNotificationPreferences(){try{return(await this.makeRequest("/messages/notification-preferences")).data.notifications}catch(e){return{email:!0,sms:!1,push:!0,desktop:!0,sound:!0,typing:!0}}}async updateNotificationPreferences(e){try{await this.makeRequest("/messages/notification-preferences",{method:"PUT",body:JSON.stringify(e)})}catch(t){}}async getUnreadCount(){try{return(await this.makeRequest("/messages/unread-count")).data.unreadCount}catch(e){return 0}}async updateActiveStatus(e,t){try{if(!e)return;(await this.makeRequest("/messages/active-status",{method:"POST",body:JSON.stringify({conversationId:e,status:t})})).success}catch(s){s instanceof Error&&s.message.includes("admin")}}async getActiveStatus(e){try{const t=await this.makeRequest(`/messages/active-status/${e}`);return t.success?t.data.statuses:{}}catch(t){return{}}}async deleteMessage(t){try{if(!(await this.makeRequest(`/messages/${t}`,{method:"DELETE"})).success)throw new Error("Failed to delete message");e({title:"Success",description:"Message deleted successfully!"})}catch(s){const t=s instanceof Error?s.message:"Failed to delete message";throw e({title:"Error",description:t,variant:"destructive"}),s}}async deleteConversation(t){try{if(!(await this.makeRequest(`/messages/conversations/${t}`,{method:"DELETE"})).success)throw new Error("Failed to delete conversation");e({title:"Success",description:"Conversation deleted successfully!"})}catch(s){const t=s instanceof Error?s.message:"Failed to delete conversation";throw e({title:"Error",description:t,variant:"destructive"}),s}}formatName(e){return`${e.profile.firstName} ${e.profile.lastName}`}async markAsRead(e,t){try{await this.markConversationAsRead(e)}catch(s){}}async getUserStatus(e){try{const t=await this.getUserOnlineStatus(e);return{userId:e,isOnline:t.isOnline,lastSeen:t.lastSeen?t.lastSeen.toISOString():(new Date).toISOString(),isTyping:!1}}catch(t){return{userId:e,isOnline:!1,lastSeen:(new Date).toISOString(),isTyping:!1}}}async setTypingStatus(e,t){try{await this.updateTypingStatus(e,t)}catch(s){}}async updateUserActivity(e="online"){try{const t="online"===e?"online":"offline";await this.updateOnlineStatus(t)}catch(t){}}formatTime(e){if(!e)return"recently";try{const t=new Date(e);if(isNaN(t.getTime()))return"recently";const s=new Date,a=s.getTime()-t.getTime();if(a<0)return"Just now";const r=Math.floor(a/6e4);if(r<1)return"Just now";if(r<60)return`${r} min ago`;const n=Math.floor(r/60);if(n<24)return`${n} hr ago`;const i=Math.floor(n/24);return i<7?`${i} day${i>1?"s":""} ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==s.getFullYear()?"numeric":void 0})}catch(t){return"recently"}}formatPrice(e,t){return"rent"===t?`â‚¹${e.toLocaleString("en-IN")}/month`:e>=1e7?`â‚¹${(e/1e7).toFixed(1)} Cr`:e>=1e5?`â‚¹${(e/1e5).toFixed(1)} L`:`â‚¹${e.toLocaleString("en-IN")}`}getPriorityColor(e){switch(e){case"high":case"urgent":return"bg-red-500";case"medium":return"bg-yellow-500";case"low":return"bg-green-500";default:return"bg-gray-500"}}getStatusColor(e){switch(e){case"unread":return"bg-red-500";case"read":return"bg-yellow-500";case"responded":return"bg-green-500";default:return"bg-gray-500"}}async sendAutoResponse(e,t,s){try{const a=`ðŸ¤– ${s}`,r=await this.makeRequest("/messages",{method:"POST",body:JSON.stringify({conversationId:e,recipientId:t,content:a,type:"auto_response",attachments:[]})});if(r.success&&r.data)return r.data.message;throw new Error("Failed to send auto-response")}catch(a){return null}}isAutoResponse(e){return"auto_response"===e.type||(e.message||e.content)&&((e.message||e.content).startsWith("ðŸ¤–")||(e.message||e.content).toLowerCase().includes("auto-response")||(e.message||e.content).toLowerCase().includes("automatic response")||(e.message||e.content).toLowerCase().includes("i'll get back to you"))}getAutoResponseIndicator(){return"ðŸ¤–"}}const r=new a;export{a as M,r as m};
