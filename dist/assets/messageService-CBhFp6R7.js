import{t as n}from"./index-Bd1eLXM_.js";const g="https://api.akodefy.com/api";class m{async makeRequest(e,t={}){const r=`${g}${e}`,s={headers:{"Content-Type":"application/json",...t.headers},...t},a=localStorage.getItem("token");a&&(s.headers={...s.headers,Authorization:`Bearer ${a}`});try{const o=await fetch(r,s);if(!o.ok){const i=await o.json().catch(()=>({success:!1,message:`HTTP ${o.status}: ${o.statusText}`}));throw new Error(i.message||"An error occurred")}return await o.json()}catch(o){throw console.error("Message API request failed:",o),o}}async getConversations(e={}){try{const t=new URLSearchParams;e.page&&t.append("page",e.page.toString()),e.limit&&t.append("limit",e.limit.toString()),e.search&&t.append("search",e.search),e.status&&e.status!=="all"&&t.append("status",e.status),e.type&&e.type!=="all"&&t.append("type",e.type);const r=`/messages/conversations${t.toString()?`?${t.toString()}`:""}`,s=await this.makeRequest(r);if(s.success&&s.data)return s.data;throw new Error("Failed to fetch conversations")}catch(t){const r=t instanceof Error?t.message:"Failed to fetch conversations";throw n({title:"Error",description:r,variant:"destructive"}),t}}async getConversationMessages(e,t=1,r=50,s=!0){try{const a=new URLSearchParams;a.append("page",t.toString()),a.append("limit",r.toString()),a.append("markAsRead",s.toString());const o=`/messages/conversation/${e}?${a.toString()}`,i=await this.makeRequest(o);if(i.success&&i.data)return i.data;throw new Error("Failed to fetch conversation messages")}catch(a){const o=a instanceof Error?a.message:"Failed to fetch conversation messages";throw n({title:"Error",description:o,variant:"destructive"}),a}}async sendMessage(e,t,r,s){try{let a=r;if(!a){const i=e.split("_"),c=localStorage.getItem("userId");if(a=i.find(d=>d!==c),!a)throw new Error("Unable to determine recipient")}const o=await this.makeRequest("/messages",{method:"POST",body:JSON.stringify({conversationId:e,recipientId:a,content:t,attachments:s||[]})});if(o.success&&o.data)return n({title:"Success",description:"Message sent successfully!"}),o.data.message;throw new Error("Failed to send message")}catch(a){const o=a instanceof Error?a.message:"Failed to send message";throw n({title:"Error",description:o,variant:"destructive"}),a}}async uploadAttachment(e){const t="https://api.akodefy.com";try{if(e.size>10485760)throw new Error("File size must be less than 10MB");const s=["image/jpeg","image/jpg","image/png","image/gif"],a=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],o=s.includes(e.type),i=a.includes(e.type);if(!o&&!i)throw new Error("File type not supported. Please upload images (jpg, png, gif) or documents (pdf, doc, docx)");const c=new FormData;c.append("file",e),c.append("folder","messages");const d=localStorage.getItem("token"),l=await fetch(`${t}/upload/single`,{method:"POST",headers:{Authorization:`Bearer ${d}`},body:c}),u=await l.json();if(!l.ok||!u.success)throw new Error(u.message||"Failed to upload file");return{type:o?"image":"document",url:u.data.url,name:e.name,size:e.size}}catch(r){const s=r instanceof Error?r.message:"Failed to upload file";throw n({title:"Upload Error",description:s,variant:"destructive"}),r}}static async sendPropertyInquiry(e,t,r){try{const s=localStorage.getItem("token");if(!s)throw n({title:"Error",description:"Please login to send messages",variant:"destructive"}),new Error("Not authenticated");const a=await fetch(`${g}/messages/property-inquiry`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({propertyId:e,subject:t,content:r})}),o=await a.json();if(!a.ok)throw new Error(o.message||"Failed to send message");return n({title:"Success",description:"Message sent successfully"}),o.data}catch(s){throw console.error("Error sending property inquiry:",s),n({title:"Error",description:s.message||"Failed to send message",variant:"destructive"}),s}}async markMessageAsRead(e){try{if(!(await this.makeRequest(`/messages/${e}/read`,{method:"PATCH"})).success)throw new Error("Failed to mark message as read")}catch(t){console.error("Failed to mark message as read:",t)}}async markConversationAsRead(e){try{if(!(await this.makeRequest(`/messages/conversation/${e}/read`,{method:"PATCH"})).success)throw new Error("Failed to mark conversation as read")}catch(t){console.error("Failed to mark conversation as read:",t)}}async markSingleMessageAsRead(e){try{const t=await this.makeRequest(`/messages/${e}/read`,{method:"PATCH"});if(!t.success)throw new Error("Failed to mark message as read");return t.data}catch(t){console.error("Failed to mark message as read:",t)}}async updateActiveStatus(e,t){try{if(!e){console.log("Skipping active status update: No conversation ID provided");return}if(!(await this.makeRequest("/messages/active-status",{method:"POST",body:JSON.stringify({conversationId:e,status:t})})).success)throw new Error("Failed to update active status")}catch(r){if(r.message?.includes("Conversation ID and status are required")||r.message?.includes("not part of this conversation")){console.log("Skipping active status update for admin conversation");return}console.error("Failed to update active status:",r)}}async getActiveStatus(e){try{const t=await this.makeRequest(`/messages/active-status/${e}`);return t.success?t.data.statuses:{}}catch(t){return console.error("Failed to get active status:",t),{}}}async deleteMessage(e){try{if((await this.makeRequest(`/messages/${e}`,{method:"DELETE"})).success)n({title:"Success",description:"Message deleted successfully!"});else throw new Error("Failed to delete message")}catch(t){const r=t instanceof Error?t.message:"Failed to delete message";throw n({title:"Error",description:r,variant:"destructive"}),t}}async deleteConversation(e){try{if((await this.makeRequest(`/messages/conversations/${e}`,{method:"DELETE"})).success)n({title:"Success",description:"Conversation deleted successfully!"});else throw new Error("Failed to delete conversation")}catch(t){const r=t instanceof Error?t.message:"Failed to delete conversation";throw n({title:"Error",description:r,variant:"destructive"}),t}}formatName(e){return`${e.profile.firstName} ${e.profile.lastName}`}formatTime(e){const t=new Date(e),r=new Date,s=Math.floor((r.getTime()-t.getTime())/(1e3*60));return s<1?"Just now":s<60?`${s} min ago`:s<1440?`${Math.floor(s/60)} hr ago`:s<10080?`${Math.floor(s/1440)} day ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==r.getFullYear()?"numeric":void 0})}formatPrice(e,t){return t==="rent"?`â‚¹${e.toLocaleString("en-IN")}/month`:e>=1e7?`â‚¹${(e/1e7).toFixed(1)} Cr`:e>=1e5?`â‚¹${(e/1e5).toFixed(1)} L`:`â‚¹${e.toLocaleString("en-IN")}`}getPriorityColor(e){switch(e){case"high":return"bg-red-500";case"medium":return"bg-yellow-500";case"low":return"bg-green-500";default:return"bg-gray-500"}}getStatusColor(e){switch(e){case"unread":return"bg-red-500";case"read":return"bg-yellow-500";case"responded":return"bg-green-500";default:return"bg-gray-500"}}async sendAutoResponse(e,t,r){try{const s=`ðŸ¤– ${r}`,a=await this.makeRequest("/messages",{method:"POST",body:JSON.stringify({conversationId:e,recipientId:t,content:s,type:"auto_response",attachments:[]})});if(a.success&&a.data)return console.log("Auto-response sent successfully:",a.data.message._id),a.data.message;throw new Error("Failed to send auto-response")}catch(s){return console.error("Failed to send auto-response:",s),null}}isAutoResponse(e){return e.type==="auto_response"||e.message&&(e.message.startsWith("ðŸ¤–")||e.message.toLowerCase().includes("auto-response")||e.message.toLowerCase().includes("automatic response")||e.message.toLowerCase().includes("i'll get back to you"))}getAutoResponseIndicator(){return"ðŸ¤–"}}const w=new m;export{m as M,w as m};
