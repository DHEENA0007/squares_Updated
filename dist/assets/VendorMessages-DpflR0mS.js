import{j as e}from"./ui-DHQhougw.js";import{r as s}from"./router-Bi51YGN-.js";import{D as t,u as a,t as r,f as i,H as n,I as l,a7 as c,a8 as d,a9 as o,aa as m,B as x,y as u,P as h,i as p,k as f,ab as g,ac as b,ad as j,ae as v,ar as N,T as w,n as y,af as k,l as C}from"./index-D7KzNfIb.js";import{S}from"./scroll-area-CPsOO4Pn.js";import{m as _}from"./messageService-ep_MLnIS.js";import{u as A}from"./use-mobile-WsBtvUz6.js";import{E as M}from"./ellipsis-vertical-BDceRrNl.js";import{A as L,C as z}from"./check-check-law0yU9t.js";import{P as U}from"./paperclip-N4JNqqwo.js";import{I as E}from"./image-DPCpDa2c.js";import{S as T}from"./send-BNANvshm.js";import"./vendor-eVk5PToZ.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D=t("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]),F=()=>{const{user:t}=a(),F=A(),[I,P]=s.useState(null),[O,$]=s.useState(!0),[R,B]=s.useState(""),[H,V]=s.useState(""),[G,K]=s.useState(!0),[W,q]=s.useState([]),[Y,J]=s.useState([]),[Q,X]=s.useState(!1),[Z,ee]=s.useState([]),[se,te]=s.useState(!1),[ae,re]=s.useState(!1),[ie,ne]=s.useState(!1),[le,ce]=s.useState({}),de=s.useRef(null),oe=s.useRef(null),me=s.useRef(null);s.useRef(null),s.useRef(null),s.useEffect(()=>{xe()},[]),s.useEffect(()=>{xe()},[H]),s.useEffect(()=>{if(W.length>0){he();const e=setInterval(he,1e4);return()=>clearInterval(e)}},[W]),s.useEffect(()=>{I&&(ue(I),F&&$(!1))},[I]);const xe=async()=>{try{K(!0);const e={page:1,limit:50,...H&&{search:H}},s=await _.getConversations(e);q(s.conversations),!I&&s.conversations.length>0&&P(s.conversations[0].id||s.conversations[0]._id||"")}catch(e){r({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{K(!1)}},ue=async e=>{try{X(!0);const s=await _.getConversationMessages(e,1,50,!0);s&&(J(s.messages),await _.updateActiveStatus(e,"online"),xe())}catch(s){}finally{X(!1)}},he=async()=>{const e={};for(const t of W)try{const s=await _.getUserStatus(t.otherUser._id);e[t.otherUser._id]=s}catch(s){}ce(e)},pe=async()=>{if(!R.trim()&&0===Z.length||!I)return;const e=W.find(e=>(e.id||e._id)===I);if(e)try{te(!0),await _.updateActiveStatus(I,"online");const s=[];for(const e of Z){const t=await _.uploadAttachment(e);s.push(t)}const t=await _.sendMessage(I,R.trim()||"(Attachment)",e.otherUser._id,s);J(e=>[...e,t]),B(""),ee([]),q(e=>e.map(e=>(e.id||e._id)===I?{...e,lastMessage:{_id:t._id,message:t.message,createdAt:t.createdAt,isFromMe:!0},updatedAt:t.createdAt}:e)),r({title:"Success",description:"Message sent successfully!"})}catch(s){r({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})}finally{te(!1)}},fe=(e,s)=>{const t=e.target.files;if(!t)return;const a=Array.from(t),i=[];for(const n of a)if(n.size>10485760)r({title:"File too large",description:`${n.name} exceeds 10MB limit`,variant:"destructive"});else{if("image"===s){if(!n.type.startsWith("image/")){r({title:"Invalid file type",description:`${n.name} is not an image`,variant:"destructive"});continue}}else{if(!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(n.type)){r({title:"Invalid file type",description:`${n.name} is not a supported document type`,variant:"destructive"});continue}}i.push(n)}ee(e=>[...e,...i]),e.target&&(e.target.value="")},ge=async()=>{I&&await _.updateActiveStatus(I,"online")};s.useEffect(()=>{let e;return R.trim()?((async()=>{I&&await _.updateActiveStatus(I,"typing")})(),e&&clearTimeout(e),e=setTimeout(()=>{ge()},2e3)):ge(),()=>{e&&clearTimeout(e)}},[R]),s.useEffect(()=>()=>{I&&_.updateActiveStatus(I,"offline")},[I]);const be=e=>e.otherUser,je=s=>{switch(s){case"sent":return e.jsx(C,{className:"w-3 h-3 text-gray-400"});case"delivered":return e.jsx(z,{className:"w-3 h-3 text-gray-400"});case"read":return e.jsx(z,{className:"w-3 h-3 text-blue-500"});default:return null}},ve=W.find(e=>(e.id||e._id)===I),Ne=ve?be(ve):null;if(G)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading messages..."})]})});const we=W.filter(e=>{if(!H)return!0;const s=be(e);if(!s)return!1;return(s.name||"Unknown User").toLowerCase().includes(H.toLowerCase())||e.lastMessage?.message.toLowerCase().includes(H.toLowerCase())||e.property?.title.toLowerCase().includes(H.toLowerCase())});return e.jsxs("div",{className:"h-[calc(100vh-4rem)] flex flex-col md:flex-row gap-0 relative top-[60px]",children:[F&&!O&&e.jsx("div",{className:"md:hidden p-4 border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-20",children:e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>$(!0),className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Back to Messages"]})}),e.jsxs("div",{className:"w-full md:w-1/3 border-r border-border flex flex-col "+(F&&!O?"hidden":""),children:[e.jsxs("div",{className:"p-4 border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:[e.jsx("h2",{className:"font-semibold mb-3 text-foreground "+(F?"text-xl":"text-lg"),children:"Messages"}),e.jsxs("div",{className:"relative",children:[e.jsx(n,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(l,{placeholder:"Search conversations...",value:H,onChange:e=>V(e.target.value),className:"pl-10 "+(F?"h-11 text-base":"h-9")})]})]}),e.jsx(S,{className:"flex-1",children:e.jsx("div",{className:"p-2",children:we.map(s=>{const t=be(s),a=t?.name||"Unknown User",r=s.id||s._id||"";return e.jsx("div",{className:"p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-accent/50 "+(I===r?"bg-accent border-l-4 border-primary":""),onClick:()=>P(r),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs(c,{className:"h-12 w-12 border-2 border-background shadow-sm",children:[e.jsx(d,{src:void 0}),e.jsx(o,{className:"bg-primary/10 text-primary font-semibold",children:a.charAt(0).toUpperCase()})]}),le[t._id]?.isOnline?e.jsx("div",{title:"Online",className:"absolute -bottom-0.5 -right-0.5",children:e.jsx(m,{className:"w-3.5 h-3.5 fill-green-500 text-green-500 border-2 border-background rounded-full"})}):e.jsx("div",{title:`Last seen ${le[t._id]?.lastSeen?_.formatTime(le[t._id].lastSeen):"recently"}`,className:"absolute -bottom-0.5 -right-0.5",children:e.jsx(m,{className:"w-3.5 h-3.5 fill-gray-400 text-gray-400 border-2 border-background rounded-full"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold truncate "+(F?"text-base":"text-sm"),children:a}),le[t._id]?.isOnline&&e.jsx("span",{className:"text-[10px] text-green-600 font-medium whitespace-nowrap",children:"â— Online"})]}),e.jsxs("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.lastMessage?.createdAt||"").toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),s.unreadCount>0&&e.jsx(x,{className:"bg-primary text-primary-foreground text-xs h-5 min-w-[20px] flex items-center justify-center px-1.5",children:s.unreadCount})]})]}),le[t._id]&&!le[t._id]?.isOnline&&e.jsxs("p",{className:"text-[10px] text-muted-foreground mb-1.5",children:["Last seen ",le[t._id]?.lastSeen?_.formatTime(le[t._id].lastSeen):"recently"]}),s.property&&e.jsxs("p",{className:"text-xs text-muted-foreground mb-1.5 truncate font-medium",children:["ðŸ“ ",s.property?.title||"General inquiry"]}),e.jsxs("p",{className:"text-muted-foreground truncate line-clamp-1 "+(F?"text-base":"text-sm"),children:[s.lastMessage?.isFromMe&&e.jsx("span",{className:"text-primary font-medium mr-1",children:"You:"}),s.lastMessage?.message]})]})]})},r)})})})]}),e.jsx("div",{className:"flex-1 flex flex-col bg-background "+(F&&O?"hidden":""),children:ve?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs(c,{className:"h-12 w-12 border-2 border-background shadow-sm",children:[e.jsx(d,{src:void 0}),e.jsx(o,{className:"bg-primary/10 text-primary font-semibold",children:Ne?.name?.charAt(0).toUpperCase()||"U"})]}),le[Ne?._id]?.isOnline?e.jsx(m,{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 fill-green-500 text-green-500 border-2 border-background rounded-full"}):e.jsx(m,{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 fill-gray-400 text-gray-400 border-2 border-background rounded-full"})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"font-semibold truncate "+(F?"text-lg":"text-base"),children:Ne?.name||"Unknown User"}),le[Ne?._id]&&e.jsx("p",{className:"text-xs text-muted-foreground",children:le[Ne._id]?.isOnline?e.jsx("span",{className:"text-green-600 font-medium",children:"â— Active now"}):e.jsxs("span",{children:["Last seen ",le[Ne._id]?.lastSeen?_.formatTime(le[Ne._id].lastSeen):"recently"]})})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[Ne?.phone?F?e.jsx(i,{size:"sm",variant:"ghost",className:(F?"h-11 w-11":"h-9 w-9")+" p-0",title:"Call",onClick:()=>window.location.href=`tel:${Ne.phone}`,children:e.jsx(u,{className:""+(F?"w-5 h-5":"w-4 h-4")})}):e.jsxs(h,{children:[e.jsx(p,{asChild:!0,children:e.jsx(i,{size:"sm",variant:"ghost",className:(F?"h-11 w-11":"h-9 w-9")+" p-0",title:"View phone number",children:e.jsx(u,{className:""+(F?"w-5 h-5":"w-4 h-4")})})}),e.jsx(f,{className:"w-auto p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Phone Number"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-lg font-semibold",children:Ne.phone}),e.jsx(i,{size:"sm",variant:"outline",onClick:()=>{navigator.clipboard.writeText(Ne.phone||""),r({title:"Copied!",description:"Phone number copied to clipboard"})},children:"Copy"})]})]})})]}):e.jsx(i,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0",title:"No phone number available",disabled:!0,children:e.jsx(u,{className:"w-4 h-4 opacity-50"})}),e.jsxs(g,{children:[e.jsx(b,{asChild:!0,children:e.jsx(i,{size:"sm",variant:"ghost",className:(F?"h-11 w-11":"h-9 w-9")+" p-0",children:e.jsx(M,{className:""+(F?"w-5 h-5":"w-4 h-4")})})}),e.jsxs(j,{align:"end",children:[e.jsxs(v,{children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(v,{children:[e.jsx(L,{className:"w-4 h-4 mr-2"}),"Archive"]}),e.jsxs(v,{className:"text-destructive focus:text-destructive",onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this conversation?"))try{await _.deleteConversation(e),q(s=>s.filter(s=>(s.id||s._id)!==e)),I===e&&(P(null),J([])),r({title:"Success",description:"Conversation deleted successfully!"})}catch(s){r({title:"Error",description:"Failed to delete conversation. Please try again.",variant:"destructive"})}})(ve.id||ve._id||""),children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]}),ve.property&&e.jsx("div",{className:"mt-3 p-3 bg-accent/50 rounded-lg border border-border",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-8 bg-primary rounded-full"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:ve.property.title}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["â‚¹",ve.property.price.toLocaleString()]})]})]})})]}),e.jsx(S,{className:"flex-1 p-4 bg-muted/20",children:Q?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading messages..."})]})}):e.jsxs("div",{className:"space-y-4",children:[Y.map(s=>{const a="string"==typeof s.sender?s.sender:s.sender._id,n=t?.id===a;return e.jsx("div",{className:`group flex ${n?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:"max-w-[75%] md:max-w-[60%] rounded-2xl px-4 py-2.5 shadow-sm "+(n?"bg-primary text-primary-foreground rounded-br-sm":"bg-background border border-border rounded-bl-sm"),children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words leading-relaxed "+(F?"text-base":""),children:s.message}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2.5 space-y-2",children:s.attachments.map((s,t)=>e.jsx("div",{children:"image"===s.type?e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:s.url,alt:s.name,className:"max-w-full rounded-lg border border-border cursor-pointer hover:opacity-90 transition-opacity",style:{maxHeight:"250px"}})}):e.jsxs("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2.5 rounded-lg border transition-colors "+(n?"border-primary-foreground/20 hover:bg-primary-foreground/10":"border-border bg-muted/50 hover:bg-muted"),children:[e.jsx(U,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"text-sm truncate",children:s.name})]})},t))}),e.jsxs("div",{className:"flex items-center justify-between mt-1.5 gap-2 "+(n?"text-primary-foreground/70":"text-muted-foreground"),children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-[11px]",children:new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[n&&je(s.status),n&&e.jsxs(g,{children:[e.jsx(b,{asChild:!0,children:e.jsx(i,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-destructive/10",title:"Message options",children:e.jsx(M,{className:"w-3.5 h-3.5"})})}),e.jsx(j,{align:"end",children:e.jsxs(v,{className:"text-destructive focus:text-destructive",onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this message? This action cannot be undone."))try{await _.deleteMessage(e),J(s=>s.filter(s=>s._id!==e)),r({title:"Success",description:"Message deleted successfully!"})}catch(s){r({title:"Error",description:"Failed to delete message. Please try again.",variant:"destructive"})}})(s._id),children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"Delete Message"]})})]})]})]})]})},s._id)}),ie&&e.jsx("div",{className:"flex justify-start mb-4",children:e.jsx("div",{className:"bg-background border border-border px-4 py-3 rounded-2xl rounded-bl-sm shadow-sm",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[Ne?.name," is typing..."]})]})})}),e.jsx("div",{ref:me})]})}),e.jsxs("div",{className:"p-4 border-t border-border bg-background "+(F?"pb-safe":""),children:[Z.length>0&&e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:Z.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2 bg-accent px-3 py-2 rounded-lg border border-border",children:[e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name}),e.jsx(i,{size:"sm",variant:"ghost",className:(F?"h-6 w-6":"h-5 w-5")+" p-0 hover:bg-destructive/10",onClick:()=>(e=>{ee(s=>s.filter((s,t)=>t!==e))})(t),children:"Ã—"})]},t))}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{ref:de,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:e=>fe(e,"document"),multiple:!0}),e.jsx("input",{ref:oe,type:"file",className:"hidden",accept:"image/*",onChange:e=>fe(e,"image"),multiple:!0}),e.jsx(i,{size:"sm",variant:"ghost",className:(F?"h-12 w-12":"h-10 w-10")+" p-0",onClick:()=>de.current?.click(),disabled:se,title:"Attach document",children:e.jsx(U,{className:""+(F?"w-6 h-6":"w-5 h-5")})}),e.jsx(i,{size:"sm",variant:"ghost",className:(F?"h-12 w-12":"h-10 w-10")+" p-0",onClick:()=>oe.current?.click(),disabled:se,title:"Attach image",children:e.jsx(E,{className:""+(F?"w-6 h-6":"w-5 h-5")})})]}),e.jsx("div",{className:"flex-1",children:e.jsx(w,{placeholder:"Type your message...",value:R,onChange:e=>B(e.target.value),className:"min-h-[56px] max-h-[120px] resize-none rounded-xl "+(F?"text-base":""),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),pe())},disabled:se})}),e.jsx(i,{onClick:pe,disabled:!R.trim()&&0===Z.length||se,className:(F?"h-12 w-12":"h-10 w-10")+" p-0 rounded-full",title:"Send message",children:se?e.jsx(y,{className:(F?"w-6 h-6":"w-5 h-5")+" animate-spin"}):e.jsx(T,{className:""+(F?"w-6 h-6":"w-5 h-5")})})]})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center bg-muted/20",children:e.jsxs("div",{className:"text-center px-4",children:[e.jsx("div",{className:"mb-4 inline-flex p-4 bg-primary/10 rounded-full",children:e.jsx(k,{className:"w-12 h-12 text-primary"})}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted-foreground max-w-sm",children:"Choose a conversation from the list to start messaging with your clients"})]})})})]})};export{F as default};
