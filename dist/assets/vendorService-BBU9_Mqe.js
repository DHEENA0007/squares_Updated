import{t as e}from"./index-CV77Hym3.js";import{r as t}from"./reviewsService-BQH4s__s.js";import"./ui-DHQhougw.js";import"./router-Bi51YGN-.js";import"./vendor-eVk5PToZ.js";const s=new class{async makeRequest(e,t={}){const s=`https://api.buildhomemartsquares.com/api${e}`,a={headers:{"Content-Type":"application/json",...t.headers},...t},r=localStorage.getItem("token");r&&(a.headers={...a.headers,Authorization:`Bearer ${r}`});try{const e=await fetch(s,a);if(!e.ok){const t=await e.json().catch(()=>({success:!1,message:`HTTP ${e.status}: ${e.statusText}`}));throw new Error(t.message||"An error occurred")}return await e.json()}catch(i){throw i}}cleanObject(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>this.cleanObject(e)).filter(e=>void 0!==e);const t={};for(const[s,a]of Object.entries(e)){const e=this.cleanObject(a);void 0!==e&&(t[s]=e)}return Object.keys(t).length>0?t:void 0}async getVendorProfile(){try{let e;try{e=await this.makeRequest("/vendors/profile")}catch(s){e=await this.makeRequest("/users/profile")}if(e.success&&e.data){const s=e.data.user;try{const e=await t.getReviewStats();s.profile?.vendorInfo?.rating?(s.profile.vendorInfo.rating.average=e.averageRating,s.profile.vendorInfo.rating.count=e.totalReviews):s.profile?.vendorInfo&&(s.profile.vendorInfo.rating={average:e.averageRating,count:e.totalReviews})}catch(a){}return s}throw new Error("Failed to fetch vendor profile")}catch(r){const t=r instanceof Error?r.message:"Failed to fetch vendor profile";throw e({title:"Error",description:t,variant:"destructive"}),r}}async updateVendorProfile(t){try{let n=null;const o=localStorage.getItem("user");if(o)try{const e=JSON.parse(o);n=e.id||e._id}catch(s){}if(!n){const e=localStorage.getItem("token");if(e)try{const t=JSON.parse(atob(e.split(".")[1]));n=t.userId||t.id}catch(a){}}if(!n)try{const e=await this.makeRequest("/auth/me");e.success&&e.data&&(n=e.data.user.id||e.data.user._id,localStorage.setItem("user",JSON.stringify(e.data.user)))}catch(r){}if(!n)throw new Error("Unable to determine user ID. Please log in again.");const c=this.cleanObject(t);let d;try{d=await this.makeRequest("/vendors/profile",{method:"PUT",body:JSON.stringify(c)})}catch(i){d=await this.makeRequest(`/users/${n}`,{method:"PUT",body:JSON.stringify(c)})}if(d.success&&d.data)return localStorage.setItem("user",JSON.stringify(d.data.user)),e({title:"Success",description:"Profile updated successfully!"}),d.data.user;throw new Error("Failed to update vendor profile")}catch(n){const t=n instanceof Error?n.message:"Failed to update vendor profile";throw e({title:"Error",description:t,variant:"destructive"}),n}}async getVendorStatistics(){try{const e=await this.makeRequest("/vendors/statistics");return e.success&&e.data?e.data:{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}catch(e){return{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}}async checkSubscription(e){try{const t=await this.makeRequest(`/vendors/subscription/check/${e}`);return!(!t.success||!t.data)&&t.data.hasSubscription}catch(t){return!1}}async activateSubscription(e,t){try{return await this.makeRequest("/vendors/subscription/activate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e,paymentId:t})})}catch(s){return{success:!1,message:"Failed to activate subscription. Please try again."}}}async getVendorSubscriptions(){try{const e=await this.makeRequest("/vendors/subscriptions");return e.success&&e.data?e.data.subscriptions:[]}catch(e){return[]}}async getSubscriptionLimits(){try{const e=await this.makeRequest("/vendors/subscription-limits");return e.success&&e.data?e.data:{maxProperties:5,currentProperties:0,canAddMore:!0,planName:"Free",features:["5 Property Listings"]}}catch(e){return{maxProperties:5,currentProperties:0,canAddMore:!0,planName:"Free",features:["5 Property Listings"]}}}async cleanupSubscriptions(){try{const t=await this.makeRequest("/vendors/subscription/cleanup",{method:"POST"});return t.success?(e({title:"Subscriptions Cleaned Up",description:`Deactivated ${t.deactivatedCount} old subscriptions. Using latest subscription now.`}),await this.refreshSubscriptionData(),{success:!0,activeSubscription:t.activeSubscription,deactivatedCount:t.deactivatedCount}):{success:!1,activeSubscription:null,deactivatedCount:0}}catch(t){return e({title:"Error",description:"Failed to cleanup subscriptions",variant:"destructive"}),{success:!1,activeSubscription:null,deactivatedCount:0}}}async refreshSubscriptionData(){try{const t=await this.makeRequest("/vendors/subscription/refresh",{method:"POST"});if(t.success&&t.data){const s=[];for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t&&(t.includes("subscription")||t.includes("limits")||t.includes("plan"))&&s.push(t)}return s.forEach(e=>localStorage.removeItem(e)),e({title:"Success",description:t.message||"Subscription data refreshed successfully!"}),t.data}throw new Error("Failed to refresh subscription data")}catch(t){const s=t instanceof Error?t.message:"Failed to refresh subscription data";throw e({title:"Error",description:s,variant:"destructive"}),t}}async updateVendorSettings(t){try{const s=this.cleanObject(t),a=await this.makeRequest("/vendors/settings",{method:"PUT",body:JSON.stringify({...s,meta:{lastUpdated:(new Date).toISOString(),version:"2.0",source:"dynamic-vendor-settings",supportEmail:"support@buildhomemartsquares.com"}})});if(a.success)return localStorage.setItem("dynamicVendorSettings",JSON.stringify(a.data)),e({title:"âœ… Settings Synced",description:"All vendor preferences saved successfully."}),a.data;throw new Error("Failed to update vendor settings")}catch(s){const a="dynamicVendorSettings",r={...t,meta:{lastUpdated:(new Date).toISOString(),version:"2.0",source:"dynamic-vendor-settings-offline",pendingSync:!0,supportEmail:"support@buildhomemartsquares.com"}};return localStorage.setItem(a,JSON.stringify(r)),e({title:"ðŸ’¾ Settings Saved Offline",description:"Settings cached locally. Will sync when online."}),r}}async getVendorSettings(){try{const e=await this.makeRequest("/vendors/settings");if(e.success&&e.data)return e.data;const t=localStorage.getItem("dynamicVendorSettings");return t?JSON.parse(t):null}catch(e){const t=localStorage.getItem("dynamicVendorSettings");return t?JSON.parse(t):null}}async sendVendorSettingsNotification(e,t,s){try{(new Date).toISOString()}catch(a){}}async updateVendorPreferences(t,s){try{const e=await this.getVendorSettings()||{},a={...e,preferences:{...e.preferences,[t]:s},meta:{lastUpdated:(new Date).toISOString(),lastChangedField:t,source:"real-time-update"}};await this.updateVendorSettings(a);t.replace(/([A-Z])/g," $1").toLowerCase()}catch(a){e({title:"Update Failed",description:"Preference will sync when connection is restored.",variant:"destructive"})}}async validateVendorSubscription(){try{const e=await this.makeRequest("/vendors/subscription/validate");return e.success&&e.data?e.data:{isActive:!1,planName:"Free",features:["5 Property Listings","Basic Support"],limits:{maxProperties:5,maxPhotos:10}}}catch(e){return{isActive:!1,planName:"Free",features:["5 Property Listings","Basic Support"],limits:{maxProperties:5,maxPhotos:10}}}}async getAutoResponseSettings(){try{const e=await this.getVendorSettings();return{enabled:e?.business?.autoResponseEnabled||!1,message:e?.business?.autoResponseMessage||"Thank you for your interest! I'll get back to you soon."}}catch(e){return{enabled:!1,message:"Thank you for your interest! I'll get back to you soon."}}}async updateAutoResponseSettings(t,s){try{await this.updateVendorPreferences("business.autoResponseEnabled",t),s.trim()&&await this.updateVendorPreferences("business.autoResponseMessage",s),e({title:"Auto-Response Updated",description:t?"Auto-responses are now enabled":"Auto-responses have been disabled"})}catch(a){throw a}}async isVendorEnterpriseProperty(e){try{const t=await this.makeRequest(`/vendors/${e}/enterprise-check`);return!(!t.success||!t.data)&&t.data.isEnterprise}catch(t){return!1}}};export{s as default,s as vendorService};
