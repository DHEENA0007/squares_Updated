import{t as e}from"./index-DvBXyKtT.js";import{r as t}from"./reviewsService-C63_b63b.js";import"./ui-s1SEoZIF.js";import"./router-D8v2YSKU.js";import"./vendor-BxThA0WO.js";const s="https://app.buildhomemartsquares.com/api";const a=new class{async makeRequest(e,t={}){const a=`${s}${e}`,r={headers:{"Content-Type":"application/json",...t.headers},...t},n=localStorage.getItem("token");n&&(r.headers={...r.headers,Authorization:`Bearer ${n}`});try{const e=await fetch(a,r);if(!e.ok){const t=await e.json().catch(()=>({success:!1,message:`HTTP ${e.status}: ${e.statusText}`}));throw new Error(t.message||"An error occurred")}return await e.json()}catch(i){throw i}}cleanObject(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>this.cleanObject(e)).filter(e=>void 0!==e);const t={};for(const[s,a]of Object.entries(e)){if(void 0===a)continue;const e=this.cleanObject(a);void 0!==e&&("object"!=typeof e||Array.isArray(e)||Object.keys(e).length>0)&&(t[s]=e)}return Object.keys(t).length>0?t:void 0}async getVendorProfile(){try{let e;try{e=await this.makeRequest("/vendors/profile")}catch(s){e=await this.makeRequest("/users/profile")}if(e.success&&e.data){const s=e.data.user;try{const e=await t.getReviewStats();s.profile?.vendorInfo?.rating?(s.profile.vendorInfo.rating.average=e.averageRating,s.profile.vendorInfo.rating.count=e.totalReviews):s.profile?.vendorInfo&&(s.profile.vendorInfo.rating={average:e.averageRating,count:e.totalReviews})}catch(a){}return s}throw new Error("Failed to fetch vendor profile")}catch(r){const t=r instanceof Error?r.message:"Failed to fetch vendor profile";throw e({title:"Error",description:t,variant:"destructive"}),r}}async updateVendorProfile(t){try{let i=null;const o=localStorage.getItem("user");if(o)try{const e=JSON.parse(o);i=e.id||e._id}catch(s){}if(!i){const e=localStorage.getItem("token");if(e)try{const t=JSON.parse(atob(e.split(".")[1]));i=t.userId||t.id}catch(a){}}if(!i)try{const e=await this.makeRequest("/auth/me");e.success&&e.data&&(i=e.data.user.id||e.data.user._id,localStorage.setItem("user",JSON.stringify(e.data.user)))}catch(r){}if(!i)throw new Error("Unable to determine user ID. Please log in again.");const c=this.cleanObject(t);let d;try{d=await this.makeRequest("/vendors/profile",{method:"PUT",body:JSON.stringify(c)})}catch(n){d=await this.makeRequest(`/users/${i}`,{method:"PUT",body:JSON.stringify(c)})}if(d.success&&d.data)return localStorage.setItem("user",JSON.stringify(d.data.user)),e({title:"Success",description:"Profile updated successfully!"}),d.data.user;throw new Error("Failed to update vendor profile")}catch(i){const t=i instanceof Error?i.message:"Failed to update vendor profile";throw e({title:"Error",description:t,variant:"destructive"}),i}}async getVendorStatistics(){try{const e=await this.makeRequest("/vendors/statistics");return e.success&&e.data?e.data:{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}catch(e){return{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}}async checkSubscription(e){try{const t=await this.makeRequest(`/vendors/subscription/check/${e}`);return!(!t.success||!t.data)&&t.data.hasSubscription}catch(t){return!1}}async activateSubscription(e,t){try{return await this.makeRequest("/vendors/subscription/activate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e,paymentId:t})})}catch(s){return{success:!1,message:"Failed to activate subscription. Please try again."}}}async getVendorSubscriptions(){try{const e=await this.makeRequest("/vendors/subscriptions");return e.success&&e.data?e.data.subscriptions:[]}catch(e){return[]}}async getSubscriptionLimits(){try{const e=await this.makeRequest("/vendors/subscription-limits");if(!e.success||!e.data)throw new Error("Failed to fetch subscription limits from server");return e.data}catch(e){throw e}}async cleanupSubscriptions(){try{const t=await this.makeRequest("/vendors/subscription/cleanup",{method:"POST"});return t.success?(e({title:"Subscriptions Cleaned Up",description:`Deactivated ${t.deactivatedCount} old subscriptions. Using latest subscription now.`}),await this.refreshSubscriptionData(),{success:!0,activeSubscription:t.activeSubscription,deactivatedCount:t.deactivatedCount}):{success:!1,activeSubscription:null,deactivatedCount:0}}catch(t){return e({title:"Error",description:"Failed to cleanup subscriptions",variant:"destructive"}),{success:!1,activeSubscription:null,deactivatedCount:0}}}async refreshSubscriptionData(){try{const t=await this.makeRequest("/vendors/subscription/refresh",{method:"POST"});if(t.success&&t.data){const s=[];for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t&&(t.includes("subscription")||t.includes("limits")||t.includes("plan"))&&s.push(t)}return s.forEach(e=>localStorage.removeItem(e)),e({title:"Success",description:t.message||"Subscription data refreshed successfully!"}),t.data}throw new Error("Failed to refresh subscription data")}catch(t){const s=t instanceof Error?t.message:"Failed to refresh subscription data";throw e({title:"Error",description:s,variant:"destructive"}),t}}async updateVendorSettings(t){try{const s=this.cleanObject(t),a=await this.makeRequest("/vendors/settings",{method:"PUT",body:JSON.stringify({...s,meta:{lastUpdated:(new Date).toISOString(),version:"2.0",source:"dynamic-vendor-settings",supportEmail:"support@buildhomemartsquares.com"}})});if(a.success)return localStorage.setItem("dynamicVendorSettings",JSON.stringify(a.data)),e({title:"âœ… Settings Synced",description:"All vendor preferences saved successfully."}),a.data;throw new Error("Failed to update vendor settings")}catch(s){const a="dynamicVendorSettings",r={...t,meta:{lastUpdated:(new Date).toISOString(),version:"2.0",source:"dynamic-vendor-settings-offline",pendingSync:!0,supportEmail:"support@buildhomemartsquares.com"}};return localStorage.setItem(a,JSON.stringify(r)),e({title:"ðŸ’¾ Settings Saved Offline",description:"Settings cached locally. Will sync when online."}),r}}async getVendorSettings(){try{const e=await this.makeRequest("/vendors/settings");if(e.success&&e.data)return e.data;const t=localStorage.getItem("dynamicVendorSettings");return t?JSON.parse(t):null}catch(e){const t=localStorage.getItem("dynamicVendorSettings");return t?JSON.parse(t):null}}async sendVendorSettingsNotification(e,t,s){try{(new Date).toISOString()}catch(a){}}async updateVendorPreferences(t,s){try{const e=await this.getVendorSettings()||{},a={...e,preferences:{...e.preferences,[t]:s},meta:{lastUpdated:(new Date).toISOString(),lastChangedField:t,source:"real-time-update"}};await this.updateVendorSettings(a);t.replace(/([A-Z])/g," $1").toLowerCase()}catch(a){e({title:"Update Failed",description:"Preference will sync when connection is restored.",variant:"destructive"})}}async validateVendorSubscription(){try{const e=await this.makeRequest("/vendors/subscription/validate");if(!e.success||!e.data)throw new Error("Failed to validate subscription from server");return e.data}catch(e){throw e}}async getAutoResponseSettings(){try{const e=await this.getVendorSettings();return{enabled:e?.business?.autoResponseEnabled||!1,message:e?.business?.autoResponseMessage||"Thank you for your interest! I'll get back to you soon."}}catch(e){return{enabled:!1,message:"Thank you for your interest! I'll get back to you soon."}}}async updateAutoResponseSettings(t,s){try{await this.updateVendorPreferences("business.autoResponseEnabled",t),s.trim()&&await this.updateVendorPreferences("business.autoResponseMessage",s),e({title:"Auto-Response Updated",description:t?"Auto-responses are now enabled":"Auto-responses have been disabled"})}catch(a){throw a}}async isVendorEnterpriseProperty(e){try{const t=await this.makeRequest(`/vendors/${e}/enterprise-check`);return t.success&&t.data?{isEnterprise:t.data.isEnterprise,whatsappNumber:t.data.whatsappNumber}:{isEnterprise:!1,whatsappNumber:null}}catch(t){return{isEnterprise:!1,whatsappNumber:null}}}async getMyBadges(){try{const e=await this.makeRequest("/vendors/subscription/badges");if(e.success&&e.data)return e.data;throw new Error("Failed to fetch badges from server")}catch(t){return e({title:"Error",description:"Failed to load badge information.",variant:"destructive"}),{hasSubscription:!1,badges:[],planName:null,planLevel:"free"}}}async getVendorBadges(e){try{const t=await fetch(`${s}/vendors/${e}/badges`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.json();if(!a.success)throw new Error(a.message||"Failed to fetch vendor badges");return a.data}catch(t){return{hasSubscription:!1,badges:[],planName:null,planLevel:"free"}}}async getFeaturedVendors(e=8){try{const t=await fetch(`${s}/properties/featured-vendors?limit=${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.json();if(!a.success)throw new Error(a.message||"Failed to fetch featured vendors");return{success:!0,data:a.data.vendors||[]}}catch(t){return{success:!1,data:[]}}}};export{a as default,a as vendorService};
