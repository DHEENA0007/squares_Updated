import{j as e}from"./ui-BNZSgpjP.js";import{r as s,d as a}from"./router-D8v2YSKU.js";import{u as l,a2 as t,l as i,a3 as r,f as n,a9 as d,af as c,ag as o,ah as u,ai as p,a4 as h,a5 as m,a6 as x,a7 as j,a8 as f,L as y,q as v,r as g,s as N,v as F,w as b,B as _,ad as w,I as C,G as T,ae as S,Z as E,ac as L,aj as O,a as V,e as A}from"./index-BxQlwZ4N.js";import{T as R,a as k,b as D,c as z,d as I,e as P}from"./table-DislQvtG.js";import{P as M}from"./pencil-CpecYJeg.js";import{A as q,a as U}from"./alert-rEX1VgGL.js";import"./vendor-BxThA0WO.js";const $=()=>{const{user:a}=l(),{toast:O}=t(),V=a?.rolePermissions||[],A="admin"===a?.role||"superadmin"===a?.role,q=e=>V.includes(e),U=A||q(E.FILTER_CREATE_NTP),$=A||q(E.FILTER_CREATE_FTO),B=A||q(E.FILTER_EDIT),Y=A||q(E.FILTER_DELETE),G=A||q(E.FILTER_STATUS);A||q(E.FILTER_ORDER);const[K,Z]=s.useState([]),[H,J]=s.useState([]),[Q,W]=s.useState(!0),[X,ee]=s.useState(!1),[se,ae]=s.useState(!1),[le,te]=s.useState(null),[ie,re]=s.useState(""),[ne,de]=s.useState(""),[ce,oe]=s.useState([]),[ue,pe]=s.useState(!1),[he,me]=s.useState(null),[xe,je]=s.useState(""),[fe,ye]=s.useState({filter_type:"",name:"",value:"",min_value:void 0,max_value:void 0,display_label:"",display_order:0}),[ve,ge]=s.useState([]),[Ne,Fe]=s.useState(!1),[be,_e]=s.useState({targetFilterType:"",sourceFilterType:"",sourceFilterValues:[]}),[we,Ce]=s.useState([]),[Te,Se]=s.useState(""),[Ee,Le]=s.useState([]),[Oe,Ve]=s.useState(!1),[Ae,Re]=s.useState(i.isReady());s.useEffect(()=>{De(),ke(),Ie(),i.initialize().then(()=>{Re(!0)}).catch(console.error)},[]);const ke=async()=>{try{const e=await r.getFilterDependencies();ge(e)}catch(e){}};s.useEffect(()=>{(async()=>{if(be.sourceFilterType)if("property_type"===be.sourceFilterType){const e=await r.getAllPropertyTypes(!1);Ce(e.map(e=>({label:e.name,value:e.value})))}else{const e=ze(be.sourceFilterType);Ce(e.map(e=>({label:e.displayLabel||e.name,value:e.value})))}else Ce([])})()},[be.sourceFilterType,K]);const De=async()=>{try{W(!0);const e=await r.getAllFilterConfigurations(!0);Z(e);const s=Array.from(new Set(e.map(e=>e.filterType)));J(s.sort()),s.length>0&&!ie&&re(s[0])}catch(e){O({title:"Error",description:"Failed to fetch filter configurations",variant:"destructive"})}finally{W(!1)}},ze=e=>K.filter(s=>s.filterType===e).sort((e,s)=>e.displayOrder-s.displayOrder),Ie=async()=>{try{pe(!0);const e=await r.getAllPropertyTypes(!1),s=[],a=new Set;for(const l of e){const e=await r.getPropertyTypeFields(l._id,!1);for(const t of e)a.has(t.fieldName)||(a.add(t.fieldName),s.push({fieldName:t.fieldName,fieldLabel:t.fieldLabel,fieldType:t.fieldType,fieldOptions:t.fieldOptions||[],propertyTypeName:l.name}))}oe(s)}catch(e){}finally{pe(!1)}},Pe=e=>{e?(te(e),ye({filter_type:e.filterType,name:e.name,value:e.value,min_value:e.minValue,max_value:e.maxValue,display_label:e.displayLabel,display_order:e.displayOrder}),"location"===e.filterType&&Se(e.name)):(te(null),ye({filter_type:ie,name:"",value:"",min_value:void 0,max_value:void 0,display_label:"",display_order:0}),Se("")),ee(!0)},Me=()=>{ee(!1),te(null),ye({filter_type:"",name:"",value:"",min_value:void 0,max_value:void 0,display_label:"",display_order:0}),Se(""),Le([])},qe=s=>{const a=ze(s);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{children:e.jsxs("h4",{className:"text-sm font-medium text-muted-foreground",children:[a.length," options configured"]})}),$&&e.jsxs(n,{size:"sm",onClick:()=>Pe(),children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),"Add Option"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(R,{children:[e.jsx(k,{children:e.jsxs(D,{children:[e.jsx(z,{children:"Display Order"}),e.jsx(z,{children:"Name"}),e.jsx(z,{children:"Value"}),e.jsx(z,{children:"Display Label"}),e.jsx(z,{children:"Status"}),e.jsx(z,{className:"text-right",children:"Actions"})]})}),e.jsx(I,{children:0===a.length?e.jsx(D,{children:e.jsx(P,{colSpan:6,className:"text-center py-8 text-muted-foreground",children:"No options found for this filter type."})}):a.map(s=>e.jsxs(D,{children:[e.jsx(P,{children:s.displayOrder}),e.jsx(P,{className:"font-medium",children:s.name}),e.jsx(P,{children:e.jsx(_,{variant:"outline",children:s.value})}),e.jsx(P,{children:s.displayLabel||"-"}),e.jsx(P,{children:e.jsx(L,{checked:s.isActive,onCheckedChange:()=>G&&(async e=>{try{await r.updateFilterConfiguration(e.id,{isActive:!e.isActive}),O({title:"Success",description:`Filter ${e.isActive?"deactivated":"activated"} successfully`}),De()}catch(s){O({title:"Error",description:"Failed to update filter status",variant:"destructive"})}})(s),disabled:!G})}),e.jsx(P,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[B&&e.jsx(n,{variant:"ghost",size:"icon",onClick:()=>Pe(s),children:e.jsx(M,{className:"h-4 w-4"})}),Y&&e.jsx(n,{variant:"ghost",size:"icon",className:"text-destructive hover:text-destructive",onClick:()=>(async e=>{if(confirm("Are you sure you want to delete this filter option?"))try{await r.deleteFilterConfiguration(e),O({title:"Success",description:"Filter deleted successfully"}),De()}catch(s){O({title:"Error",description:"Failed to delete filter",variant:"destructive"})}})(s.id),children:e.jsx(w,{className:"h-4 w-4"})})]})})]},s.id))})]})})]})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Filter Configurations"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage filter options for property search and filtering"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{variant:"outline",onClick:()=>Fe(!0),children:"Manage Dependencies"}),U&&e.jsxs(n,{onClick:()=>ae(!0),children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),"New Filter Type"]})]})]}),0===H.length?e.jsxs("div",{className:"border rounded-lg p-8 text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"No filter types found. Create your first filter type to get started."}),U&&e.jsxs(n,{onClick:()=>ae(!0),children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),"Create First Filter Type"]})]}):e.jsxs(c,{value:ie,onValueChange:re,children:[e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto",children:e.jsx(o,{className:"inline-flex",children:H.map(s=>e.jsx(u,{value:s,children:s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},s))})}),H.map(s=>e.jsx(p,{value:s,children:qe(s)},s))]}),e.jsx(h,{open:Ne,onOpenChange:Fe,children:e.jsxs(m,{className:"max-w-3xl",children:[e.jsxs(x,{children:[e.jsx(j,{children:"Manage Filter Dependencies"}),e.jsx(f,{children:"Configure which filters should appear based on other filter selections."})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 items-end border p-4 rounded-lg bg-muted/20",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Target Filter (Show this...)"}),e.jsxs(v,{value:be.targetFilterType,onValueChange:e=>_e({...be,targetFilterType:e}),children:[e.jsx(g,{children:e.jsx(N,{placeholder:"Select filter"})}),e.jsx(F,{children:H.map(s=>e.jsx(b,{value:s,children:s.replace(/_/g," ")},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Source Filter (...when this is selected)"}),e.jsxs(v,{value:be.sourceFilterType,onValueChange:e=>_e({...be,sourceFilterType:e,sourceFilterValues:[]}),children:[e.jsx(g,{children:e.jsx(N,{placeholder:"Select parent filter"})}),e.jsxs(F,{children:[e.jsx(b,{value:"property_type",children:"Property Type"}),H.filter(e=>e!==be.targetFilterType).map(s=>e.jsx(b,{value:s,children:s.replace(/_/g," ")},s))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Trigger Values (Matches any)"}),e.jsxs(v,{disabled:!be.sourceFilterType,onValueChange:e=>{be.sourceFilterValues.includes(e)||_e({...be,sourceFilterValues:[...be.sourceFilterValues,e]})},children:[e.jsx(g,{children:e.jsx(N,{placeholder:"Add value..."})}),e.jsx(F,{children:we.map(s=>e.jsx(b,{value:s.value,children:s.label},s.value))})]}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:be.sourceFilterValues.map(s=>e.jsxs(_,{variant:"secondary",className:"cursor-pointer",onClick:()=>{_e({...be,sourceFilterValues:be.sourceFilterValues.filter(e=>e!==s)})},children:[we.find(e=>e.value===s)?.label||s," ×"]},s))})]})]}),e.jsx(n,{onClick:async()=>{if(!be.targetFilterType||!be.sourceFilterType||0===be.sourceFilterValues.length)return void O({title:"Error",description:"Please fill all fields",variant:"destructive"});const e=[...ve,be];try{await r.saveFilterDependencies(e),ge(e),Fe(!1),_e({targetFilterType:"",sourceFilterType:"",sourceFilterValues:[]}),O({title:"Success",description:"Dependency saved successfully"})}catch(s){O({title:"Error",description:"Failed to save dependency",variant:"destructive"})}},className:"w-full",children:"Add Rule"}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(R,{children:[e.jsx(k,{children:e.jsxs(D,{children:[e.jsx(z,{children:"Target Filter"}),e.jsx(z,{children:"Depends On"}),e.jsx(z,{children:"Values"}),e.jsx(z,{className:"text-right",children:"Action"})]})}),e.jsx(I,{children:0===ve.length?e.jsx(D,{children:e.jsx(P,{colSpan:4,className:"text-center text-muted-foreground",children:"No dependencies configured"})}):ve.map((s,a)=>e.jsxs(D,{children:[e.jsx(P,{className:"font-medium",children:s.targetFilterType}),e.jsx(P,{children:s.sourceFilterType}),e.jsx(P,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:s.sourceFilterValues.map(s=>e.jsx(_,{variant:"outline",className:"text-xs",children:s},s))})}),e.jsx(P,{className:"text-right",children:e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>(async e=>{const s=ve.filter((s,a)=>a!==e);try{await r.saveFilterDependencies(s),ge(s),O({title:"Success",description:"Dependency deleted successfully"})}catch(a){O({title:"Error",description:"Failed to delete dependency",variant:"destructive"})}})(a),children:e.jsx(w,{className:"h-4 w-4 text-destructive"})})})]},a))})]})})]})]})}),e.jsx(h,{open:X,onOpenChange:ee,children:e.jsxs(m,{children:[e.jsxs(x,{children:[e.jsx(j,{children:le?"Edit Filter":"Add Filter"}),e.jsx(f,{children:le?"Update the filter details below":"Create a new filter option"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"filter_type",children:"Filter Type"}),e.jsxs(v,{value:fe.filter_type,onValueChange:e=>{ye({...fe,filter_type:e}),"location"!==e&&(Se(""),Le([]))},disabled:!!le,children:[e.jsx(g,{children:e.jsx(N,{})}),e.jsx(F,{children:H.map(s=>e.jsx(b,{value:s,children:s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},s))})]})]}),"location"===fe.filter_type?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"location_search",children:"Search Location"}),e.jsxs("div",{className:"relative",children:[e.jsx(C,{id:"location_search",value:Te,onChange:e=>{const s=e.target.value;Se(s),s.length>2?(Ve(!0),setTimeout(()=>{const e=i.searchLocations(s);Le(e),Ve(!1)},100)):Le([])},placeholder:i.isReady()?"Search city, district, or pincode...":"Initializing location database...",className:"pr-10",disabled:!i.isReady()}),(!i.isReady()||Oe)&&e.jsx("div",{className:"absolute right-3 top-2.5",children:e.jsx(T,{className:"h-4 w-4 animate-spin text-muted-foreground"})}),Te.length>2&&0===Ee.length&&!Oe&&i.isReady()&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-md p-4 text-sm text-center text-muted-foreground",children:['No locations found matching "',Te,'"']}),Ee.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-md max-h-60 overflow-y-auto",children:Ee.map((s,a)=>e.jsxs("div",{className:"px-4 py-2 hover:bg-accent hover:text-accent-foreground cursor-pointer text-sm border-b last:border-0",onClick:()=>{const e=s.city,a=s.city.toLowerCase().replace(/\s+/g,"-");ye({...fe,name:e,value:a,display_label:e}),Se(e),Le([])},children:[e.jsx("div",{className:"font-medium text-foreground",children:s.city}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.district,", ",s.state," - ",s.pincode]})]},`${s.pincode}-${a}`))})]}),!i.isReady()&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Please wait while we load the location database (approx. 20MB)..."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"name",children:"Selected Name"}),e.jsx(C,{id:"name",value:fe.name,onChange:e=>ye({...fe,name:e.target.value}),readOnly:!0,className:"bg-muted"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"value",children:"Selected Value"}),e.jsx(C,{id:"value",value:fe.value,onChange:e=>ye({...fe,value:e.target.value}),readOnly:!0,className:"bg-muted"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"name",children:"Name *"}),e.jsx(C,{id:"name",value:fe.name,onChange:e=>ye({...fe,name:e.target.value}),placeholder:"e.g., For Sale",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"value",children:"Value (Unique ID) *"}),e.jsx(C,{id:"value",value:fe.value,onChange:e=>ye({...fe,value:e.target.value}),placeholder:"e.g., sale",disabled:!!le,required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"display_label",children:"Display Label (Optional)"}),e.jsx(C,{id:"display_label",value:fe.display_label,onChange:e=>ye({...fe,display_label:e.target.value}),placeholder:"Defaults to Name if not provided"})]}),["budget","area"].includes(fe.filter_type)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{htmlFor:"min_value",children:["Min Value ","budget"===fe.filter_type?"(₹)":"(sq ft)"]}),e.jsx(C,{id:"min_value",type:"number",value:fe.min_value||"",onChange:e=>ye({...fe,min_value:e.target.value?parseFloat(e.target.value):void 0}),placeholder:"budget"===fe.filter_type?"e.g., 2000000":"e.g., 1000"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{htmlFor:"max_value",children:["Max Value ","budget"===fe.filter_type?"(₹)":"(sq ft)"]}),e.jsx(C,{id:"max_value",type:"number",value:fe.max_value||"",onChange:e=>ye({...fe,max_value:e.target.value?parseFloat(e.target.value):void 0}),placeholder:"budget"===fe.filter_type?"e.g., 4000000":"e.g., 2000"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"display_order",children:"Display Order"}),e.jsx(C,{id:"display_order",type:"number",value:fe.display_order,onChange:e=>ye({...fe,display_order:parseInt(e.target.value)||0})})]})]}),e.jsxs(S,{children:[e.jsx(n,{variant:"outline",onClick:Me,children:"Cancel"}),e.jsx(n,{onClick:async()=>{try{if(!fe.filter_type||!fe.name||!fe.value)return void O({title:"Error",description:"Please fill in all required fields",variant:"destructive"});le?(await r.updateFilterConfiguration(le.id,fe),O({title:"Success",description:"Filter updated successfully"})):(await r.createFilterConfiguration(fe),O({title:"Success",description:"Filter created successfully"})),De(),Me()}catch(e){O({title:"Error",description:"Failed to save filter configuration",variant:"destructive"})}},children:le?"Update":"Create"})]})]})}),e.jsx(h,{open:se,onOpenChange:e=>{ae(e),e&&0===ce.length&&Ie()},children:e.jsxs(m,{children:[e.jsxs(x,{children:[e.jsx(j,{children:"Create New Filter Type"}),e.jsx(f,{children:"Create a new filter category. You can type a custom name or select from existing property fields."})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2 relative",children:[e.jsx(y,{htmlFor:"newFilterTypeName",children:"Filter Type Name *"}),e.jsx(C,{id:"newFilterTypeName",value:ne,onChange:e=>{de(e.target.value),me(null)},placeholder:"Type to search or enter custom name...",autoComplete:"off"}),ne.length>=1&&(()=>{if(ue)return e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-md p-3 text-sm text-muted-foreground",children:"Loading fields..."});if(0===ce.length)return null;const s=ce.filter(e=>e.fieldLabel.toLowerCase().includes(ne.toLowerCase())||e.fieldName.toLowerCase().includes(ne.toLowerCase()));return 0===s.length||1===s.length&&s[0].fieldLabel===ne?null:e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-md max-h-48 overflow-y-auto",children:s.map(s=>e.jsxs("div",{className:"px-3 py-2 text-sm cursor-pointer hover:bg-accent hover:text-accent-foreground border-b last:border-0",onClick:()=>{de(s.fieldLabel),me(s)},children:[e.jsxs("div",{className:"font-medium",children:[s.fieldLabel,e.jsxs("span",{className:"text-muted-foreground font-normal ml-1",children:["(",s.propertyTypeName,")"]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Type: ",s.fieldType,s.fieldOptions&&s.fieldOptions.length>0&&e.jsxs("span",{className:"ml-2 text-green-600",children:["• ",s.fieldOptions.length," options will be auto-created"]})]})]},s.fieldName))})})(),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Type to search existing fields or enter a custom filter name.",he&&he.fieldOptions?.length>0&&e.jsxs("span",{className:"block mt-1 text-green-600 font-medium",children:["✓ Selected field has ",he.fieldOptions.length," options that will be auto-populated"]})]})]})}),e.jsxs(S,{children:[e.jsx(n,{variant:"outline",onClick:()=>{ae(!1),de("")},children:"Cancel"}),e.jsx(n,{onClick:async()=>{if(!ne.trim())return;const e=ne.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"");if(H.includes(e))O({title:"Error",description:"Filter type already exists",variant:"destructive"});else try{W(!0),he&&he.fieldOptions&&he.fieldOptions.length>0?(await Promise.all(he.fieldOptions.map((s,a)=>r.createFilterConfiguration({filter_type:e,name:s,value:s.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_+]/g,""),display_label:s,display_order:a+1}))),O({title:"Success",description:`Filter type "${e}" created with ${he.fieldOptions.length} options auto-populated from field configuration.`}),De()):O({title:"Success",description:`Filter type "${e}" created. You can now add options to it.`}),J([...H,e].sort()),re(e),ae(!1),de(""),me(null)}catch(s){O({title:"Error",description:"Failed to create filter type",variant:"destructive"})}finally{W(!1)}},children:"Create Filter Type"})]})]})})]})},B=()=>{const{user:i}=l(),r=a(),{toast:n}=t(),d=i?.rolePermissions||[],c="admin"===i?.role||"superadmin"===i?.role||(o=E.FILTER_READ,d.includes(o));var o;return s.useEffect(()=>{c||(n({title:"Access Denied",description:"You don't have permission to view filter management.",variant:"destructive"}),r("/rolebased"))},[c,r,n]),c?e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(O,{className:"h-8 w-8"}),"Filter Management"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Configure search filters for the property search page"})]})}),e.jsx(q,{children:e.jsxs(U,{children:[e.jsx("strong",{children:"Note:"})," These filters appear on the customer property search page. Create dynamic filter types like Bedrooms, Budget, Listing Type, Furnishing, etc."]})}),e.jsx(V,{children:e.jsx(A,{className:"pt-6",children:e.jsx($,{})})})]}):null};export{B as default};
