import{aK as t,t as e}from"./index-CNlJR0_e.js";import{r as s}from"./reviewsService-DFov9A-b.js";import"./ui-BNZSgpjP.js";import"./router-D8v2YSKU.js";import"./vendor-BxThA0WO.js";const a="https://app.buildhomemartsquares.com/api";const r=new class{async makeRequest(e,s={}){const r=`${a}${e}`,n={headers:{"Content-Type":"application/json",...s.headers},...s},o=localStorage.getItem("token");o&&(n.headers={...n.headers,Authorization:`Bearer ${o}`});try{const e=await fetch(r,n);if(t(e),!e.ok){const t=await e.json().catch(()=>({success:!1,message:`HTTP ${e.status}: ${e.statusText}`}));throw new Error(t.message||"An error occurred")}return await e.json()}catch(i){throw i}}cleanObject(t){if(null===t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(t=>this.cleanObject(t)).filter(t=>void 0!==t);const e={};for(const[s,a]of Object.entries(t)){if(void 0===a)continue;const t=this.cleanObject(a);void 0!==t&&("object"!=typeof t||Array.isArray(t)||Object.keys(t).length>0)&&(e[s]=t)}return Object.keys(e).length>0?e:void 0}async getVendorProfile(){try{let e;try{e=await this.makeRequest("/vendors/profile")}catch(t){e=await this.makeRequest("/users/profile")}if(e.success&&e.data){const t=e.data.user;try{const e=await s.getReviewStats();t.profile?.vendorInfo?.rating?(t.profile.vendorInfo.rating.average=e.averageRating,t.profile.vendorInfo.rating.count=e.totalReviews):t.profile?.vendorInfo&&(t.profile.vendorInfo.rating={average:e.averageRating,count:e.totalReviews})}catch(a){}return t}throw new Error("Failed to fetch vendor profile")}catch(r){const t=r instanceof Error?r.message:"Failed to fetch vendor profile";throw e({title:"Error",description:t,variant:"destructive"}),r}}async updateVendorProfile(t){try{let o=null;const i=localStorage.getItem("user");if(i)try{const t=JSON.parse(i);o=t.id||t._id}catch(s){}if(!o){const t=localStorage.getItem("token");if(t)try{const e=JSON.parse(atob(t.split(".")[1]));o=e.userId||e.id}catch(a){}}if(!o)try{const t=await this.makeRequest("/auth/me");t.success&&t.data&&(o=t.data.user.id||t.data.user._id,localStorage.setItem("user",JSON.stringify(t.data.user)))}catch(r){}if(!o)throw new Error("Unable to determine user ID. Please log in again.");const c=this.cleanObject(t);let d;try{d=await this.makeRequest("/vendors/profile",{method:"PUT",body:JSON.stringify(c)})}catch(n){d=await this.makeRequest(`/users/${o}`,{method:"PUT",body:JSON.stringify(c)})}if(d.success&&d.data)return localStorage.setItem("user",JSON.stringify(d.data.user)),e({title:"Success",description:"Profile updated successfully!"}),d.data.user;throw new Error("Failed to update vendor profile")}catch(o){const t=o instanceof Error?o.message:"Failed to update vendor profile";throw e({title:"Error",description:t,variant:"destructive"}),o}}async getVendorStatistics(){try{const t=await this.makeRequest("/vendors/statistics");return t.success&&t.data?t.data:{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}catch(t){return{totalProperties:0,totalSales:0,totalValue:"â‚¹0",totalLeads:0,avgResponseTime:"Not calculated"}}}async checkSubscription(t){try{const e=await this.makeRequest(`/vendors/subscription/check/${t}`);return!(!e.success||!e.data)&&e.data.hasSubscription}catch(e){return!1}}async activateSubscription(t,e){try{return await this.makeRequest("/vendors/subscription/activate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,paymentId:e})})}catch(s){return{success:!1,message:"Failed to activate subscription. Please try again."}}}async getVendorSubscriptions(){try{const t=await this.makeRequest("/vendors/subscriptions");return t.success&&t.data?t.data.subscriptions:[]}catch(t){return[]}}async getSubscriptionLimits(){try{const t=await this.makeRequest("/vendors/subscription-limits");if(!t.success||!t.data)throw new Error("Failed to fetch subscription limits from server");return t.data}catch(t){throw t}}async cleanupSubscriptions(){try{const t=await this.makeRequest("/vendors/subscription/cleanup",{method:"POST"});return t.success?(e({title:"Subscriptions Cleaned Up",description:`Deactivated ${t.deactivatedCount} old subscriptions. Using latest subscription now.`}),await this.refreshSubscriptionData(),{success:!0,activeSubscription:t.activeSubscription,deactivatedCount:t.deactivatedCount}):{success:!1,activeSubscription:null,deactivatedCount:0}}catch(t){return e({title:"Error",description:"Failed to cleanup subscriptions",variant:"destructive"}),{success:!1,activeSubscription:null,deactivatedCount:0}}}async refreshSubscriptionData(){try{const t=await this.makeRequest("/vendors/subscription/refresh",{method:"POST"});if(t.success&&t.data){const s=[];for(let t=0;t<localStorage.length;t++){const e=localStorage.key(t);e&&(e.includes("subscription")||e.includes("limits")||e.includes("plan"))&&s.push(e)}return s.forEach(t=>localStorage.removeItem(t)),e({title:"Success",description:t.message||"Subscription data refreshed successfully!"}),t.data}throw new Error("Failed to refresh subscription data")}catch(t){const s=t instanceof Error?t.message:"Failed to refresh subscription data";throw e({title:"Error",description:s,variant:"destructive"}),t}}async updateVendorSettings(t){try{const s=this.cleanObject(t),a=await this.makeRequest("/vendors/settings",{method:"PUT",body:JSON.stringify({...s,meta:{lastUpdated:(new Date).toISOString(),version:"2.0",source:"dynamic-vendor-settings",supportEmail:"support@buildhomemartsquares.com"}})});if(a.success)return localStorage.setItem("dynamicVendorSettings",JSON.stringify(a.data)),e({title:"âœ… Settings Synced",description:"All vendor preferences saved successfully."}),a.data;throw new Error("Failed to update vendor settings")}catch(s){const a="dynamicVendorSettings",r={...t,meta:{lastUpdated:(new Date).toISOString(),version:"2.0",source:"dynamic-vendor-settings-offline",pendingSync:!0,supportEmail:"support@buildhomemartsquares.com"}};return localStorage.setItem(a,JSON.stringify(r)),e({title:"ðŸ’¾ Settings Saved Offline",description:"Settings cached locally. Will sync when online."}),r}}async getVendorSettings(){try{const t=await this.makeRequest("/vendors/settings");if(t.success&&t.data)return t.data;const e=localStorage.getItem("dynamicVendorSettings");return e?JSON.parse(e):null}catch(t){const e=localStorage.getItem("dynamicVendorSettings");return e?JSON.parse(e):null}}async sendVendorSettingsNotification(t,e,s){try{(new Date).toISOString()}catch(a){}}async updateVendorPreferences(t,s){try{const e=await this.getVendorSettings()||{},a={...e,preferences:{...e.preferences,[t]:s},meta:{lastUpdated:(new Date).toISOString(),lastChangedField:t,source:"real-time-update"}};await this.updateVendorSettings(a);t.replace(/([A-Z])/g," $1").toLowerCase()}catch(a){e({title:"Update Failed",description:"Preference will sync when connection is restored.",variant:"destructive"})}}async validateVendorSubscription(){try{const t=await this.makeRequest("/vendors/subscription/validate");if(!t.success||!t.data)throw new Error("Failed to validate subscription from server");return t.data}catch(t){throw t}}async getAutoResponseSettings(){try{const t=await this.getVendorSettings();return{enabled:t?.business?.autoResponseEnabled||!1,message:t?.business?.autoResponseMessage||"Thank you for your interest! I'll get back to you soon."}}catch(t){return{enabled:!1,message:"Thank you for your interest! I'll get back to you soon."}}}async updateAutoResponseSettings(t,s){try{await this.updateVendorPreferences("business.autoResponseEnabled",t),s.trim()&&await this.updateVendorPreferences("business.autoResponseMessage",s),e({title:"Auto-Response Updated",description:t?"Auto-responses are now enabled":"Auto-responses have been disabled"})}catch(a){throw a}}async checkVendorWhatsAppSupport(t){try{const e=await this.makeRequest(`/vendors/${t}/whatsapp-check`);return e.success&&e.data?{whatsappEnabled:e.data.whatsappEnabled,whatsappNumber:e.data.whatsappNumber}:{whatsappEnabled:!1,whatsappNumber:null}}catch(e){return{whatsappEnabled:!1,whatsappNumber:null}}}async getMyBadges(){try{const t=await this.makeRequest("/vendors/subscription/badges");if(t.success&&t.data)return t.data;throw new Error("Failed to fetch badges from server")}catch(t){return e({title:"Error",description:"Failed to load badge information.",variant:"destructive"}),{hasSubscription:!1,badges:[],planName:null,planLevel:"free"}}}async getVendorBadges(t){try{const e=await fetch(`${a}/vendors/${t}/badges`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const s=await e.json();if(!s.success)throw new Error(s.message||"Failed to fetch vendor badges");return s.data}catch(e){return{hasSubscription:!1,badges:[],planName:null,planLevel:"free"}}}async getFeaturedVendors(t=8){try{const e=await fetch(`${a}/properties/featured-vendors?limit=${t}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const s=await e.json();if(!s.success)throw new Error(s.message||"Failed to fetch featured vendors");return{success:!0,data:s.data.vendors||[]}}catch(e){return{success:!1,data:[]}}}};export{r as default,r as vendorService};
