import{t,c as e,d as o,f as n,a,g as r,e as i,h as s,i as c}from"./en-US-Blz_tpgH.js";import{r as u}from"./router-Bi51YGN-.js";import{u as f,y as d,t as l}from"./index-CV77Hym3.js";function h(e,o){const n=t(e),a=t(o),r=n.getTime()-a.getTime();return r<0?-1:r>0?1:r}function m(e){const n=t(e);return+function(e){const o=t(e);return o.setHours(23,59,59,999),o}(n)===+o(n)}function p(e,o,n){const a=function(e,o){return+t(e)-+t(o)}(e,o)/1e3;return(r=n?.roundingMethod,t=>{const e=(r?Math[r]:Math.trunc)(t);return 0===e?0:e})(a);var r}function w(e,o,u){const f=r(),d=u?.locale??f.locale??i,l=h(e,o);if(isNaN(l))throw new RangeError("Invalid time value");const w=Object.assign({},u,{addSuffix:u?.addSuffix,comparison:l});let y,T;l>0?(y=t(o),T=t(e)):(y=t(e),T=t(o));const N=p(T,y),S=(a(T)-a(y))/1e3,g=Math.round((N-S)/60);let v;if(g<2)return u?.includeSeconds?N<5?d.formatDistance("lessThanXSeconds",5,w):N<10?d.formatDistance("lessThanXSeconds",10,w):N<20?d.formatDistance("lessThanXSeconds",20,w):N<40?d.formatDistance("halfAMinute",0,w):N<60?d.formatDistance("lessThanXMinutes",1,w):d.formatDistance("xMinutes",1,w):0===g?d.formatDistance("lessThanXMinutes",1,w):d.formatDistance("xMinutes",g,w);if(g<45)return d.formatDistance("xMinutes",g,w);if(g<90)return d.formatDistance("aboutXHours",1,w);if(g<s){const t=Math.round(g/60);return d.formatDistance("aboutXHours",t,w)}if(g<2520)return d.formatDistance("xDays",1,w);if(g<c){const t=Math.round(g/s);return d.formatDistance("xDays",t,w)}if(g<2*c)return v=Math.round(g/c),d.formatDistance("aboutXMonths",v,w);if(v=function(e,o){const a=t(e),r=t(o),i=h(a,r),s=Math.abs(n(a,r));let c;if(s<1)c=0;else{1===a.getMonth()&&a.getDate()>27&&a.setDate(30),a.setMonth(a.getMonth()-i*s);let o=h(a,r)===-i;m(t(e))&&1===s&&1===h(e,r)&&(o=!1),c=i*(s-Number(o))}return 0===c?0:c}(T,y),v<12){const t=Math.round(g/c);return d.formatDistance("xMonths",t,w)}{const t=v%12,e=Math.trunc(v/12);return t<3?d.formatDistance("aboutXYears",e,w):t<9?d.formatDistance("overXYears",e,w):d.formatDistance("almostXYears",e+1,w)}}function y(t,o){return w(t,function(t){return e(t,Date.now())}(t),o)}const T=()=>{const[t,e]=u.useState(!1),[o,n]=u.useState([]),[a,r]=u.useState(null),i=u.useRef(null),s=u.useRef(new Set),{user:c}=f(),h=()=>{const t=d.getToken();if(!c||!t||i.current)return;const o=`https://api.buildhomemartsquares.com/api/notifications/stream?token=${encodeURIComponent(t)}`,a=new EventSource(o);a.onopen=()=>{e(!0)},a.onmessage=t=>{try{const e=JSON.parse(t.data),o=`${e.type}-${e.timestamp}-${e.userId}`;if(s.current.has(o))return;if("connection"===e.type)return;if(s.current.add(o),s.current.size>100){const t=Array.from(s.current)[0];s.current.delete(t)}p(e),n(t=>[e,...t].slice(0,20))}catch(e){}},a.onerror=()=>{e(!1),i.current===a&&(a.close(),i.current=null),setTimeout(()=>{const t=d.getToken();c&&t&&!i.current&&h()},5e3)},i.current=a},m=()=>{i.current&&(i.current.close(),i.current=null,e(!1))},p=t=>{const e=w(t);e.showToast&&l({title:t.title,description:t.message,variant:e.variant,duration:e.duration}),e.playSound&&y(),e.showBrowserNotification&&"granted"===Notification.permission&&new Notification(t.title,{body:t.message,icon:"/favicon.png",tag:t.type})},w=t=>{const e={property_alert:{showToast:!0,variant:"default",duration:5e3,playSound:!0,showBrowserNotification:!0},price_alert:{showToast:!0,variant:"default",duration:6e3,playSound:!0,showBrowserNotification:!0},new_message:{showToast:!0,variant:"default",duration:4e3,playSound:!0,showBrowserNotification:!0},service_update:{showToast:!0,variant:"default",duration:5e3,playSound:!1,showBrowserNotification:!0},property_update:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!1},broadcast:{showToast:!0,variant:"default",duration:8e3,playSound:!1,showBrowserNotification:!0},announcement:{showToast:!0,variant:"default",duration:8e3,playSound:!1,showBrowserNotification:!0},lead_alert:{showToast:!0,variant:"default",duration:6e3,playSound:!0,showBrowserNotification:!0},inquiry_received:{showToast:!0,variant:"default",duration:5e3,playSound:!0,showBrowserNotification:!0},weekly_report:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!0},business_update:{showToast:!0,variant:"default",duration:5e3,playSound:!1,showBrowserNotification:!0},default:{showToast:!0,variant:"default",duration:4e3,playSound:!1,showBrowserNotification:!1}};return e[t.type]||e.default},y=()=>{try{const t=new Audio("/notification-sound.mp3");t.volume=.5,t.play().catch(()=>{})}catch(t){}};return u.useEffect(()=>{const t=d.getToken();return c&&t&&!i.current&&h(),()=>{m()}},[c]),u.useEffect(()=>()=>{m()},[]),{isConnected:t,notifications:o,stats:a,connect:h,disconnect:m,sendTestNotification:async()=>{const t=d.getToken();if(t)try{const e="https://api.buildhomemartsquares.com/api";if(!(await fetch(`${e}/notifications/test`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include",body:JSON.stringify({type:"test",message:"This is a test notification from the real-time system!"})})).ok)throw new Error("Failed to send test notification")}catch(e){l({title:"Error",description:"Failed to send test notification",variant:"destructive"})}},getNotificationStats:async()=>{const t=d.getToken();if(t)try{const e="https://api.buildhomemartsquares.com/api",o=await fetch(`${e}/notifications/stats`,{method:"GET",headers:{Authorization:`Bearer ${t}`},credentials:"include"});if(!o.ok)throw new Error("Failed to fetch notification stats");const n=await o.json();return r(n.data),n.data}catch(e){return null}},clearNotifications:()=>{n([]),s.current.clear()},markAsRead:t=>{n(e=>e.map(e=>e.timestamp===t?{...e,read:!0}:e))},requestNotificationPermission:async()=>{if("Notification"in window&&"default"===Notification.permission){return"granted"===await Notification.requestPermission()}return"granted"===Notification.permission}}};export{y as f,T as u};
