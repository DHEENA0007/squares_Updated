import{j as e}from"./ui-s1SEoZIF.js";import{d as t,r as s}from"./router-D8v2YSKU.js";import{u as a,_ as n,x as i,f as r,a as l,b as c,c as d,d as o,e as m,I as u,m as x,n as p,o as h,p as j,q as g,ay as v,af as f,B as N,E as b,a0 as y,a1 as w,a2 as A,a3 as S,a4 as D,s as R,Q as C,G as P,az as T,ah as E,W as M,T as _,V as I,U as k,O as V}from"./index-YrVmIx3a.js";import{F as $,E as H}from"./exportUtils-CeUKc14U.js";import{P as F,a as L,b as Y,c as U,d as z,e as O}from"./pagination-BsAF6nms.js";import{s as q}from"./subscriptionService-o665gKHh.js";import{T as B,a as G,b as W,c as K,d as Q,e as J}from"./table-BdC2txne.js";import{C as X}from"./calendar-BA5iLWFv.js";import{L as Z,M as ee}from"./megaphone-CfqKcPFk.js";import{C as te}from"./camera-BGEwbgLA.js";import"./vendor-BxThA0WO.js";import"./ellipsis-XCtCMAGV.js";const se=e=>`Rs. ${(e||0).toLocaleString("en-IN")}`,ae=()=>{const{user:ae}=a(),ne=t(),ie=ae?.rolePermissions||[],re="admin"===ae?.role||"superadmin"===ae?.role,le=e=>ie.includes(e),ce=re||le(I.CLIENTS_READ),de=re||le(I.CLIENTS_ACCESS_ACTIONS),oe=re||le(I.CLIENTS_ACCESS_DETAILS),me=re||le(I.CLIENTS_DETAILS_EDIT),[ue,xe]=s.useState(""),[pe,he]=s.useState(""),[je,ge]=s.useState("all"),[ve,fe]=s.useState("all"),[Ne,be]=s.useState(""),[ye,we]=s.useState([]),[Ae,Se]=s.useState(!0),[De,Re]=s.useState(1),[Ce,Pe]=s.useState(1),[Te,Ee]=s.useState(null),[Me,_e]=s.useState(!1),[Ie,ke]=s.useState(!1),[Ve,$e]=s.useState(""),[He,Fe]=s.useState(null),{toast:Le}=n();s.useEffect(()=>{ce||(Le({title:"Access Denied",description:"You don't have permission to view clients.",variant:"destructive"}),ne("/rolebased"))},[ce,ne,Le]),s.useEffect(()=>{const e=setTimeout(()=>{he(ue),ue!==pe&&Re(1)},500);return()=>clearTimeout(e)},[ue]);const Ye=s.useMemo(()=>{const e=new Set;return ye.forEach(t=>{t.plan?.name&&e.add(t.plan.name)}),Array.from(e).sort()},[ye]);s.useMemo(()=>{const e=new Map;ye.forEach(t=>{let s=t.plan?.billingCycleMonths;if(!s&&t.startDate&&t.endDate){const e=new Date(t.startDate),a=new Date(t.endDate);s=12*(a.getFullYear()-e.getFullYear())+(a.getMonth()-e.getMonth())+(a.getDate()-e.getDate()>=15?1:0),s<1&&a>e&&(s=1)}if(!s&&t.plan?.billingPeriod){const e=t.plan.billingPeriod.toLowerCase();"monthly"===e?s=1:"quarterly"===e?s=3:"semi-annual"===e||"semiannual"===e?s=6:"yearly"===e||"annual"===e?s=12:"lifetime"===e&&(s=120)}if(s){const a=t.plan?.billingPeriod||"custom";e.set(s,a)}});return Array.from(e.entries()).sort((e,t)=>e[0]-t[0]).map(([e,t])=>({value:e.toString(),label:`${e}`,original:t,months:e}))},[ye]);const Ue=s.useMemo(()=>ye.filter(e=>{if("all"!==je&&e.status!==je)return!1;if("all"!==ve&&e.plan?.name!==ve)return!1;if(Ne&&""!==Ne.trim()){const t=parseInt(Ne.trim());if(isNaN(t))return!0;let s=e.plan?.billingCycleMonths;if(!s&&e.startDate&&e.endDate){const t=new Date(e.startDate),a=new Date(e.endDate);s=12*(a.getFullYear()-t.getFullYear())+(a.getMonth()-t.getMonth())+(a.getDate()-t.getDate()>=15?1:0),s<1&&a>t&&(s=1)}if(!s&&e.plan?.billingPeriod){const t=e.plan.billingPeriod.toLowerCase();"monthly"===t?s=1:"quarterly"===t?s=3:"semi-annual"===t||"semiannual"===t?s=6:"yearly"===t||"annual"===t?s=12:"lifetime"===t&&(s=120)}if(s!==t)return!1}return!0}),[ye,je,ve,Ne]),ze="all"!==je||"all"!==ve||""!==Ne||""!==ue,Oe=t=>{const s={className:"w-4 h-4"};switch(t?.toLowerCase()){case"photography":return e.jsx(te,{...s});case"marketing":return e.jsx(ee,{...s});case"technology":return e.jsx(Z,{...s});case"support":return e.jsx(V,{...s});case"crm":return e.jsx(k,{...s});default:return e.jsx(C,{...s})}},qe=s.useCallback(async()=>{try{Se(!0);const e={page:De,limit:10,search:pe||void 0,status:"all"===je?void 0:je},t=await q.getSubscriptions(e),s=t.data.subscriptions.filter(e=>e&&e.user&&(e.user.name||e.user.email));s.forEach((e,t)=>{e.paymentHistory&&e.paymentHistory.length}),we(s),Pe(t.data.pagination.totalPages)}catch(e){e instanceof Error&&(e.message.includes("Admin access required")?Le({title:"Access Denied",description:"Admin privileges required to view subscriptions.",variant:"destructive"}):e.message.includes("Authentication required")?Le({title:"Authentication Required",description:"Please log in to continue.",variant:"destructive"}):Le({title:"Error",description:"Failed to load subscriptions. Please try again.",variant:"destructive"}))}finally{Se(!1)}},[De,pe,je]);s.useEffect(()=>{qe()},[qe]);const Be=e=>{Ee(e),_e(!0)};return Ae?e.jsxs("div",{className:"flex justify-center items-center py-12",children:[e.jsx(i,{className:"h-8 w-8 animate-spin"}),e.jsx("span",{className:"ml-2 text-lg",children:"Loading clients..."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Subscribed Users"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Manage user subscriptions and details"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(r,{variant:"outline",onClick:()=>{if(ye&&0!==ye.length?0!==ye.filter(e=>e&&e._id&&e.user&&e.status).length||(Le({title:"Invalid Data",description:"No valid subscription data found for export. Please contact support if this issue persists.",variant:"destructive"}),0):(Le({title:"No Data",description:"No subscription data available for export. Please check if there are any subscriptions in the system.",variant:"destructive"}),0))try{const e=(new Date).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),t=(()=>{const e=ye.filter(e=>e&&e._id&&e.user&&e.status);if(0===e.length)throw new Error("No valid subscription data found");const t=e.filter(e=>"active"===e.status),s=e.filter(e=>"expired"===e.status),a=e.filter(e=>"cancelled"===e.status),n=e=>{const t=e.paymentDetails&&(e.paymentDetails.razorpayPaymentId||e.transactionId);let s=[];if(e.paymentHistory&&e.paymentHistory.length>0&&(s=e.paymentHistory.filter(e=>e&&e.amount&&e.amount>0&&("subscription_purchase"===e.type||"renewal"===e.type||"upgrade"===e.type))),0===s.length&&t&&e.lastPaymentDate){if("cancelled"===e.status&&e.updatedAt){const t=new Date(e.lastPaymentDate);if((new Date(e.updatedAt).getTime()-t.getTime())/864e5<=1)return 0}return e.amount||0}if(0===s.length)return 0;const a=s.sort((e,t)=>new Date(e.date||"").getTime()-new Date(t.date||"").getTime());let n=0,i=0;if(a.forEach((e,t)=>{if("subscription_purchase"===e.type)n+=e.amount||0,i=e.amount||0;else if("renewal"===e.type)n+=e.amount||0;else if("upgrade"===e.type){const t=e.amount||0,s=t-i;s>0&&(n+=s),i=t}}),"cancelled"===e.status&&a.length>0){const t=a[a.length-1],s=new Date(e.updatedAt||""),i=new Date(t.date||"");(s.getTime()-i.getTime())/864e5<=1&&(n*=.5)}return Math.max(0,n)},i=t.reduce((e,t)=>e+n(t),0),r=e.reduce((e,t)=>e+n(t),0),l=a.reduce((e,t)=>t.paymentHistory&&t.paymentHistory.length>0?e+n(t):e,0),c=s.reduce((e,t)=>t.paymentHistory&&t.paymentHistory.length>0?e+n(t):e,0),d=e.reduce((e,t)=>{if(!t.addons||!Array.isArray(t.addons)||0===t.addons.length)return e;let s=0;if(t.paymentHistory&&t.paymentHistory.length>0){const a=t.paymentHistory.filter(e=>e&&"addon_purchase"===e.type&&e.amount&&e.amount>0);if(a.length>0)return s=a.reduce((e,t)=>e+(t.amount||0),0),e+s}if((t.paymentDetails&&t.paymentDetails.razorpayPaymentId||t.lastPaymentDate||t.transactionId)&&"active"===t.status){const e="object"==typeof t.plan&&null!==t.plan&&t.plan.price||0,a=(t.amount||0)-e;a>0&&(s=a)}return e+s},0);return{validSubscriptions:e,activeSubscriptions:t,expiredSubscriptions:s,cancelledSubscriptions:a,totalActiveRevenue:i,totalRevenueAll:r,cancelledRevenue:l,expiredRevenue:c,addonRevenue:d,grandTotalRevenue:i+d,calculateRevenue:n}})(),s=[{Metric:"Total Clients","Count / Amount":t.validSubscriptions.length},{Metric:"Active Subscriptions","Count / Amount":t.activeSubscriptions.length},{Metric:"Cancelled Subscriptions","Count / Amount":t.cancelledSubscriptions.length},{Metric:"Expired Subscriptions","Count / Amount":t.expiredSubscriptions.length},{Metric:"Total Subscriptions","Count / Amount":t.validSubscriptions.length},{Metric:"Total Active Revenue (Verified Paid)","Count / Amount":se(t.totalActiveRevenue)},{Metric:"Total Revenue from All Paid Subscriptions","Count / Amount":se(t.totalRevenueAll)},{Metric:"Revenue from Cancelled Subscriptions (Paid)","Count / Amount":se(t.cancelledRevenue)},{Metric:"Revenue from Expired Subscriptions (Paid)","Count / Amount":se(t.expiredRevenue)},{Metric:"Add-on Revenue (Verified Paid)","Count / Amount":se(t.addonRevenue)},{Metric:"Grand Total Revenue (All Verified Payments)","Count / Amount":se(t.grandTotalRevenue)}],a=t.totalActiveRevenue+t.cancelledRevenue+t.expiredRevenue,n=[{Status:"Active (Verified Paid)",Count:t.activeSubscriptions.length,"Total Amount":se(t.totalActiveRevenue),"% of Total Amount":a>0?`${(t.totalActiveRevenue/a*100).toFixed(1)}%`:"0%"},{Status:"Cancelled (Previously Paid)",Count:t.cancelledSubscriptions.length,"Total Amount":se(t.cancelledRevenue),"% of Total Amount":a>0?`${(t.cancelledRevenue/a*100).toFixed(1)}%`:"0%"},{Status:"Expired (Previously Paid)",Count:t.expiredSubscriptions.length,"Total Amount":se(t.expiredRevenue),"% of Total Amount":a>0?`${(t.expiredRevenue/a*100).toFixed(1)}%`:"0%"}],i=(e=>{const{validSubscriptions:t,calculateRevenue:s}=e;return t.map((e,t)=>{const a="object"==typeof e.user&&null!==e.user&&(e.user.name||e.user.email)||`Client ${t+1}`,n="object"==typeof e.user&&null!==e.user&&e.user.email||"N/A",i="object"==typeof e.plan&&null!==e.plan&&e.plan.name||"Unknown Plan",r="object"==typeof e.plan&&null!==e.plan&&e.plan.price||0,l=s(e),c=Array.isArray(e.addons)?e.addons.length:0;let d=0;if(Array.isArray(e.addons)&&e.addons.length>0)if(Array.isArray(e.paymentHistory)){const t=e.paymentHistory.filter(e=>e&&"addon_purchase"===e.type&&e.amount&&e.amount>0).reduce((e,t)=>e+(t?.amount||0),0);if(t>0)d=t;else if("active"===e.status){const t=(e.amount||0)-r;d=t>0?t:0}}else if("active"===e.status){const t=(e.amount||0)-r;d=t>0?t:0}return{"#":t+1,"Client Name":a,Email:n,Plan:i,"Plan Price":se(r),"Paid Amount":se(l),Status:q.formatSubscriptionStatus(e.status||"unknown").label,"Start Date":H.formatDate(e.startDate),"End Date":H.formatDate(e.endDate),"Auto Renew":e.autoRenew?"Yes":"No","Add-ons":c,"Add-on Amount":se(d),"Payment Status":l>0?"Paid":"Unpaid"}})})(t),r=i.map(e=>({"#":e["#"],"Client Name":e["Client Name"],Email:e.Email,Plan:e.Plan,"Plan Price":e["Plan Price"],"Paid Amount":e["Paid Amount"],Status:e.Status,"Start Date":e["Start Date"],"End Date":e["End Date"],"Auto Renew":e["Auto Renew"],"Add-ons":e["Add-ons"],"Add-on Amount":e["Add-on Amount"],"Payment Status":e["Payment Status"]})),l=(e=>{const{validSubscriptions:t}=e,s=[];return t.forEach(e=>{const t="object"==typeof e.user&&null!==e.user&&(e.user.name||e.user.email)||"Unknown Client";Array.isArray(e.addons)&&e.addons.length>0&&e.addons.forEach(a=>{if("object"==typeof a&&null!==a&&a.name){const n=Array.isArray(e.paymentHistory)?e.paymentHistory.filter(e=>e&&"addon_purchase"===e.type&&Array.isArray(e.addons)&&e.addons.includes(a._id)).sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime())[0]:null;s.push({"#":s.length+1,"Client Name":t,"Add-on Name":a.name,Category:a.category||"N/A",Price:se(a.price),"Billing Type":a.billingType?.replace("_"," ")||"N/A","Last Payment Date":n?H.formatDate(n.date):"N/A"})}})}),s})(t),c=t.activeSubscriptions.length,d=c>0?Math.round(t.totalActiveRevenue/c):0,o={};t.activeSubscriptions.forEach(e=>{const s=e.plan?.name||"Unknown",a=t.calculateRevenue(e);o[s]=(o[s]||0)+a});const m=Object.entries(o).sort(([,e],[,t])=>t-e)[0]?.[0]||"N/A",u={};t.validSubscriptions.forEach(e=>{e.addons?.forEach(e=>{e?.name&&(u[e.name]=(u[e.name]||0)+1)})});const x=Object.entries(u).sort(([,e],[,t])=>t-e)[0]?.[0]||"N/A",p=[{Insight:"Total Active Clients",Value:c},{Insight:"Average Revenue per Active Client (ARPC)",Value:se(d)},{Insight:"Total Paid Revenue (All Time)",Value:se(t.totalRevenueAll)},{Insight:"Active Subscriptions Revenue",Value:se(t.totalActiveRevenue)},{Insight:"Addon Revenue (Active)",Value:se(t.addonRevenue)},{Insight:"Highest-Grossing Plan",Value:m},{Insight:"Most Purchased Add-on",Value:x}],h=(()=>{const e={};return t.validSubscriptions.forEach(s=>{if(s.createdAt||s.startDate){const a=new Date(s.createdAt||s.startDate),n=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`;e[n]||(e[n]={subscriptionRevenue:0,addonRevenue:0,newSubscriptions:0,cancelledSubscriptions:0,upgrades:0,totalRevenue:0}),e[n].newSubscriptions+=1;const i=t.calculateRevenue(s);i>0&&(e[n].subscriptionRevenue+=i)}if("cancelled"===s.status&&s.updatedAt){const t=new Date(s.updatedAt),a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;e[a]||(e[a]={subscriptionRevenue:0,addonRevenue:0,newSubscriptions:0,cancelledSubscriptions:0,upgrades:0,totalRevenue:0}),e[a].cancelledSubscriptions+=1}s.paymentHistory&&s.paymentHistory.length>0&&s.paymentHistory.forEach(t=>{if(t.date&&t.amount&&t.amount>0){const a=new Date(t.date),n=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`;if(e[n]||(e[n]={subscriptionRevenue:0,addonRevenue:0,newSubscriptions:0,cancelledSubscriptions:0,upgrades:0,totalRevenue:0}),"addon_purchase"===t.type)e[n].addonRevenue+=t.amount;else if("upgrade"===t.type){e[n].upgrades+=1;const i=s.paymentHistory?.filter(e=>e.date&&new Date(e.date)<a&&("subscription_purchase"===e.type||"upgrade"===e.type)).sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime()),r=i&&i.length>0&&i[0].amount||0,l=t.amount-r;l>0&&(e[n].subscriptionRevenue+=l)}else"subscription_purchase"!==t.type&&"renewal"!==t.type||(e[n].subscriptionRevenue+=t.amount)}})}),Object.keys(e).forEach(t=>{e[t].totalRevenue=e[t].subscriptionRevenue+e[t].addonRevenue}),Object.keys(e).sort().map(t=>({Month:t,"New Subscriptions":e[t].newSubscriptions,"Cancelled Subscriptions":e[t].cancelledSubscriptions,Upgrades:e[t].upgrades,"Subscription Revenue":se(e[t].subscriptionRevenue),"Addon Revenue":se(e[t].addonRevenue),"Total Revenue":se(e[t].totalRevenue)}))})(),j=(()=>{const e=new Date,s=(e.getMonth(),e.getFullYear()),a=t.validSubscriptions.filter(e=>new Date(e.createdAt||e.startDate).getFullYear()===s).reduce((e,s)=>e+t.calculateRevenue(s),0),n=t.validSubscriptions.filter(e=>new Date(e.createdAt||e.startDate).getFullYear()===s-1).reduce((e,s)=>e+t.calculateRevenue(s),0),i=n>0?((a-n)/n*100).toFixed(1):"N/A",r=t.cancelledSubscriptions.length,l=t.validSubscriptions.length,o=l>0?(r/l*100).toFixed(1):"0",u={};t.activeSubscriptions.forEach(e=>{const t=e.plan?.name||"Unknown";u[t]=(u[t]||0)+1});return[{Metric:"Total Revenue (All Time)",Value:se(t.totalRevenueAll)},{Metric:"Active Subscriptions Revenue",Value:se(t.totalActiveRevenue)},{Metric:"Addon Revenue",Value:se(t.addonRevenue)},{Metric:"This Year Revenue",Value:se(a)},{Metric:"Last Year Revenue",Value:se(n)},{Metric:"Year-over-Year Growth",Value:`${i}%`},{Metric:"Churn Rate",Value:`${o}%`},{Metric:"Average Revenue per Client (ARPC)",Value:se(d)},{Metric:"Total Active Clients",Value:c},{Metric:"Total Clients (All Time)",Value:t.validSubscriptions.length},{Metric:"Conversion Rate (Active/Total)",Value:`${l>0?(c/l*100).toFixed(1):0}%`},{Metric:"Most Popular Plan",Value:m},{Metric:"Plan Distribution",Value:Object.entries(u).map(([e,t])=>`${e}: ${t}`).join(", ")}]})(),g={filename:"subscribed_clients_revenue_report",title:"Subscribed Clients Revenue Report",metadata:{"Generated on":e,"Report Period":"All Time","Prepared by":"Admin System"}},v=[{name:"Summary Statistics",data:s,columns:[{wch:30},{wch:20}]},{name:"Status Breakdown",data:n,columns:[{wch:15},{wch:10},{wch:20},{wch:20}]},{name:"Monthly Report",data:h,columns:[{wch:12},{wch:15},{wch:18},{wch:12},{wch:18},{wch:15},{wch:15}]},{name:"Overall Analysis",data:j,columns:[{wch:35},{wch:25}]},{name:"Subscription Details",data:r,columns:[{wch:5},{wch:25},{wch:30},{wch:20},{wch:15},{wch:15},{wch:12},{wch:15},{wch:12},{wch:10},{wch:8},{wch:15},{wch:12}]},{name:"Add-on Details",data:l,columns:[{wch:5},{wch:25},{wch:25},{wch:15},{wch:12},{wch:20},{wch:15}]},{name:"Key Insights",data:p,columns:[{wch:35},{wch:25}]}];H.generateExcelReport(g,v),Le({title:"Export Successful",description:"Comprehensive revenue report with monthly analysis and corrected calculations has been generated successfully"})}catch(e){Le({title:"Export Failed",description:"Failed to export data to Excel. Please try again.",variant:"destructive"})}},children:[e.jsx($,{className:"w-4 h-4"}),e.jsx("span",{className:"ml-2",children:"Export Excel"})]})})]}),e.jsxs(l,{children:[e.jsxs(c,{children:[e.jsx(d,{children:"All Clients"}),e.jsxs(o,{children:[ye.length," client",1!==ye.length?"s":""," found"]})]}),e.jsxs(m,{children:[e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row gap-3",children:e.jsx("div",{className:"flex-1",children:e.jsx(u,{placeholder:"Search by client name or email...",value:ue,onChange:e=>xe(e.target.value),className:"w-full"})})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3",children:[e.jsx("div",{children:e.jsxs(x,{value:je,onValueChange:ge,children:[e.jsx(p,{children:e.jsx(h,{placeholder:"Filter by status"})}),e.jsxs(j,{children:[e.jsx(g,{value:"all",children:"All Status"}),e.jsx(g,{value:"active",children:"Active"}),e.jsx(g,{value:"expired",children:"Expired"}),e.jsx(g,{value:"cancelled",children:"Cancelled"})]})]})}),e.jsx("div",{children:e.jsxs(x,{value:ve,onValueChange:fe,children:[e.jsx(p,{children:e.jsx(h,{placeholder:"Filter by plan"})}),e.jsxs(j,{children:[e.jsx(g,{value:"all",children:"All Plans"}),Ye.map(t=>e.jsx(g,{value:t,children:t},t))]})]})}),e.jsx("div",{children:e.jsx(u,{type:"number",placeholder:"Filter by months (e.g., 1, 3, 12)",value:Ne,onChange:e=>be(e.target.value),min:"1",className:"w-full"})}),ze&&e.jsx("div",{children:e.jsxs(r,{variant:"outline",onClick:()=>{ge("all"),fe("all"),be(""),xe("")},className:"w-full",children:[e.jsx(v,{className:"w-4 h-4 mr-2"}),"Clear Filters"]})})]}),ze&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(f,{className:"w-4 h-4"}),e.jsxs("span",{children:["Showing ",Ue.length," of ",ye.length," results"]})]})]}),e.jsx("div",{className:"block sm:hidden space-y-4",children:0===Ue.length?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No subscriptions found"}):Ue.map((t,s)=>e.jsx(l,{className:"hover:shadow-md transition-shadow",children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx("span",{className:"text-sm font-semibold text-primary",children:10*(De-1)+s+1})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-base truncate",children:t.user.name}),e.jsx("div",{className:"text-sm text-muted-foreground truncate",children:t.user.email})]})]}),e.jsx(N,{variant:"active"===t.status?"default":"expired"===t.status?"destructive":"secondary",className:"ml-2 flex-shrink-0",children:q.formatSubscriptionStatus(t.status).label})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Plan:"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium",children:t.plan?.name||"N/A"}),e.jsx("div",{className:"text-muted-foreground capitalize",children:t.plan?.billingPeriod||"N/A"})]})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Amount:"}),e.jsx("span",{className:"font-semibold",children:q.formatAmount(t)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Start:"}),e.jsx("div",{className:"font-medium",children:new Date(t.startDate).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"End:"}),e.jsx("div",{className:"font-medium",children:new Date(t.endDate).toLocaleDateString()})]})]}),e.jsxs("div",{className:"pt-2 border-t",children:[de&&e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>Be(t),className:"w-full",disabled:!oe,children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"View Details"]}),!de&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"No actions available"})]})]})})},t._id))}),e.jsx("div",{className:"hidden sm:block rounded-lg border border-border bg-card overflow-x-auto",children:e.jsxs(B,{children:[e.jsx(G,{children:e.jsxs(W,{className:"bg-muted/50",children:[e.jsx(K,{className:"font-semibold w-[70px]",children:"S.No"}),e.jsx(K,{className:"font-semibold w-[250px] min-w-[200px]",children:"Client"}),e.jsx(K,{className:"font-semibold w-[200px] min-w-[150px]",children:"Plan"}),e.jsx(K,{className:"font-semibold w-[120px] min-w-[100px]",children:"Amount"}),e.jsx(K,{className:"font-semibold w-[130px] min-w-[110px]",children:"Start Date"}),e.jsx(K,{className:"font-semibold w-[130px] min-w-[110px]",children:"End Date"}),e.jsx(K,{className:"font-semibold w-[120px] min-w-[100px]",children:"Status"}),e.jsx(K,{className:"font-semibold text-center w-[120px] min-w-[100px]",children:"Actions"})]})}),e.jsx(Q,{children:0===Ue.length?e.jsx(W,{children:e.jsx(J,{colSpan:8,className:"text-center py-8 text-muted-foreground",children:"No subscriptions found"})}):Ue.map((t,s)=>e.jsxs(W,{className:"hover:bg-muted/30 transition-colors",children:[e.jsx(J,{className:"w-[70px] text-center",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx("span",{className:"text-sm font-semibold text-primary",children:10*(De-1)+s+1})})})}),e.jsx(J,{className:"w-[250px] min-w-[200px]",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium truncate",children:t.user.name}),e.jsx("div",{className:"text-sm text-muted-foreground truncate",children:t.user.email})]})}),e.jsx(J,{className:"w-[200px] min-w-[150px]",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium truncate",children:t.plan?.name||"N/A"}),e.jsx("div",{className:"text-sm text-muted-foreground capitalize truncate",children:t.plan?.billingPeriod||"N/A"})]})}),e.jsx(J,{className:"w-[120px] min-w-[100px]",children:e.jsx("span",{className:"font-semibold whitespace-nowrap",children:q.formatAmount(t)})}),e.jsx(J,{className:"w-[130px] min-w-[110px]",children:e.jsx("span",{className:"whitespace-nowrap",children:new Date(t.startDate).toLocaleDateString()})}),e.jsx(J,{className:"w-[130px] min-w-[110px]",children:e.jsx("span",{className:"whitespace-nowrap",children:new Date(t.endDate).toLocaleDateString()})}),e.jsx(J,{className:"w-[120px] min-w-[100px]",children:e.jsx(N,{variant:"active"===t.status?"default":"expired"===t.status?"destructive":"secondary",className:"whitespace-nowrap",children:q.formatSubscriptionStatus(t.status).label})}),e.jsx(J,{className:"text-center w-[120px] min-w-[100px]",children:de?e.jsxs(r,{variant:"ghost",size:"sm",onClick:()=>Be(t),className:"whitespace-nowrap",disabled:!oe,children:[e.jsx(b,{className:"w-4 h-4"}),e.jsx("span",{className:"ml-2",children:"View"})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"})})]},t._id))})]})}),Ce>1&&e.jsx("div",{className:"mt-6",children:e.jsx(F,{children:e.jsxs(L,{children:[e.jsx(Y,{children:e.jsx(U,{onClick:()=>{De>1&&Re(De-1)},className:1===De?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:Ce},(e,t)=>t+1).map(t=>e.jsx(Y,{children:e.jsx(z,{onClick:()=>(e=>{Re(e)})(t),isActive:De===t,className:"cursor-pointer",children:t})},t)),e.jsx(Y,{children:e.jsx(O,{onClick:()=>{De<Ce&&Re(De+1)},className:De===Ce?"pointer-events-none opacity-50":"cursor-pointer"})})]})})})]})]}),e.jsx(y,{open:Me,onOpenChange:_e,children:e.jsxs(w,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(A,{children:[e.jsx(S,{children:"Subscription Details"}),e.jsxs(D,{children:["Complete information about ",Te?.user.name,"'s subscription"]})]}),Te&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs(l,{children:[e.jsx(c,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5"}),"Client Information"]})}),e.jsx(m,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Name"}),e.jsx("p",{className:"text-base",children:Te.user.name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Email"}),e.jsx("p",{className:"text-base",children:Te.user.email})]}),Te.user.phone&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Phone"}),e.jsx("p",{className:"text-base",children:Te.user.phone})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"User ID"}),e.jsx("p",{className:"text-sm font-mono",children:Te.user._id})]})]})})]}),e.jsxs(l,{children:[e.jsx(c,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5"}),"Plan Information"]})}),e.jsx(m,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Plan Name"}),e.jsx("p",{className:"text-base font-semibold",children:Te.plan?.name||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Description"}),e.jsx("p",{className:"text-base",children:Te.plan?.description||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Plan Price"}),e.jsx("p",{className:"text-base font-semibold",children:Te.plan?.price?q.formatAmount({...Te,amount:Te.plan.price}):"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Billing Period"}),e.jsx("p",{className:"text-base",children:Te.plan?.billingPeriod||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Plan ID"}),e.jsx("p",{className:"text-sm font-mono",children:Te.plan?._id||"N/A"})]})]})})]}),Te.addons&&Te.addons.length>0&&e.jsxs(l,{children:[e.jsx(c,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"Purchased Addons (",Te.addons.length,")"]})}),e.jsxs(m,{className:"space-y-3",children:[e.jsx("div",{className:"grid gap-4",children:Te.addons.map((t,s)=>e.jsxs("div",{className:"flex items-start gap-3 p-4 border border-border rounded-lg bg-muted/30",children:[e.jsx("div",{className:"p-2 rounded-lg bg-background border",children:Oe(t.category)}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h4",{className:"font-semibold text-base text-foreground",children:t.name}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1 overflow-hidden",style:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:t.description}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx(N,{variant:"outline",className:"capitalize text-xs",children:t.category}),e.jsx(N,{variant:"secondary",className:"text-xs",children:t.billingType?.replace("_"," ")||"N/A"})]})]}),e.jsxs("div",{className:"text-right flex-shrink-0",children:[e.jsx("p",{className:"font-semibold text-lg text-foreground",children:t.price?`${"INR"===t.currency?"₹":"$"}${t.price}`:"Free"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"monthly"===t.billingType?"/month":"yearly"===t.billingType?"/year":"per_property"===t.billingType?"/property":"one_time"===t.billingType?"one-time":""})]})]})})]},t._id||s))}),e.jsx("div",{className:"mt-4 p-4 bg-blue-50/50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-900",children:"Total Addons"}),e.jsxs("p",{className:"text-sm text-blue-700",children:[Te.addons.length," addon",1!==Te.addons.length?"s":""," purchased"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-blue-900",children:Te.addons.reduce((e,t)=>e+(t.price||0),0)>0?`${"INR"===Te.currency?"₹":"$"}${Te.addons.reduce((e,t)=>e+(t.price||0),0)}`:"Free"}),e.jsx("p",{className:"text-xs text-blue-700",children:"addons value"})]})]})})]})]}),e.jsxs(l,{children:[e.jsx(c,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-5 h-5"}),"Subscription Details"]})}),e.jsx(m,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Status"}),e.jsx(N,{variant:"active"===Te.status?"default":"expired"===Te.status?"destructive":"secondary",className:"mt-1",children:q.formatSubscriptionStatus(Te.status).label})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Auto Renew"}),e.jsx(N,{variant:Te.autoRenew?"default":"secondary",className:"mt-1",children:Te.autoRenew?"Enabled":"Disabled"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Start Date"}),e.jsx("p",{className:"text-base",children:new Date(Te.startDate).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"End Date"}),e.jsx("p",{className:"text-base",children:new Date(Te.endDate).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Days Remaining"}),e.jsx("p",{className:"text-base",children:"active"===Te.status?`${q.getDaysUntilExpiry(Te)} days`:"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Created At"}),e.jsx("p",{className:"text-base",children:new Date(Te.createdAt).toLocaleDateString()})]})]})})]}),e.jsxs(l,{children:[e.jsx(c,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5"}),"Payment Information"]})}),e.jsx(m,{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Amount Paid"}),e.jsx("p",{className:"text-base font-semibold",children:q.formatAmount(Te)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Currency"}),e.jsx("p",{className:"text-base",children:Te.currency})]}),Te.paymentMethod&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Payment Method"}),e.jsx("p",{className:"text-base capitalize",children:Te.paymentMethod.replace("_"," ")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Subscription ID"}),e.jsx("p",{className:"text-sm font-mono",children:Te._id})]})]})})]}),Te.paymentHistory&&Te.paymentHistory.length>0&&e.jsxs(l,{children:[e.jsx(c,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5"}),"Payment History (",Te.paymentHistory.length,")"]})}),e.jsxs(m,{className:"space-y-3",children:[e.jsx("div",{className:"space-y-4",children:Te.paymentHistory.sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime()).map((t,s)=>e.jsxs("div",{className:"flex items-start gap-3 p-4 border border-border rounded-lg bg-muted/20",children:[e.jsx("div",{className:"p-2 rounded-lg bg-background border",children:"addon_purchase"===t.type?e.jsx(P,{className:"w-4 h-4 text-orange-600"}):"subscription_purchase"===t.type?e.jsx(C,{className:"w-4 h-4 text-blue-600"}):"renewal"===t.type?e.jsx(E,{className:"w-4 h-4 text-green-600"}):e.jsx(T,{className:"w-4 h-4 text-purple-600"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h4",{className:"font-semibold text-base text-foreground",children:"addon_purchase"===t.type?`Addon Purchase (${t.addons?.length||0} addon${1!==(t.addons?.length||0)?"s":""})`:"subscription_purchase"===t.type?"Subscription Purchase":"renewal"===t.type?"Subscription Renewal":"Subscription Upgrade"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:new Date(t.date).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}),"addon_purchase"===t.type&&t.addons&&t.addons.length>0&&e.jsxs("div",{className:"mt-2 p-2 bg-orange-50 border border-orange-200 rounded-md",children:[e.jsx("p",{className:"text-xs font-medium text-orange-800 mb-1",children:"Purchased Addons:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:t.addons.map((t,s)=>{const a=Te.addons?.find(e=>e._id===t||e._id===t.toString());return e.jsx(N,{variant:"outline",className:"text-xs text-orange-700",children:a?.name||`Addon ${s+1}`},s)})})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx(N,{variant:"addon_purchase"===t.type?"default":"secondary",className:"capitalize text-xs",children:t.type.replace("_"," ")}),t.transactionId&&e.jsxs("p",{className:"text-xs text-muted-foreground font-mono",children:["ID: ",t.transactionId]})]})]}),e.jsxs("div",{className:"text-right flex-shrink-0",children:[e.jsxs("p",{className:"font-semibold text-lg text-foreground",children:["INR"===Te.currency?"₹":"$",t.amount]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.paymentMethod?.replace("_"," ")||"razorpay"})]})]})})]},t._id||s))}),e.jsx("div",{className:"mt-4 p-4 bg-green-50/50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-green-900",children:"Total Payments"}),e.jsxs("p",{className:"text-sm text-green-700",children:[Te.paymentHistory.length," transaction",1!==Te.paymentHistory.length?"s":""]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-green-900",children:["INR"===Te.currency?"₹":"$",Te.paymentHistory.reduce((e,t)=>e+(t.amount||0),0)]}),e.jsx("p",{className:"text-xs text-green-700",children:"total paid"})]})]})})]})]}),e.jsxs(l,{children:[e.jsx(c,{children:e.jsx(d,{children:"Quick Actions"})}),e.jsx(m,{children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:["active"===Te.status&&me&&e.jsxs(r,{variant:"destructive",size:"sm",onClick:()=>{(async e=>{me?"active"===e.status?(Fe(e),ke(!0)):Le({title:"Cannot Cancel",description:"Only active subscriptions can be cancelled.",variant:"destructive"}):Le({title:"Permission Denied",description:"You don't have permission to cancel subscriptions.",variant:"destructive"})})(Te),_e(!1)},children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Cancel Subscription"]}),e.jsx(r,{variant:"outline",size:"sm",onClick:()=>_e(!1),children:"Close"})]})})]})]})]})}),e.jsx(y,{open:Ie,onOpenChange:ke,children:e.jsxs(w,{className:"max-w-md",children:[e.jsxs(A,{children:[e.jsx(S,{children:"Cancel Subscription"}),e.jsxs(D,{children:["Please provide a reason for cancelling ",He?.user.name,"'s subscription. An email will be sent to the customer with this information."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Cancellation Reason *"}),e.jsx(_,{placeholder:"e.g., Customer requested cancellation due to budget constraints...",value:Ve,onChange:e=>$e(e.target.value),rows:5,className:"w-full"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"This reason will be included in the email sent to the customer."})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(r,{variant:"outline",onClick:()=>{ke(!1),$e(""),Fe(null)},children:"Cancel"}),e.jsxs(r,{variant:"destructive",onClick:async()=>{if(He&&Ve.trim())try{await q.cancelSubscription(He._id,Ve),Le({title:"Subscription Cancelled",description:`${He.user.name}'s subscription has been cancelled. Email notification sent.`}),ke(!1),$e(""),Fe(null),qe()}catch(e){Le({title:"Error",description:"Failed to cancel subscription. Please try again.",variant:"destructive"})}else Le({title:"Reason Required",description:"Please provide a reason for cancellation.",variant:"destructive"})},disabled:!Ve.trim(),children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Confirm Cancellation"]})]})]})]})})]})};export{ae as default};
