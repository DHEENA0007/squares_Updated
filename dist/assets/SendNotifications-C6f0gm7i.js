import{j as e}from"./ui-BNZSgpjP.js";import{r as s}from"./router-D8v2YSKU.js";import{u as a,aP as t,af as i,ag as l,ah as n,ai as c,a as r,b as d,c as o,e as m,bA as h,M as x,I as u,T as j,q as f,r as p,s as g,v as N,w as v,B as b,U as y,a4 as w,bB as S,f as k,E as C,a5 as D,a6 as A,a7 as E,am as P,ad as T,_,h as M,C as F}from"./index-CM8T-gRV.js";import{C as R}from"./checkbox-CHt0TJj6.js";import{T as $,a as L,b as I,c as O,d as H,e as q}from"./table-eRu5kCA2.js";import{r as z}from"./roleService-DU1IYmp_.js";import{S as B}from"./send-B4FnCHo9.js";import{S as U}from"./square-pen-DQSYWK6j.js";import{R as V}from"./rotate-ccw-tuXYuXYj.js";import{f as J}from"./format-BX-lkzxV.js";import"./vendor-BxThA0WO.js";const G=()=>{const{isSuperAdmin:G}=a(),[Q,W]=s.useState("compose"),[Y,K]=s.useState("all_users"),[X,Z]=s.useState(""),[ee,se]=s.useState(""),[ae,te]=s.useState(""),[ie,le]=s.useState(""),[ne,ce]=s.useState(!1),[re,de]=s.useState(["push"]),[oe,me]=s.useState(!1),[he,xe]=s.useState(null),[ue,je]=s.useState([]),[fe,pe]=s.useState({all_users:0,customers:0,vendors:0,active_users:0,premium_users:0}),[ge,Ne]=s.useState([]),[ve,be]=s.useState(!1);s.useEffect(()=>{(async()=>{try{const e=await t("/api/admin/notifications/audience-counts");if(e.ok){const s=await e.json();s.success&&pe(s.counts)}}catch(e){}})()},[]),s.useEffect(()=>{(async()=>{try{const e=await z.getRoles({limit:100,isActive:!0});e.success&&je(e.data.roles.filter(e=>"superadmin"!==e.name.toLowerCase()))}catch(e){}})()},[]),s.useEffect(()=>{"history"===Q&&ye()},[Q]);const ye=async()=>{be(!0);try{const e=await t("/api/admin/notifications/history");if(e.ok){const s=await e.json();s.success&&Ne(s.notifications)}}catch(e){}finally{be(!1)}},we=[{value:"all_users",label:"All Users",count:fe.all_users},...ue.map(e=>({value:e.name,label:e.name.charAt(0).toUpperCase()+e.name.slice(1),count:e.userCount||0}))],Se=[{id:"push",label:"Push Notifications",icon:h,description:"Mobile and web push notifications"},{id:"email",label:"Email",icon:x,description:"Email notifications"}],ke=()=>we.find(e=>e.value===Y)||we[0],Ce=s=>{switch(s){case"sent":return e.jsxs(b,{className:"bg-green-500 hover:bg-green-600",children:[e.jsx(F,{className:"w-3 h-3 mr-1"})," Sent"]});case"sending":return e.jsxs(b,{className:"bg-blue-500 hover:bg-blue-600",children:[e.jsx(V,{className:"w-3 h-3 mr-1 animate-spin"})," Sending"]});case"scheduled":return e.jsxs(b,{className:"bg-yellow-500 hover:bg-yellow-600",children:[e.jsx(M,{className:"w-3 h-3 mr-1"})," Scheduled"]});case"draft":return e.jsxs(b,{variant:"secondary",children:[e.jsx(U,{className:"w-3 h-3 mr-1"})," Draft"]});case"failed":return e.jsxs(b,{variant:"destructive",children:[e.jsx(_,{className:"w-3 h-3 mr-1"})," Failed"]});default:return e.jsx(b,{variant:"secondary",children:s})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Send Notifications"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage and track marketing campaigns"})]})}),e.jsxs(i,{defaultValue:"compose",value:Q,onValueChange:W,className:"space-y-6",children:[e.jsxs(l,{children:[e.jsx(n,{value:"compose",children:"Compose Notification"}),e.jsx(n,{value:"history",children:"Notification History"})]}),e.jsx(c,{value:"compose",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(r,{children:[e.jsx(d,{children:e.jsx(o,{children:"Quick Templates"})}),e.jsx(m,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[{_id:"1",name:"New Properties Alert",subject:"New Properties in Your Area!",content:"Discover amazing new properties that match your preferences. Check them out now!",type:"promotional",channels:["push","email"]},{_id:"2",name:"Price Drop Alert",subject:"Price Drop Alert - Save Big!",content:"Great news! Properties you're watching have reduced their prices. Don't miss out!",type:"alert",channels:["push","email"]},{_id:"3",name:"System Maintenance",subject:"Scheduled Maintenance Notice",content:"We'll be performing system maintenance on [DATE]. The platform will be unavailable for 2 hours.",type:"informational",channels:["email","push"]}].map(s=>e.jsxs("div",{className:"p-3 border rounded-lg cursor-pointer hover:bg-accent transition-colors",onClick:()=>(e=>{Z(e.subject),se(e.content);const s=e.channels.filter(e=>"sms"!==e);de(s.length>0?s:["push"]),xe(null)})(s),children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:s.subject}),e.jsx("div",{className:"flex gap-1 mt-2",children:s.channels.filter(e=>"sms"!==e).map(s=>{const a=Se.find(e=>e.id===s),t=a?.icon||h;return e.jsx(t,{className:"w-3 h-3 text-muted-foreground"},s)})})]},s._id))})})]}),e.jsxs(r,{children:[e.jsx(d,{children:e.jsx(o,{children:"Notification Content"})}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Subject/Title *"}),e.jsx(u,{placeholder:"Enter notification subject...",value:X,onChange:e=>Z(e.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Message Content *"}),e.jsx(j,{placeholder:"Enter your notification message...",value:ee,onChange:e=>se(e.target.value),rows:6})]})]})]}),e.jsxs(r,{children:[e.jsx(d,{children:e.jsx(o,{children:"Delivery Channels *"})}),e.jsx(m,{children:e.jsx("div",{className:"space-y-3",children:Se.map(s=>{const a=s.icon;return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(R,{id:s.id,checked:re.includes(s.id),onCheckedChange:e=>((e,s)=>{de(s?[...re,e]:re.filter(s=>s!==e))})(s.id,e)}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(a,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("label",{htmlFor:s.id,className:"text-sm font-medium cursor-pointer",children:s.label})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.description})]},s.id)})})})]}),e.jsxs(r,{children:[e.jsx(d,{children:e.jsx(o,{children:"Scheduling"})}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"schedule",checked:ne,onCheckedChange:e=>ce(e)}),e.jsx("label",{htmlFor:"schedule",className:"text-sm font-medium cursor-pointer",children:"Schedule for later"})]}),ne&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Date"}),e.jsx(u,{type:"date",value:ae,onChange:e=>te(e.target.value),min:(new Date).toISOString().split("T")[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Time"}),e.jsx(u,{type:"time",value:ie,onChange:e=>le(e.target.value)})]})]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(r,{children:[e.jsx(d,{children:e.jsx(o,{children:"Target Audience"})}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs(f,{value:Y,onValueChange:K,children:[e.jsx(p,{children:e.jsx(g,{})}),e.jsx(N,{children:we.map(s=>e.jsx(v,{value:s.value,children:e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("span",{children:s.label}),s.count>=0&&e.jsx(b,{variant:"secondary",className:"ml-2",children:s.count.toLocaleString()})]})},s.value))})]}),e.jsxs("div",{className:"p-3 bg-blue-50 dark:bg-blue-950/50 rounded-lg border border-blue-100 dark:border-blue-900",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(y,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"font-medium text-sm text-foreground",children:"Estimated Reach"})]}),e.jsxs("div",{className:"text-lg font-bold text-blue-600 dark:text-blue-400",children:[ke().count.toLocaleString()," users"]})]})]})]}),e.jsxs(r,{children:[e.jsx(d,{children:e.jsx(o,{children:"Preview"})}),e.jsx(m,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs(w,{children:[e.jsx(S,{asChild:!0,children:e.jsxs(k,{variant:"outline",className:"w-full",children:[e.jsx(C,{className:"w-4 h-4 mr-2"}),"Preview Notification"]})}),e.jsxs(D,{children:[e.jsx(A,{children:e.jsx(E,{children:"Notification Preview"})}),e.jsxs("div",{className:"space-y-4",children:[re.includes("push")&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm mb-2",children:"Push Notification"}),e.jsxs("div",{className:"p-3 border rounded-lg bg-gray-50 dark:bg-gray-900 max-w-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(h,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"font-medium text-sm text-foreground",children:"BuildHomeMartSquares"})]}),e.jsx("div",{className:"font-medium text-sm mb-1 text-foreground",children:X||"Subject"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:ee||"Message content will appear here..."})]})]}),re.includes("email")&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-sm mb-2",children:"Email"}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"border-b pb-2 mb-3",children:[e.jsx("div",{className:"font-medium",children:X||"Subject"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"from: noreply@ninetyniineacres.com"})]}),e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:ee||"Message content will appear here..."})]})]})]})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Channels:"}),e.jsx("span",{children:re.length})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Recipients:"}),e.jsx("span",{children:ke().count.toLocaleString()})]}),ne&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Scheduled:"}),e.jsxs("span",{children:[ae," ",ie]})]})]})]})})]}),e.jsx(r,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(k,{onClick:async()=>{if(X.trim()&&ee.trim()&&0!==re.length){me(!0);try{const e={subject:X,message:ee,targetAudience:Y,channels:re,isScheduled:ne,scheduledDate:ne?`${ae}T${ie}`:null,notificationId:he},s=await t("/api/admin/notifications/send",{method:"POST",body:JSON.stringify(e)}),a=await s.json();if(s.ok&&a.success){let e="Notification processed successfully!";a.detailedStatus&&(e+=` (Email: ${a.detailedStatus.email?.sent||0} sent, Push: ${a.detailedStatus.push?.sent||0} sent)`),alert(e),Z(""),se(""),de(["push"]),ce(!1),te(""),le(""),xe(null),"history"===Q&&ye()}else alert(a.message||"Failed to send notification")}catch(e){alert(`Failed to send notification: ${e?.message||"Network error"}`)}finally{me(!1)}}else alert("Please fill in all required fields and select at least one channel")},disabled:oe||!X.trim()||!ee.trim()||0===re.length,className:"w-full",children:oe?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Sending..."]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4"}),ne?"Schedule Notification":"Send Now"]})}),e.jsx(k,{onClick:async()=>{if(X.trim()){me(!0);try{const e={subject:X,message:ee,targetAudience:Y,channels:re,isScheduled:ne,scheduledDate:ne?`${ae}T${ie}`:null,saveAsDraft:!0,notificationId:he},s=await t("/api/admin/notifications/send",{method:"POST",body:JSON.stringify(e)}),a=await s.json();s.ok&&a.success?(alert("Draft saved successfully"),a.notification&&xe(a.notification._id)):alert(a.message||"Failed to save draft")}catch(e){alert("Failed to save draft")}finally{me(!1)}}else alert("Please enter a subject to save as draft")},disabled:oe||!X.trim(),variant:"outline",className:"w-full",children:"Save as Draft"})]})})})]})]})}),e.jsx(c,{value:"history",children:e.jsxs(r,{children:[e.jsx(d,{children:e.jsx(o,{children:"Notification History"})}),e.jsx(m,{children:ve?e.jsx("div",{className:"text-center py-8",children:"Loading history..."}):0===ge.length?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No notifications sent yet."}):e.jsxs($,{children:[e.jsx(L,{children:e.jsxs(I,{children:[e.jsx(O,{children:"Date"}),e.jsx(O,{children:"Subject"}),e.jsx(O,{children:"Audience"}),e.jsx(O,{children:"Channels"}),e.jsx(O,{children:"Recipients"}),e.jsx(O,{children:"Delivery"}),e.jsx(O,{children:"Status"}),e.jsx(O,{className:"text-right",children:"Actions"})]})}),e.jsx(H,{children:ge.map(s=>e.jsxs(I,{children:[e.jsx(q,{className:"font-medium text-xs text-muted-foreground",children:J(new Date(s.createdAt),"MMM d, yyyy HH:mm")}),e.jsxs(q,{children:[e.jsx("div",{className:"font-medium",children:s.subject}),e.jsx("div",{className:"text-xs text-muted-foreground line-clamp-1",children:s.message})]}),e.jsx(q,{children:e.jsx(b,{variant:"outline",className:"capitalize",children:s.targetAudience.replace("_"," ")})}),e.jsx(q,{children:e.jsxs("div",{className:"flex gap-1",children:[s.channels.includes("push")&&e.jsx(h,{className:"w-4 h-4 text-blue-500"}),s.channels.includes("email")&&e.jsx(x,{className:"w-4 h-4 text-purple-500"}),s.channels.includes("sms")&&e.jsx(P,{className:"w-4 h-4 text-green-500"})]})}),e.jsx(q,{children:s.statistics?.totalRecipients||0}),e.jsx(q,{children:"sent"===s.status&&s.statistics?e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium",children:[s.statistics.delivered||0,"/",s.statistics.totalRecipients||0]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"delivered"})]})}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"N/A"})}),e.jsx(q,{children:Ce(s.status)}),e.jsxs(q,{className:"text-right",children:["draft"===s.status&&e.jsx(k,{size:"sm",variant:"ghost",onClick:()=>(e=>{if(Z(e.subject),se(e.message),K(e.targetAudience),de(e.channels),xe(e._id),e.isScheduled&&e.scheduledDate){ce(!0);const s=new Date(e.scheduledDate);te(s.toISOString().split("T")[0]),le(s.toTimeString().slice(0,5))}else ce(!1),te(""),le("");W("compose")})(s),title:"Edit Draft",children:e.jsx(U,{className:"w-4 h-4"})}),G&&e.jsx(k,{size:"sm",variant:"ghost",className:"text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>(async e=>{if(confirm("Are you sure you want to delete this notification record?"))try{const s=await t(`/api/admin/notifications/${e}`,{method:"DELETE"});if(s.ok){const e=await s.json();e.success?(alert("Notification deleted successfully"),ye()):alert(e.message||"Failed to delete notification")}}catch(s){alert("Failed to delete notification")}})(s._id),title:"Delete Notification",children:e.jsx(T,{className:"w-4 h-4"})})]})]},s._id))})]})})]})})]})]})};export{G as default};
