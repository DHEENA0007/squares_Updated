import{t as e}from"./index-l5vY_naC.js";import"./ui-s1SEoZIF.js";import"./router-D8v2YSKU.js";import"./vendor-BxThA0WO.js";const a=new class{async makeRequest(e,a={}){const t=`https://app.buildhomemartsquares.com/api${e}`,r={headers:{"Content-Type":"application/json",...a.headers},...a},s=localStorage.getItem("token");s&&(r.headers={...r.headers,Authorization:`Bearer ${s}`});try{const e=await fetch(t,r);if(!e.ok){const a=await e.json().catch(()=>({success:!1,message:`HTTP ${e.status}: ${e.statusText}`}));throw new Error(a.message||"An error occurred")}return await e.json()}catch(n){throw n}}loadRazorpayScript(){return new Promise((e,a)=>{if(window.Razorpay)return void e();const t=document.createElement("script");t.src="https://checkout.razorpay.com/v1/checkout.js",t.onload=()=>e(),t.onerror=()=>a(new Error("Failed to load Razorpay script")),document.head.appendChild(t)})}async createPaymentOrder(a,t="monthly"){try{const e=await this.makeRequest("/payments/create-order",{method:"POST",body:JSON.stringify({planId:a,billingCycle:t})});if(!e.success)throw new Error("Failed to create payment order");return e.data}catch(r){const a=r instanceof Error?r.message:"Failed to create payment order";throw e({title:"Payment Error",description:a,variant:"destructive"}),r}}async verifyPayment(a){try{const e=await this.makeRequest("/payments/verify-payment",{method:"POST",body:JSON.stringify(a)});if(!e.success)throw new Error(e.message||"Payment verification failed");return e.data}catch(t){const a=t instanceof Error?t.message:"Payment verification failed";throw e({title:"Payment Verification Failed",description:a,variant:"destructive"}),t}}async initiatePayment(a){try{await this.loadRazorpayScript();const t=await this.createPaymentOrder(a.planId,a.billingCycle),r={key:t.keyId,amount:t.amount,currency:t.currency,name:"BuildHomeMartSquares",description:`Subscription to ${t.planName}`,order_id:t.orderId,prefill:{email:t.userEmail},theme:{color:"#2563eb"},handler:async t=>{try{const r=await this.verifyPayment({razorpay_order_id:t.razorpay_order_id,razorpay_payment_id:t.razorpay_payment_id,razorpay_signature:t.razorpay_signature,planId:a.planId,billingCycle:a.billingCycle||"monthly"});e({title:"Payment Successful!",description:"Your subscription has been activated successfully."}),a.onSuccess&&a.onSuccess(r)}catch(r){a.onFailure&&a.onFailure(r)}},modal:{ondismiss:()=>{e({title:"Payment Cancelled",description:"Payment was cancelled by user.",variant:"destructive"}),a.onFailure&&a.onFailure(new Error("Payment cancelled"))}}};new window.Razorpay(r).open()}catch(t){const r=t instanceof Error?t.message:"Failed to initiate payment";e({title:"Payment Failed",description:r,variant:"destructive"}),a.onFailure&&a.onFailure(t)}}async processSubscriptionPayment(a){try{const t=await this.makeRequest("/payments/create-subscription-order",{method:"POST",body:JSON.stringify(a)});if(!t.success)throw new Error("Failed to create payment order");const r=t.data;return await this.loadRazorpayScript(),new Promise((t,s)=>{const n={key:r.keyId,amount:r.amount,currency:r.currency,name:"BuildHomeMartSquares",description:`Subscription to ${r.planName}${a.addons.length>0?` with ${a.addons.length} addon(s)`:""}`,order_id:r.orderId,prefill:{email:r.userEmail},theme:{color:"#2563eb"},handler:async e=>{try{const r=await this.verifySubscriptionPayment({razorpay_order_id:e.razorpay_order_id,razorpay_payment_id:e.razorpay_payment_id,razorpay_signature:e.razorpay_signature,planId:a.planId,addons:a.addons,billingCycle:a.billingCycle,totalAmount:a.totalAmount});t({success:!0,data:r})}catch(r){s({success:!1,message:r instanceof Error?r.message:"Payment verification failed"})}},modal:{ondismiss:()=>{s({success:!1,message:"Payment was cancelled by user"})}}};try{const e=new window.Razorpay(n);e.on("payment.failed",function(e){s({success:!1,message:e.error.description||"Payment failed",error:e.error})}),e.open()}catch(o){const a=o instanceof Error?o.message:"Unknown error";e({title:"Payment Gateway Error",description:"Unable to load payment gateway. Please check:\n1. Razorpay account is in Test Mode\n2. Checkout is enabled in Settings\n3. Try refreshing the page",variant:"destructive"}),s({success:!1,message:`Checkout failed: ${a}`,error:o})}})}catch(t){return{success:!1,message:t instanceof Error?t.message:"Failed to process subscription payment"}}}async verifySubscriptionPayment(e){try{const a=await this.makeRequest("/payments/verify-subscription-payment",{method:"POST",body:JSON.stringify(e)});if(!a.success)throw new Error(a.message||"Subscription payment verification failed");return a.data}catch(a){const e=a instanceof Error?a.message:"Subscription payment verification failed";throw new Error(e)}}async processAddonPayment(a){try{const r=await this.makeRequest("/payments/create-addon-order",{method:"POST",body:JSON.stringify(a)});if(!r.success)throw new Error("Failed to create addon payment order");const s=r.data;if(s.isMockPayment||"mock_key_for_development"===s.keyId)try{const t=await this.verifyAddonPayment({razorpay_order_id:s.orderId,razorpay_payment_id:`mock_payment_${Date.now()}`,razorpay_signature:"mock_signature",addons:a.addons,totalAmount:a.totalAmount});return e({title:"Payment Successful!",description:"Addons have been added to your subscription successfully."}),{success:!0,data:t}}catch(t){return{success:!1,message:t instanceof Error?t.message:"Mock addon payment verification failed"}}return await this.loadRazorpayScript(),new Promise((r,n)=>{const o={key:s.keyId,amount:s.amount,currency:s.currency,name:"BuildHomeMartSquares",description:`Addon purchase - ${a.addons.length} addon(s)`,order_id:s.orderId,prefill:{email:s.userEmail},theme:{color:"#2563eb"},handler:async s=>{try{const t=await this.verifyAddonPayment({razorpay_order_id:s.razorpay_order_id,razorpay_payment_id:s.razorpay_payment_id,razorpay_signature:s.razorpay_signature,addons:a.addons,totalAmount:a.totalAmount});e({title:"Payment Successful!",description:"Addons have been added to your subscription successfully."}),r({success:!0,data:t})}catch(t){n({success:!1,message:t instanceof Error?t.message:"Addon payment verification failed"})}},modal:{ondismiss:()=>{n({success:!1,message:"Payment was cancelled by user"})}}};new window.Razorpay(o).open()})}catch(t){return{success:!1,message:t instanceof Error?t.message:"Failed to process addon payment"}}}async verifyAddonPayment(e){try{const a=await this.makeRequest("/payments/verify-addon-payment",{method:"POST",body:JSON.stringify(e)});if(!a.success)throw new Error(a.message||"Addon payment verification failed");return a.data}catch(a){const e=a instanceof Error?a.message:"Addon payment verification failed";throw new Error(e)}}async getPaymentStatus(e){try{return(await this.makeRequest(`/payments/status/${e}`)).data}catch(a){throw a}}async markPaymentAsFailed(e,a,t){try{return(await this.makeRequest("/payments/mark-failed",{method:"POST",body:JSON.stringify({orderId:e,paymentId:a,reason:t})})).data}catch(r){throw r}}async checkPaymentStatus(e){try{const a=await this.getPaymentStatus(e);return"pending"===a.status&&a.isExpired?{status:"cancelled",isExpired:!0,message:"Payment timeout - exceeded Razorpay limit"}:{status:a.status,isExpired:a.isExpired||!1,message:a.failureReason}}catch(a){throw a}}};export{a as default,a as paymentService};
