import{j as e}from"./ui-BNZSgpjP.js";import{d as t,r as a}from"./router-D8v2YSKU.js";import{z as n,t as s,f as i,A as r,a as c,b as l,c as o,e as u,h as d,_ as m,C as h}from"./index-R8qjqeWQ.js";import{E as p}from"./exportUtils-BpsREFeE.js";import{D as x}from"./download-EmIFb1CA.js";import"./vendor-BxThA0WO.js";import"./xlsx-BjkOj9O8.js";const v=()=>{const v=t(),[g,w]=a.useState([]),[f,D]=a.useState(!0),[N,j]=a.useState({totalRevenue:0,thisMonthRevenue:0,todayRevenue:0,activeSubscriptions:0,expiredSubscriptions:0,averageRevenue:0});a.useEffect(()=>{b()},[]);const b=async()=>{try{const e=n.getToken(),t=await fetch("https://app.buildhomemartsquares.com/api/subscriptions/all",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch revenue data");const a=await t.json();if(a.success){const e=a.data.subscriptions;w(e);const t=new Date,n=new Date;n.setHours(0,0,0,0);const s=new Date(t.getFullYear(),t.getMonth(),1),i=e.filter(e=>["active","expired"].includes(e.status)&&e.lastPaymentDate).reduce((e,t)=>e+t.amount,0),r=e.filter(e=>["active","expired"].includes(e.status)&&e.lastPaymentDate&&new Date(e.lastPaymentDate)>=s).reduce((e,t)=>e+t.amount,0),c=e.filter(e=>["active","expired"].includes(e.status)&&e.lastPaymentDate&&new Date(e.lastPaymentDate)>=n).reduce((e,t)=>e+t.amount,0),l=e.filter(e=>"active"===e.status&&(!e.endDate||new Date(e.endDate)>t)).length,o=e.filter(e=>"expired"===e.status||!!("active"===e.status&&e.endDate&&new Date(e.endDate)<=t)).length,u=e.filter(e=>["active","expired"].includes(e.status)&&e.lastPaymentDate).length;j({totalRevenue:i,thisMonthRevenue:r,todayRevenue:c,activeSubscriptions:l,expiredSubscriptions:o,averageRevenue:u>0?i/u:0})}}catch(e){s({title:"Error",description:"Failed to load revenue data",variant:"destructive"})}finally{D(!1)}},S=e=>`₹${e.toLocaleString("en-IN")}`,R=t=>{switch(t){case"active":return e.jsx(h,{className:"w-4 h-4 text-green-600"});case"expired":return e.jsx(m,{className:"w-4 h-4 text-red-600"});case"cancelled":return e.jsx(m,{className:"w-4 h-4 text-gray-600"});default:return e.jsx(d,{className:"w-4 h-4 text-yellow-600"})}};return f?e.jsx("div",{className:"flex justify-center items-center py-12",children:"Loading..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(i,{variant:"ghost",onClick:()=>v("/admin/dashboard"),children:[e.jsx(r,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Revenue Details"}),e.jsx("p",{className:"text-muted-foreground",children:"Complete revenue breakdown and subscription history"})]}),e.jsxs(i,{variant:"outline",onClick:()=>{try{if(0===g.length)return void s({title:"No Data",description:"No revenue data available to export",variant:"destructive"});const e=(new Date).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),t=e=>`₹${e.toLocaleString("en-IN")}`,a=e=>e?new Date(e).toLocaleDateString("en-IN",{year:"numeric",month:"short",day:"numeric"}):"N/A",n=e=>e?new Date(e).toLocaleString("en-IN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",i=g.filter(e=>"active"===e.status).length,r=g.filter(e=>"expired"===e.status).length,c=g.filter(e=>"cancelled"===e.status).length,l=g.filter(e=>"pending"===e.status).length,o=g.filter(e=>"active"===e.status).reduce((e,t)=>e+t.amount,0),u=g.filter(e=>"expired"===e.status).reduce((e,t)=>e+t.amount,0),d=o+u,m=g.length>0?N.totalRevenue/g.filter(e=>["active","expired"].includes(e.status)).length:0,h=g.filter(e=>e.amount>m),x=(g.filter(e=>e.amount<=m&&e.amount>0),[{Metric:"Total Revenue (All Time)",Value:t(N.totalRevenue),Details:"Cumulative revenue from all paid subscriptions"},{Metric:"This Month Revenue",Value:t(N.thisMonthRevenue),Details:"Revenue collected this calendar month"},{Metric:"Today Revenue",Value:t(N.todayRevenue),Details:"Revenue collected today"},{Metric:"Total Subscriptions",Value:g.length,Details:"All subscriptions in the system"},{Metric:"Active Subscriptions",Value:N.activeSubscriptions,Details:"Currently active subscriptions"},{Metric:"Expired Subscriptions",Value:N.expiredSubscriptions,Details:"Subscriptions that have ended"},{Metric:"Cancelled Subscriptions",Value:c,Details:"User/admin cancelled"},{Metric:"Pending Subscriptions",Value:l,Details:"Awaiting payment confirmation"},{Metric:"Average Revenue per Subscription",Value:t(Math.round(N.averageRevenue)),Details:"Mean revenue per paid subscription"},{Metric:"Median Subscription Value",Value:t(g.length>0?g.map(e=>e.amount).sort((e,t)=>e-t)[Math.floor(g.length/2)]:0),Details:"Middle value of all subscriptions"},{Metric:"High Value Subscriptions",Value:h.length,Details:"Above average subscription value"},{Metric:"Conversion Rate",Value:`${g.length>0?(i/g.length*100).toFixed(1):0}%`,Details:"Active/Total subscriptions"},{Metric:"Churn Rate",Value:`${g.length>0?((c+r)/g.length*100).toFixed(1):0}%`,Details:"Cancelled + Expired / Total"}]),v=[{Status:"Active",Count:i,Revenue:t(o),"Avg. Revenue":t(i>0?Math.round(o/i):0),Percentage:`${g.length>0?(i/g.length*100).toFixed(1):0}%`,"Revenue Share":`${d>0?(o/d*100).toFixed(1):0}%`},{Status:"Expired",Count:r,Revenue:t(u),"Avg. Revenue":t(r>0?Math.round(u/r):0),Percentage:`${g.length>0?(r/g.length*100).toFixed(1):0}%`,"Revenue Share":`${d>0?(u/d*100).toFixed(1):0}%`},{Status:"Cancelled",Count:c,Revenue:"N/A","Avg. Revenue":"N/A",Percentage:`${g.length>0?(c/g.length*100).toFixed(1):0}%`,"Revenue Share":"N/A"},{Status:"Pending",Count:l,Revenue:"N/A","Avg. Revenue":"N/A",Percentage:`${g.length>0?(l/g.length*100).toFixed(1):0}%`,"Revenue Share":"N/A"}],w={};g.forEach(e=>{const t=e.plan?.name||"Unknown";w[t]||(w[t]={count:0,revenue:0,active:0,expired:0,avgAmount:0,planPrice:e.plan?.price||0}),w[t].count+=1,"active"===e.status&&(w[t].active+=1),"expired"===e.status&&(w[t].expired+=1),["active","expired"].includes(e.status)&&(w[t].revenue+=e.amount)});const f=Object.entries(w).sort((e,t)=>t[1].revenue-e[1].revenue).map(([e,a])=>({"Plan Name":e,"Plan Price":t(a.planPrice),"Total Subscribers":a.count,Active:a.active,Expired:a.expired,"Total Revenue":t(a.revenue),"Avg. Revenue/Subscriber":t(a.count>0?Math.round(a.revenue/a.count):0),"Revenue Share":`${N.totalRevenue>0?(a.revenue/N.totalRevenue*100).toFixed(1):0}%`,"Retention Rate":`${a.count>0?(a.active/a.count*100).toFixed(1):0}%`})),D={};g.forEach(e=>{if(e.lastPaymentDate&&["active","expired"].includes(e.status)){const t=new Date(e.lastPaymentDate),a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;D[a]||(D[a]={revenue:0,count:0,newSubs:0}),D[a].revenue+=e.amount,D[a].count+=1}if(e.createdAt){const t=new Date(e.createdAt),a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;D[a]||(D[a]={revenue:0,count:0,newSubs:0}),D[a].newSubs+=1}});const j=Object.entries(D).sort((e,t)=>t[0].localeCompare(e[0])).slice(0,24).map(([e,a])=>({Month:e,Revenue:t(a.revenue),"Payments Received":a.count,"New Subscriptions":a.newSubs,"Avg. Payment Value":t(a.count>0?Math.round(a.revenue/a.count):0)})),b=g.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).map((e,s)=>{const i=new Date(e.startDate),r=new Date(e.endDate),c=Math.ceil((r.getTime()-i.getTime())/864e5),l="active"===e.status&&r.getTime()-Date.now()<6048e5;return{"#":s+1,"Subscription ID":e._id,"Customer Name":`${e.user?.profile?.firstName||""} ${e.user?.profile?.lastName||""}`.trim()||"N/A",Email:e.user?.email||"N/A","User ID":e.user?._id||"N/A",Plan:e.plan?.name||"Unknown","Plan Base Price":t(e.plan?.price||0),"Amount Paid":t(e.amount),"Discount Applied":e.plan?.price&&e.amount<e.plan.price?t(e.plan.price-e.amount):"None",Status:e.status.charAt(0).toUpperCase()+e.status.slice(1),"Start Date":a(e.startDate),"End Date":a(e.endDate),"Duration (Days)":c,"Expiring Soon":l?"Yes":"No","Last Payment Date":a(e.lastPaymentDate),"Created At":n(e.createdAt),"Payment Status":e.lastPaymentDate?"Paid":"Pending"}}),S=g.filter(e=>"active"===e.status).sort((e,t)=>new Date(e.endDate).getTime()-new Date(t.endDate).getTime()).map((e,n)=>{const s=Math.ceil((new Date(e.endDate).getTime()-Date.now())/864e5);return{"#":n+1,Customer:`${e.user?.profile?.firstName||""} ${e.user?.profile?.lastName||""}`.trim()||"N/A",Email:e.user?.email||"N/A",Plan:e.plan?.name||"Unknown",Amount:t(e.amount),"Start Date":a(e.startDate),"End Date":a(e.endDate),"Days Remaining":s,Urgency:s<=7?"Expiring Soon":s<=30?"Renew Soon":"Good"}}),R=g.filter(e=>["expired","cancelled"].includes(e.status)).sort((e,t)=>new Date(t.endDate).getTime()-new Date(e.endDate).getTime()).map((e,n)=>({"#":n+1,Customer:`${e.user?.profile?.firstName||""} ${e.user?.profile?.lastName||""}`.trim()||"N/A",Email:e.user?.email||"N/A",Plan:e.plan?.name||"Unknown","Last Amount":t(e.amount),Status:e.status.charAt(0).toUpperCase()+e.status.slice(1),"End Date":a(e.endDate),"Days Since Churn":Math.ceil((Date.now()-new Date(e.endDate).getTime())/864e5),"Win-Back Priority":e.amount>m?"High":"Medium"})),y={filename:"revenue_comprehensive_report",title:"Comprehensive Revenue Analysis Report",metadata:{"Generated on":e,"Report Type":"Full Revenue & Subscription Analysis","Total Revenue":t(N.totalRevenue),"Active Subscriptions":N.activeSubscriptions.toString(),"Total Subscriptions":g.length.toString(),"Report Generated By":"Admin Dashboard"}},A=[{name:"Executive Summary",data:x,columns:[{wch:35},{wch:25},{wch:45}]},{name:"Status Breakdown",data:v,columns:[{wch:12},{wch:10},{wch:18},{wch:18},{wch:12},{wch:15}]},{name:"Plan Performance",data:f,columns:[{wch:25},{wch:15},{wch:15},{wch:10},{wch:10},{wch:18},{wch:20},{wch:15},{wch:15}]},{name:"Monthly Trends",data:j,columns:[{wch:12},{wch:18},{wch:18},{wch:18},{wch:18}]},{name:"Active Subscriptions",data:S,columns:[{wch:5},{wch:25},{wch:30},{wch:20},{wch:15},{wch:15},{wch:15},{wch:15},{wch:15}]},{name:"Churned Customers",data:R,columns:[{wch:5},{wch:25},{wch:30},{wch:20},{wch:15},{wch:12},{wch:15},{wch:15},{wch:15}]},{name:"All Subscriptions",data:b,columns:[{wch:5},{wch:25},{wch:25},{wch:30},{wch:25},{wch:20},{wch:15},{wch:15},{wch:15},{wch:12},{wch:15},{wch:15},{wch:12},{wch:12},{wch:15},{wch:20},{wch:12}]}];p.generateExcelReport(y,A),s({title:"Export Successful",description:`Comprehensive revenue report with ${A.length} sheets has been downloaded`})}catch(e){s({title:"Export Failed",description:"Failed to export revenue report. Please try again.",variant:"destructive"})}},children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"Export Report"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3 lg:grid-cols-6",children:[e.jsxs(c,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium text-muted-foreground",children:"Total Revenue"})}),e.jsx(u,{children:e.jsx("div",{className:"text-2xl font-bold text-emerald-600",children:S(N.totalRevenue)})})]}),e.jsxs(c,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium text-muted-foreground",children:"This Month"})}),e.jsx(u,{children:e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:S(N.thisMonthRevenue)})})]}),e.jsxs(c,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium text-muted-foreground",children:"Today"})}),e.jsx(u,{children:e.jsx("div",{className:"text-2xl font-bold text-indigo-600",children:S(N.todayRevenue)})})]}),e.jsxs(c,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium text-muted-foreground",children:"Active Subscriptions"})}),e.jsx(u,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:N.activeSubscriptions})})]}),e.jsxs(c,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium text-muted-foreground",children:"Expired"})}),e.jsx(u,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:N.expiredSubscriptions})})]}),e.jsxs(c,{children:[e.jsx(l,{className:"pb-2",children:e.jsxs(o,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:["Average Revenue",e.jsxs("div",{className:"group relative",children:[e.jsx(d,{className:"w-3 h-3 text-muted-foreground cursor-help"}),e.jsx("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-48 p-2 bg-popover text-popover-foreground text-xs rounded shadow-lg border z-50",children:"Total Revenue / Total Paid Subscriptions"})]})]})}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:S(Math.round(N.averageRevenue))}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[S(N.totalRevenue)," / ",g.filter(e=>["active","expired"].includes(e.status)&&e.lastPaymentDate).length," subscriptions"]})]})]})]}),e.jsxs(c,{children:[e.jsx(l,{children:e.jsx(o,{children:"All Subscriptions"})}),e.jsx(u,{children:e.jsx("div",{className:"space-y-3",children:0===g.length?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No subscriptions found"}):g.map(t=>{return e.jsx("div",{className:"border rounded-lg p-4 hover:bg-accent/50 transition",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-6 gap-4 items-center",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsxs("p",{className:"font-medium",children:[t.user?.profile?.firstName," ",t.user?.profile?.lastName]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.user?.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Plan"}),e.jsx("p",{className:"font-medium",children:t.plan?.name||"Unknown"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Amount"}),e.jsx("p",{className:"font-bold text-emerald-600",children:S(t.amount)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Payment Date"}),e.jsx("p",{className:"text-sm",children:t.lastPaymentDate?(a=t.lastPaymentDate,new Date(a).toLocaleDateString("en-IN",{year:"numeric",month:"short",day:"numeric"})):"N/A"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[R(t.status),e.jsx("span",{className:"text-sm capitalize",children:t.status})]})]})},t._id);var a})})})]})]})};export{v as default};
