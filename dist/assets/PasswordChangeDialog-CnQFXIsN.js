import{j as e}from"./ui-BHyUY8Z8.js";import{r as o}from"./router-2SVJvIbS.js";import{J as W,K as L,O as $,Q as K,R as I,L as x,I as p,f as i,S as F,E as y,X as D,l as k,ap as Y,t as f}from"./index-Bd1eLXM_.js";import{A as B,a as H}from"./alert-DQvV8n_v.js";import{u as v}from"./userService-CKE-Zb2D.js";import{K as A}from"./key-B3atZykj.js";import{T as J}from"./triangle-alert-msJWYMkH.js";import{E as b}from"./eye-off-pZLnB8vP.js";const ae=({open:R,onOpenChange:g})=>{const[a,c]=o.useState({currentPassword:"",newPassword:"",confirmPassword:"",otp:""}),[d,j]=o.useState({current:!1,new:!1,confirm:!1}),[m,h]=o.useState(!1),[C,t]=o.useState([]),[l,P]=o.useState("password"),[Q,N]=o.useState(!1),[q,S]=o.useState(null),w=s=>{const r=[];return s.length<8&&r.push("At least 8 characters"),/[a-z]/.test(s)||r.push("One lowercase letter"),/[A-Z]/.test(s)||r.push("One uppercase letter"),/[0-9]/.test(s)||r.push("One number"),/[!@#$%^&*(),.?":{}|<>]/.test(s)||r.push("One special character"),r},z=s=>{const r=w(s),n=Math.max(0,5-r.length);return n===5?{score:n,label:"Very Strong",color:"text-green-600"}:n>=4?{score:n,label:"Strong",color:"text-green-500"}:n>=3?{score:n,label:"Medium",color:"text-yellow-500"}:n>=2?{score:n,label:"Weak",color:"text-orange-500"}:{score:n,label:"Very Weak",color:"text-red-500"}},O=()=>a.currentPassword.length>0&&a.newPassword.length>=8&&a.newPassword===a.confirmPassword&&w(a.newPassword).length===0&&a.currentPassword!==a.newPassword,E=async()=>{if(l==="password"){if(!O())return;try{h(!0),t([]);const s=await v.requestPasswordChangeOTP(a.currentPassword);s.success&&(P("otp"),N(!0),S(s.expiryMinutes||5))}catch(s){console.error("Failed to send OTP:",s),t([s.message||"Failed to send OTP"])}finally{h(!1)}}else if(l==="otp"){if(!a.otp.trim()){t(["Please enter the OTP"]);return}try{h(!0),t([]);const s=await v.changePasswordWithOTP(a.otp,a.newPassword);if(s.success)f({title:"âœ… Password Changed Successfully",description:"Your password has been updated securely."}),c({currentPassword:"",newPassword:"",confirmPassword:"",otp:""}),P("password"),N(!1),g(!1),f({title:"ðŸ“§ Confirmation Sent",description:"Password change confirmation sent to your email."});else throw new Error(s.message||"Failed to change password")}catch(s){const r=s.message||"Failed to change password";r.includes("Current password is incorrect")?t(["Your current password is incorrect. Please try again."]):r.includes("same as current")?t(["New password must be different from your current password."]):r.includes("OTP")?t([r]):t([r]),f({title:"âŒ Password Change Failed",description:r,variant:"destructive"})}finally{h(!1)}}},M=()=>{c({currentPassword:"",newPassword:"",confirmPassword:"",otp:""}),t([]),P("password"),N(!1),g(!1)},V=async()=>{try{h(!0),t([]);const s=await v.requestPasswordChangeOTP(a.currentPassword);s.success&&(S(s.expiryMinutes||5),f({title:"OTP Resent",description:"A new OTP has been sent to your email"}))}catch(s){t([s.message||"Failed to resend OTP"])}finally{h(!1)}},u=z(a.newPassword),T=w(a.newPassword);return e.jsx(W,{open:R,onOpenChange:g,children:e.jsxs(L,{className:"sm:max-w-md",children:[e.jsxs($,{children:[e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5"}),l==="password"?"Change Password":"Verify Email"]}),e.jsx(I,{children:l==="password"?"Enter your current password and choose a new secure password.":"We've sent a verification code to your registered email. Please enter the code below."})]}),e.jsxs("div",{className:"space-y-4",children:[C.length>0&&e.jsxs(B,{variant:"destructive",children:[e.jsx(J,{className:"w-4 h-4"}),e.jsx(H,{children:e.jsx("ul",{className:"list-disc list-inside space-y-1",children:C.map((s,r)=>e.jsx("li",{children:s},r))})})]}),l==="otp"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"otp",children:"Verification Code"}),e.jsx(p,{id:"otp",type:"text",value:a.otp,onChange:s=>c(r=>({...r,otp:s.target.value.replace(/\D/g,"").slice(0,6)})),placeholder:"Enter 6-digit code",className:"text-center text-lg tracking-widest",maxLength:6}),e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Code expires in ",q," minutes"]}),e.jsx(i,{variant:"ghost",size:"sm",onClick:V,disabled:m,children:"Resend Code"})]})]}),e.jsx("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(F,{className:"w-4 h-4 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"text-xs text-yellow-700",children:[e.jsx("p",{className:"font-medium",children:"Security Notice:"}),e.jsx("p",{children:"We've sent a verification code to your registered email address for additional security. Please check your email and enter the code above."})]})]})})]}),l==="password"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"currentPassword",children:"Current Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(p,{id:"currentPassword",type:d.current?"text":"password",value:a.currentPassword,onChange:s=>c(r=>({...r,currentPassword:s.target.value})),placeholder:"Enter your current password",className:"pr-10"}),e.jsx(i,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3",onClick:()=>j(s=>({...s,current:!s.current})),children:d.current?e.jsx(b,{className:"h-4 w-4"}):e.jsx(y,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"newPassword",children:"New Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(p,{id:"newPassword",type:d.new?"text":"password",value:a.newPassword,onChange:s=>c(r=>({...r,newPassword:s.target.value})),placeholder:"Enter your new password",className:"pr-10"}),e.jsx(i,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3",onClick:()=>j(s=>({...s,new:!s.new})),children:d.new?e.jsx(b,{className:"h-4 w-4"}):e.jsx(y,{className:"h-4 w-4"})})]}),a.newPassword&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 bg-muted rounded-full h-2",children:e.jsx("div",{className:`h-full rounded-full transition-all ${u.score>=4?"bg-green-500":u.score>=3?"bg-yellow-500":u.score>=2?"bg-orange-500":"bg-red-500"}`,style:{width:`${u.score/5*100}%`}})}),e.jsx("span",{className:`text-xs font-medium ${u.color}`,children:u.label})]}),T.length>0&&e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsx("p",{className:"font-medium text-muted-foreground",children:"Requirements:"}),T.map((s,r)=>e.jsxs("div",{className:"flex items-center gap-2 text-red-600",children:[e.jsx(D,{className:"w-3 h-3"}),e.jsx("span",{children:s})]},r)),w(a.newPassword).length===0&&e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(k,{className:"w-3 h-3"}),e.jsx("span",{children:"Password meets all requirements"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"confirmPassword",children:"Confirm New Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(p,{id:"confirmPassword",type:d.confirm?"text":"password",value:a.confirmPassword,onChange:s=>c(r=>({...r,confirmPassword:s.target.value})),placeholder:"Confirm your new password",className:"pr-10"}),e.jsx(i,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3",onClick:()=>j(s=>({...s,confirm:!s.confirm})),children:d.confirm?e.jsx(b,{className:"h-4 w-4"}):e.jsx(y,{className:"h-4 w-4"})})]}),a.confirmPassword&&e.jsx("div",{className:"text-xs",children:a.newPassword===a.confirmPassword?e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(k,{className:"w-3 h-3"}),e.jsx("span",{children:"Passwords match"})]}):e.jsxs("div",{className:"flex items-center gap-2 text-red-600",children:[e.jsx(D,{className:"w-3 h-3"}),e.jsx("span",{children:"Passwords don't match"})]})})]}),e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(F,{className:"w-4 h-4 text-blue-600 mt-0.5"}),e.jsxs("div",{className:"text-xs text-blue-700 space-y-1",children:[e.jsx("p",{className:"font-medium",children:"Security Tips:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-0.5",children:[e.jsx("li",{children:"Use a unique password you haven't used elsewhere"}),e.jsx("li",{children:"Consider using a password manager"}),e.jsx("li",{children:"Don't share your password with anyone"})]})]})]})})]})]}),e.jsxs(Y,{className:"gap-2",children:[e.jsx(i,{variant:"outline",onClick:M,disabled:m,children:"Cancel"}),l==="password"&&e.jsx(i,{onClick:E,disabled:!O()||m,className:"min-w-[120px]",children:m?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}),"Sending OTP..."]}):"Send Verification Code"}),l==="otp"&&e.jsx(i,{onClick:E,disabled:!a.otp||a.otp.length!==6||m,className:"min-w-[120px]",children:m?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"}),"Changing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"Change Password"]})})]})]})})};export{ae as P};
